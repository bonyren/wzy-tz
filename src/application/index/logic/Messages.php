<?php
 namespace app\index\logic; use app\index\model\Setting; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; class Messages extends Base { const MESSAGE_APPROVAL_CATEGORY = 1; public static $messageCategoryDefs = array(self::MESSAGE_APPROVAL_CATEGORY => "\345\xae\241\xe6\211\xb9\xe9\x80\x9a\347\x9f\xa5"); public static $messageCategoryHtmlDefs = array(self::MESSAGE_APPROVAL_CATEGORY => "\x3c\163\x70\x61\x6e\40\x63\x6c\141\163\163\x3d\42\142\x61\x64\147\145\x20\142\141\x64\x67\145\x2d\x70\x72\x69\155\x61\162\171\x22\76\xe5\xae\xa1\346\211\xb9\351\x80\x9a\xe7\x9f\xa5\x3c\x2f\163\160\141\x6e\x3e"); protected function __construct() { parent::__construct(); } public function load($adminId, $search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = "\155\x65\163\163\x61\x67\145\137\151\144", $order = "\x64\145\163\143") { goto HnY05; vNRHi: $order = "\x6d\145\x73\163\x61\147\x65\x5f\151\144\x20\x64\x65\163\x63"; goto PBVCD; hI62l: $conditions = ["\141\x64\x6d\x69\156\137\x69\144" => $adminId]; goto cog1a; ZtbuX: $order = "\x6d\x65\163\163\141\x67\x65\137\151\x64\40" . $order; goto jv3iS; SOPGe: RUR2H: goto ZtbuX; HnY05: $limit = ($page - 1) * $rows . "\54" . $rows; goto daz4B; jv3iS: ZraR2: goto hI62l; mcXZ5: $records = Db::table("\155\x65\163\x73\x61\x67\145\163")->where($conditions)->limit($limit)->order($order)->field(["\155\x65\163\x73\141\x67\x65\137\151\x64", "\x61\x64\155\151\x6e\x5f\151\144", "\164\x69\x74\x6c\x65", "\143\x6f\x6e\164\x65\x6e\164", "\143\141\164\x65\x67\x6f\162\171", "\151\x73\137\162\x65\x61\x64", "\x72\x65\141\144\x5f\164\x69\155\x65", "\x65\156\164\x65\162\145\144"])->select(); goto RfBfx; PBVCD: goto ZraR2; goto SOPGe; daz4B: if ($sort == "\155\x65\x73\x73\141\x67\x65\x5f\x69\144") { goto RUR2H; } goto vNRHi; t702w: return ["\x74\x6f\164\x61\x6c" => $totalCount, "\162\157\x77\x73" => $records]; goto MBEQF; cog1a: $totalCount = Db::table("\155\x65\x73\163\x61\147\x65\163")->where($conditions)->count(); goto mcXZ5; blE8N: aAx4J: goto t702w; RfBfx: foreach ($records as &$record) { $record["\x63\150\x65\143\153\145\144"] = true; H17s3: } goto blE8N; MBEQF: } public function add($adminId, $category, $title, $content) { goto jR7sV; pvhn2: $messageId = Db::table("\x6d\x65\x73\x73\x61\147\145\x73")->insertGetId($datas); goto SgTY6; jR7sV: $datas = ["\141\x64\155\151\156\137\x69\x64" => $adminId, "\x74\x69\x74\x6c\145" => $title, "\143\157\x6e\164\x65\156\x74" => $content, "\143\x61\x74\x65\147\x6f\162\171" => $category]; goto pvhn2; SgTY6: return $messageId; goto Tu3i0; Tu3i0: } public function markRead($messageId) { Db::table("\155\145\163\x73\141\x67\x65\x73")->where(["\x6d\145\163\163\x61\x67\145\137\151\x64" => $messageId, "\x69\x73\137\x72\x65\x61\144" => 0])->update(["\151\163\137\162\x65\141\x64" => 1, "\162\145\141\144\137\x74\151\155\145" => date("\131\55\x6d\55\x64\40\110\x3a\151\x3a\x73")]); return true; } public function markAllRead($adminId) { Db::table("\x6d\x65\163\163\x61\x67\x65\x73")->where(["\141\144\155\x69\x6e\137\x69\144" => $adminId, "\x69\x73\137\162\x65\x61\x64" => 0])->update(["\151\163\x5f\162\x65\x61\144" => 1, "\162\145\x61\144\x5f\x74\151\x6d\x65" => Db::raw("\156\157\167\50\x29")]); } public function markSelectedRead($messageIds) { Db::table("\155\x65\x73\x73\141\147\x65\163")->where(["\x6d\x65\x73\x73\x61\147\x65\x5f\151\x64" => ["\x69\156", $messageIds], "\151\x73\x5f\x72\145\141\144" => 0])->update(["\151\163\137\162\x65\141\144" => 1, "\162\145\141\144\137\x74\x69\x6d\x65" => Db::raw("\156\x6f\167\50\51")]); } public function getInfos($messageId) { $infos = Db::table("\x6d\145\x73\163\141\147\x65\x73")->where("\x6d\145\163\163\141\147\145\x5f\x69\x64", $messageId)->field(true)->find(); return $infos; } public function unreadCount($adminId) { $count = Db::table("\155\145\163\163\x61\147\145\163")->where(["\141\x64\x6d\x69\156\x5f\151\x64" => $adminId, "\151\x73\137\x72\145\141\x64" => 0])->count(); return $count; } }
