<?php
 namespace app\index\logic; use app\index\model\Attachments; use app\index\model\Edividends; use app\index\model\EFounders; use app\index\model\FundsEnterprises; use app\index\model\FundsFinanceIncomes; use app\index\model\Enterprises; use app\index\model\FundsFinanceTaxes; use think\Db; use app\index\service\EventLogs; class Enterprise extends Base { const MODULE = "\x45\x6e\x74\x65\x72\x70\x72\x69\x73\x65\x73"; const STEP_TOUCH = 1; const STEP_LEARN = 2; const STEP_DD = 3; const STEP_INVESTING = 4; const STEP_POST_INVESTED = 5; const STEP_EXIT = 6; const STEPS = array(self::STEP_TOUCH => "\346\216\245\xe8\247\xa6", self::STEP_LEARN => "\xe4\xba\206\xe8\247\xa3\xe5\x88\206\346\236\x90", self::STEP_DD => "\xe5\xb0\275\xe8\xb0\x83\xe4\270\255", self::STEP_INVESTING => "\xe6\212\225\xe8\265\204\344\270\255", self::STEP_POST_INVESTED => "\346\212\x95\345\x90\x8e\347\256\xa1\347\220\206", self::STEP_EXIT => "\345\267\xb2\xe9\x80\x80\xe5\207\272"); const STEPS_HTML = array(self::STEP_TOUCH => "\x3c\x73\x70\141\156\40\143\x6c\x61\163\163\x3d\42\142\x61\144\x67\x65\40\x62\141\x64\x67\x65\55\x6c\x69\x67\150\164\42\x3e\xe6\x8e\xa5\xe8\xa7\xa6\x3c\57\163\160\x61\156\76", self::STEP_LEARN => "\74\163\x70\141\x6e\40\x63\154\x61\x73\x73\75\42\x62\141\144\x67\x65\40\142\141\x64\147\145\x2d\163\145\143\157\156\144\x61\x72\x79\42\76\344\272\x86\xe8\xa7\xa3\xe5\x88\x86\xe6\236\220\x3c\57\163\x70\141\x6e\76", self::STEP_DD => "\x3c\x73\160\x61\x6e\40\143\x6c\141\163\x73\x3d\x22\142\141\x64\147\145\x20\142\141\x64\x67\x65\55\x70\162\151\x6d\x61\x72\171\x22\x3e\345\260\275\350\xb0\203\xe4\xb8\255\x3c\57\163\x70\x61\156\76", self::STEP_INVESTING => "\74\x73\160\x61\156\40\143\x6c\x61\x73\163\75\42\x62\x61\144\x67\x65\x20\x62\141\144\147\145\x2d\151\156\146\157\x22\x3e\346\x8a\225\350\xb5\x84\344\xb8\xad\74\57\x73\160\141\x6e\76", self::STEP_POST_INVESTED => "\x3c\163\160\141\156\40\143\154\x61\x73\x73\75\42\x62\x61\144\x67\145\x20\142\x61\144\147\x65\55\163\165\143\143\145\x73\163\x22\x3e\xe6\212\x95\345\x90\216\xe7\xae\xa1\347\x90\206\74\x2f\163\x70\x61\156\76", self::STEP_EXIT => "\x3c\x73\160\x61\156\40\x63\x6c\141\163\163\x3d\x22\142\x61\144\x67\145\40\142\x61\144\x67\x65\55\167\x61\x72\x6e\x69\x6e\x67\x22\x3e\xe5\267\xb2\xe9\200\200\xe5\x87\xba\74\x2f\x73\160\x61\156\x3e"); private $enterprise_model; protected function __construct() { $this->enterprise_model = new Enterprises(); } public function load($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $params = array()) { goto LACx0; PBcvP: if (empty($search["\x6e\141\x6d\145"])) { goto BnqZJ; } goto o0YGm; eqY6t: $where["\x65\x2e\163\x63\x69\x65\156\x74\151\163\x74\137\x69\144"] = $search["\x73\x63\151\145\156\164\x69\x73\164\x5f\151\x64"]; goto l91n3; sqx0k: HHOV2: goto x8I1W; wR1gi: $where = ["\x65\x2e\144\x65\x6c\x65\164\x65\x64" => 0]; goto NBZiV; Hl5Eg: $model->where($where); goto Tfsj9; kk7_F: BnqZJ: goto CGkZG; fW6s9: if (!empty($count)) { goto VuKX2; } goto ZWBRy; tfUNX: $order = "\151\163\164\157\160\x20\144\145\x73\143\54\x69\144\40\144\x65\163\x63"; goto DUP6Y; NBZiV: if (empty($params["\167\150\145\x72\x65"])) { goto rtaxS; } goto ewDn7; LACx0: $model = Db::table("\x65\x6e\164\x65\x72\x70\x72\151\x73\x65\163")->alias("\145"); goto wR1gi; Zt8MV: ZDGk3: goto PBcvP; TQabK: $where["\145\56\x73\164\145\160"] = $search["\x73\164\x65\x70"]; goto mlxOy; ewDn7: $where = array_merge($params["\x77\150\x65\x72\x65"], $where); goto EgwIq; l91n3: U7dqM: goto Hl5Eg; ND6Fp: return ["\164\157\x74\x61\x6c" => $count, "\162\157\167\x73" => $items]; goto cejRV; ZWBRy: return []; goto toAet; toAet: VuKX2: goto tfUNX; EgwIq: rtaxS: goto XKdnn; O1BRM: $where["\145\56\163\164\x65\160\x5f\163\164\x61\164\x65"] = $search["\x73\164\x65\160\137\x73\x74\x61\164\145"]; goto Zt8MV; Tfsj9: $clone = clone $model; goto HC31t; CGkZG: if (empty($search["\155\x69\x6e\x65"])) { goto HHOV2; } goto UGcAa; HhVEo: if (empty($search["\x73\x74\x65\160\137\x73\x74\141\x74\x65"])) { goto ZDGk3; } goto O1BRM; o0YGm: $where["\x65\x2e\156\x61\x6d\145"] = ["\154\151\153\x65", "\45{$search["\156\x61\155\x65"]}\x25"]; goto kk7_F; x8I1W: if (empty($search["\163\143\151\145\x6e\x74\151\163\x74\137\x69\144"])) { goto U7dqM; } goto eqY6t; MEYNe: $model->join("\165\163\145\162\x73\x5f\162\x65\x63\157\162\x64\163\40\x72", "\145\56\151\x64\75\x72\x2e\162\x65\x63\157\162\x64\x5f\x69\x64"); goto sqx0k; UGcAa: $where["\x72\56\x6d\x6f\x64\x75\154\145"] = self::MODULE; goto h5JIH; mlxOy: jYi9L: goto HhVEo; XKdnn: if (empty($search["\163\164\145\x70"])) { goto jYi9L; } goto TQabK; h5JIH: $where["\x72\56\165\x73\x65\x72\137\151\144"] = session("\x75\163\145\x72\151\144"); goto MEYNe; DUP6Y: $items = $clone->page($page, $rows)->order($order)->field("\x65\x2e\x69\x64\x2c\145\x2e\144\141\x74\145\137\x63\162\x65\x61\x74\145\x64\x2c\x65\x2e\x73\x74\x65\x70\54\x65\56\163\x74\145\160\137\163\164\141\x74\145\x2c\145\56\x66\157\165\156\x64\x65\162\x2c\x65\56\156\x61\x6d\x65\54\145\x2e\141\154\151\x61\163\54\145\56\144\x65\x73\x63\162\151\x70\164\151\157\x6e\54\x65\x2e\141\x73\x73\151\147\156\145\162\54\145\56\x61\144\x64\x69\x74\151\157\x6e\x61\154\137\x61\x73\163\x69\x67\156\x65\162\x73")->select(); goto ND6Fp; HC31t: $count = $model->count(); goto fW6s9; cejRV: } public function getEnterprise($id) { goto zlTfn; z38Dj: $row = Enterprises::get($id); goto Tu1Xy; jO8yK: $row["\145\x78\x74\162\x61"] = Extra::I()->getValue(self::MODULE, $id); goto cAJp3; cAJp3: array_walk($row, function (&$v) { goto Hd3oB; YfYeN: $v = ''; goto GpQjx; GpQjx: VzPs4: goto qcPyp; Hd3oB: if (!($v == "\x30\60\x30\x30\55\x30\x30\55\60\60")) { goto VzPs4; } goto YfYeN; qcPyp: }); goto dk4B5; e3S6P: nwTQz: goto z38Dj; D_Vc9: return []; goto e3S6P; zlTfn: if (!empty($id)) { goto nwTQz; } goto D_Vc9; Tu1Xy: if (empty($row)) { goto Hu4e9; } goto RJe0z; RJe0z: $row["\x74\141\x67\163"] = Tag::I()->getEntityTags(Defs::ENTITY_PROJECT, $id); goto jO8yK; QN9k0: return $row; goto KfkvD; dk4B5: Hu4e9: goto QN9k0; KfkvD: } public function saveEnterprise($id, $data) { goto dcFxW; kAug3: $users = $data["\x61\x73\163\151\147\156\145\x72"]; goto IMCu5; A6NXV: $id = $this->enterprise_model->id; goto tHlK2; IMCu5: if (!$data["\141\x64\x64\151\x74\x69\x6f\x6e\x61\x6c\137\x61\x73\163\x69\147\x6e\145\162\x73"]) { goto ptihr; } goto UJHY2; iI6sj: Extra::I()->setValue(self::MODULE, $id, $extra); goto KUR3i; XcMf2: exception("\xe5\x88\x9b\xe5\247\x8b\344\xba\272\344\xb8\215\350\203\275\344\270\xba\xe7\251\xba"); goto RCHBX; dcFxW: if (!(isset($data["\x6e\x61\x6d\145"]) && empty($data["\156\141\155\x65"]))) { goto lWrmC; } goto CKwMo; Pst7d: if (!$tags) { goto Fe0AF; } goto s8ASR; UjtZv: lWrmC: goto n0RiT; KQakk: SfKeh: goto Pst7d; xvjTf: $this->enterprise_model->allowField(true)->save($data); goto A6NXV; UJHY2: $users .= "\x2c" . $data["\141\x64\144\151\x74\x69\x6f\x6e\x61\154\x5f\x61\x73\x73\x69\147\x6e\145\162\163"]; goto tFip9; xMQJT: UserRecord::I()->setRecordUsers(self::MODULE, $id, $users, $data["\x61\163\x73\x69\x67\x6e\145\x72"]); goto KQakk; zoYal: f5mss: goto xwglq; RgeIS: $extra = $data["\145\170\164\x72\141"]; goto t9Cf8; nwkjm: return $id; goto HG693; KUR3i: WdS6N: goto nwkjm; xwglq: if (!$data["\141\x73\163\x69\147\x6e\145\x72"]) { goto SfKeh; } goto kAug3; D9TvZ: $tags = $data["\164\x61\147\163"]; goto RgeIS; CKwMo: exception("\344\274\201\344\xb8\232\xe5\220\x8d\xe7\247\xb0\xe4\xb8\215\xe8\203\275\344\xb8\272\347\xa9\xba"); goto UjtZv; o6XJM: goto f5mss; goto LYQ6_; TBBwR: Fe0AF: goto lflSE; LYQ6_: Uk59B: goto WL6Ze; tFip9: ptihr: goto xMQJT; WL6Ze: $log_event = false; goto Zb4b0; Zb4b0: $data["\143\162\x65\x61\164\145\144\x5f\142\171"] = session("\x75\163\x65\x72\x69\x64"); goto xvjTf; tHlK2: EventLogs::recordProject($id, "\xe6\x96\xb0\xe5\xa2\236"); goto zoYal; Eb18j: if (empty($id)) { goto Uk59B; } goto Axhul; n0RiT: if (!(isset($data["\146\x6f\165\156\144\145\162"]) && empty($data["\146\157\165\156\x64\145\162"]))) { goto vRKny; } goto XcMf2; lflSE: if (!$extra) { goto WdS6N; } goto iI6sj; t9Cf8: unset($data["\164\141\147\163"], $data["\x65\170\164\x72\141"]); goto Eb18j; s8ASR: Tag::I()->setEntityTags($id, $tags, $log_event); goto TBBwR; RCHBX: vRKny: goto D9TvZ; Axhul: $this->enterprise_model->allowField(true)->save($data, ["\151\144" => $id]); goto o6XJM; HG693: } public function delete($id) { $result = $this->enterprise_model->where("\x69\x64", $id)->setField("\x64\x65\154\x65\164\145\x64", 1); return $result > 0 ? true : false; } public function goStep($id, $type) { goto JUrlM; oVnwV: isset($types[$type]) ?: exception("\346\x97\xa0\346\225\x88\xe5\x8f\x82\346\x95\xb0"); goto PMbu8; PMbu8: $this->enterprise_model->query("\x75\x70\x64\141\164\145\x20\x65\156\x74\145\x72\160\162\x69\x73\145\163\40\163\x65\x74\40\163\164\145\x70\x3d\163\164\x65\x70{$types[$type]}\54\163\x74\x65\160\x5f\163\164\x61\x74\x65\x3d\60\x20\x77\x68\145\162\x65\x20\x69\x64\75{$id}"); goto R8nmt; JUrlM: $id = intval($id); goto edaKl; edaKl: $types = ["\x66\157\162\167\x61\x72\144" => "\x2b\x31", "\142\141\x63\153\167\141\162\144" => "\x2d\x31"]; goto oVnwV; R8nmt: } public function getEnterpriseFounders($enterprise_id) { goto jkhQI; PAZml: return $founders ? $founders : []; goto nx6vI; xecI8: $founders = $model->alias("\x65\146")->join("\x63\157\156\164\x61\x63\164\163\40\x63", "\x63\56\x69\x64\75\x65\x66\56\143\x6f\x6e\x74\x61\x63\x74\137\151\144")->where(["\x65\x66\56\145\156\164\x65\x72\x70\162\151\163\x65\x5f\x69\x64" => $enterprise_id])->order("\x65\x66\x2e\151\x64\x20\141\x73\143")->column("\145\x66\x2e\52\54\x63\56\156\141\x6d\x65\x2c\x63\56\x63\157\156\x74\141\143\x74\54\x63\56\x74\151\x74\154\x65\x2c\x63\56\x64\145\163\143\x72\x69\x70\x74\151\x6f\156", "\x65\146\x2e\x63\157\x6e\164\x61\143\164\x5f\x69\144"); goto PAZml; jkhQI: $model = new EFounders(); goto xecI8; nx6vI: } public function setEnterpriseFounders($enterprise_id, $founders_contact_id) { goto g87yI; oL_CS: if (is_array($founders_contact_id)) { goto x1sPj; } goto jz_0V; eAMSP: $exists = $this->getEnterpriseFounders($enterprise_id); goto oL_CS; oI0Es: return; goto XjLRz; NyrRu: $model->saveAll($adds); goto OStGC; xdjbd: foreach ($founders_contact_id as $contact_id) { goto K7wHC; GmAKH: gu2ZE: goto KItAV; cfVNF: MnU7u: goto GmAKH; iY5lp: $adds[] = ["\x65\156\x74\145\x72\x70\162\151\x73\x65\x5f\x69\144" => $enterprise_id, "\143\x6f\156\x74\141\x63\164\x5f\151\144" => $contact_id]; goto cfVNF; K7wHC: if (isset($exists[$contact_id])) { goto MnU7u; } goto iY5lp; KItAV: } goto ZUpm_; UpaFr: $model = new EFounders(); goto NyrRu; jz_0V: $founders_contact_id = explode("\x2c", $founders_contact_id); goto KJ4U1; pDcW4: $adds = []; goto xdjbd; ZUpm_: l28RB: goto UpaFr; KJ4U1: x1sPj: goto pDcW4; XjLRz: QOO8B: goto eAMSP; g87yI: if (!(empty($enterprise_id) || empty($founders_contact_id))) { goto QOO8B; } goto oI0Es; OStGC: } public function addInvestFunds($enterprise_id, $investment_id, $funds) { goto AwFF9; wQXtt: e8R3U: goto gE9HH; gLOad: XMMJp: goto vE52y; AwFF9: $enterprise = $this->getEnterprise($enterprise_id); goto YjDsL; vE52y: foreach ($funds as $data) { goto GjV8e; qJw1L: WVLq_: goto sXimT; gNDqK: Upload::I()->relateAttaches($data["\x74\x72\x61\x6e\x73\x66\x65\x72\x5f\x64\151\162\145\143\164\151\x76\145"], $enterprise_id, $fe->id); goto qJw1L; u8hvC: $fe = FundsEnterprises::create($data, true); goto gNDqK; GjV8e: $data["\x65\156\164\x65\162\x70\x72\x69\163\145\x5f\151\144"] = $enterprise_id; goto Y1cRC; wZrHs: $data["\163\x74\x6f\x63\x6b\x5f\x72\x61\x74\151\157\137\x6e\145\167"] = $data["\x73\x74\157\x63\153\137\x72\141\x74\151\157"]; goto u8hvC; Y1cRC: $data["\151\x6e\166\x65\x73\164\155\145\x6e\x74\x5f\151\x64"] = $investment_id; goto wZrHs; sXimT: } goto wQXtt; kFp3U: exception("\xe9\241\271\347\233\256\351\x98\xb6\346\xae\265\344\270\x8d\347\xac\xa6"); goto gLOad; YjDsL: if (!($enterprise["\x73\x74\145\x70"] < 4)) { goto XMMJp; } goto kFp3U; gE9HH: } public function getInvestFunds($enterprise_id, $fund_id = 0) { goto jTWHa; KWHt_: $funds = $model->alias("\146\145")->join("\x66\165\x6e\144\x73\x20\x66", "\146\56\x66\x75\156\x64\x5f\151\144\x3d\146\145\56\146\x75\x6e\x64\137\x69\144")->join("\x66\165\156\144\163\137\146\151\156\x61\156\x63\x65\137\145\156\164\x65\162\x70\x72\151\x73\x65\163\40\x66\146\x65", "\146\146\x65\x2e\146\146\145\x5f\x69\x64\75\146\145\x2e\x66\x66\x65\137\151\144")->where($where)->order("\x66\145\x2e\x69\144\x20\x61\163\143")->column("\x66\x65\x2e\52\x2c\146\146\x65\56\x61\x6d\x6f\x75\x6e\164\x2c\146\x2e\156\141\x6d\x65\54\x66\56\163\x69\x7a\x65", "\x66\x65\x2e\146\x75\156\144\137\151\x64"); goto mi6kM; hT4jP: $where = ["\146\145\x2e\x65\x6e\x74\145\162\x70\x72\x69\163\x65\137\151\144" => $enterprise_id]; goto qwhGK; Em7mM: $where["\146\x65\x2e\x66\165\x6e\144\x5f\151\x64"] = $fund_id; goto gI77d; mi6kM: return $funds ? $funds : []; goto fDQ4O; jTWHa: $model = new FundsEnterprises(); goto hT4jP; gI77d: Lzgmg: goto KWHt_; qwhGK: if (!$fund_id) { goto Lzgmg; } goto Em7mM; fDQ4O: } public function getInvestEnterprise($fund_id) { goto cKaQQ; E_cdw: $enterprises = $model->alias("\146\145")->join("\145\x6e\x74\x65\162\x70\x72\x69\163\x65\163\x20\x65", "\145\56\x69\x64\x3d\146\x65\x2e\x65\156\x74\x65\x72\x70\x72\x69\x73\145\137\151\x64")->join("\x69\156\166\145\x73\x74\155\145\x6e\x74\40\151", "\151\x2e\x69\x64\x3d\x66\145\56\x69\156\x76\145\x73\164\155\x65\156\x74\x5f\x69\x64")->join("\x66\x75\x6e\x64\x73\x5f\146\x69\156\141\x6e\143\x65\x5f\145\x6e\164\x65\162\160\x72\x69\163\145\x73\x20\x66\146\x65", "\146\x66\145\56\146\146\145\x5f\x69\144\75\146\145\56\x66\x66\145\x5f\151\x64\x20\141\x6e\144\40\146\146\x65\x2e\146\x75\x6e\x64\x5f\151\144\x3d" . $fund_id)->field("\146\x65\x2e\x2a\x2c\x66\146\145\56\x61\155\x6f\x75\156\x74\54\146\x66\145\56\144\x61\164\x65\x2c\145\56\x6e\x61\x6d\145\54\x65\x2e\154\141\164\145\x73\x74\137\166\141\154\165\x61\x74\151\157\156\54\x69\56\x66\151\156\x61\x6e\x63\151\156\147\x5f\163\164\141\147\145\54\151\56\x69\156\151\x74\x69\141\154\137\x76\141\154\165\141\x74\x69\157\x6e")->where(["\x66\x65\x2e\x66\165\x6e\144\x5f\x69\x64" => $fund_id])->order("\x66\145\56\x69\144\x20\141\x73\143")->select(); goto K_kHF; cKaQQ: $model = new FundsEnterprises(); goto E_cdw; K_kHF: return $enterprises; goto c86UJ; c86UJ: } public function setDividend($enterprise_id, $allocate) { goto beUsf; beUsf: $ffi_ids = array_column($allocate, "\146\x66\x69\x5f\151\x64"); goto Bx7QY; aqJ60: $model = new Edividends(); goto MoLOy; MoLOy: $user_id = session("\x75\x73\145\x72\x69\144"); goto PFzke; sEAjx: e7QRS: goto aqJ60; RZccX: if (!(empty($total_allocate) || round($total_allocate, 2) <= 0)) { goto e7QRS; } goto FYMrW; PPYT0: bihI2: goto FIcua; FYMrW: exception("\350\257\267\350\xae\xbe\347\xbd\256\345\x88\x86\xe7\272\242\xe9\x87\x91\351\242\235"); goto sEAjx; Bx7QY: $total_allocate = FundsFinanceIncomes::where("\x66\146\x69\x5f\151\144", "\x69\x6e", $ffi_ids)->sum("\x61\155\157\165\156\164"); goto RZccX; PFzke: foreach ($allocate as $fund_id => $v) { goto VZcsM; NkVO6: $data["\x65\156\x74\x65\x72\x70\162\151\163\x65\137\151\144"] = $enterprise_id; goto Kw_5g; Kw_5g: $data["\x66\165\156\x64\x5f\x69\x64"] = $fund_id; goto XswSo; qcx74: OUwwJ: goto Vy8ZO; XswSo: $data["\143\162\x65\x61\x74\x65\x64\137\x62\171"] = $user_id; goto tFsKH; tFsKH: $model::create($data); goto zbDRF; wmC_H: $data = ["\146\x66\x69\137\151\144" => $v["\x66\x66\x69\x5f\151\x64"], "\x64\x65\163\x63\162\x69\x70\164\151\x6f\x6e" => $v["\144\145\x73\143\162\x69\160\x74\x69\157\x6e"]]; goto I24ta; BPSOE: hekz7: goto wmC_H; zbDRF: goto Bvy1D; goto CccDg; VZcsM: if (!empty($v["\x66\x66\151\137\151\x64"])) { goto hekz7; } goto ai3Al; jJE4T: $model::update($data, ["\x69\144" => $v["\151\x64"]], true); goto bSRAe; bSRAe: Bvy1D: goto qcx74; ai3Al: goto OUwwJ; goto BPSOE; CccDg: yUb6I: goto jJE4T; I24ta: if ($v["\151\x64"]) { goto yUb6I; } goto NkVO6; Vy8ZO: } goto PPYT0; FIcua: } public function deleteDividend($exit_id) { goto enWhh; G2NVY: Db::table("\146\165\156\144\x73\x5f\146\151\x6e\x61\x6e\143\145\137\151\156\143\x6f\155\145\x73")->where("\145\170\151\x74\137\151\x64", $exit_id)->delete(); goto LXdEQ; WRYsW: Db::table("\145\156\x74\145\162\x70\x72\151\163\145\x73\137\144\x69\166\151\144\145\x6e\x64\163\x5f\160\x61\162\x74\156\x65\x72\163")->where("\146\x66\151\137\x69\144", "\x69\x6e", $ffi_id)->delete(); goto TfsBu; TfsBu: Db::table("\146\x75\156\x64\163\137\146\x69\x6e\x61\x6e\x63\x65\137\164\x61\x78\x65\x73")->where("\146\x66\x69\x5f\151\144", "\x69\x6e", $ffi_id)->delete(); goto G2NVY; DhTt9: Edividends::destroy($exit_id); goto YARdQ; enWhh: $ffi_id = Db::table("\146\x75\x6e\144\163\x5f\x66\151\x6e\141\156\143\145\137\x69\x6e\x63\x6f\155\x65\163")->where("\x65\170\x69\x74\x5f\151\x64", $exit_id)->column("\x66\x66\151\x5f\x69\x64"); goto QS6vT; LXdEQ: MK271: goto DhTt9; QS6vT: if (!$ffi_id) { goto MK271; } goto WRYsW; YARdQ: } public function addShareholders($data, $file_id) { goto WHjok; Le9JP: DEy1n: goto lSw4n; u6dk1: $file = Attachments::where(["\x61\x74\x74\x61\x63\x68\x6d\145\x6e\164\x5f\151\144" => $file_id, "\x73\164\x61\164\165\163" => Defs::ATTACHMENT_OK])->find(); goto eEeJP; mZ5tH: exception("\350\257\267\xe4\xb8\x8a\344\xbc\240\xe8\x82\241\xe4\xb8\x9c\346\230\x8e\347\273\206\350\xa1\250"); goto SsxCf; er311: if (!$file_id) { goto RHqAP; } goto u6dk1; Jgws_: $this->setShareholdersFromExcel($id, $file); goto o8qLq; lSw4n: Db::table("\145\x6e\x74\x65\162\160\162\x69\x73\x65\x5f\163\x68\x61\x72\x65\150\x6f\154\144\145\162")->where(["\151\144" => $id])->update($data); goto T9bIK; sJsZ3: RHqAP: goto lOOt_; xnspI: if (!empty($file_id)) { goto iRlYM; } goto mZ5tH; o8qLq: g77sv: goto sJsZ3; eEeJP: if (!$file) { goto g77sv; } goto Jgws_; T9bIK: TLDQJ: goto er311; BIr3a: goto TLDQJ; goto Le9JP; WHjok: $id = intval($data["\x69\x64"]); goto mPAwt; HDOsL: $id = Db::table("\x65\x6e\164\x65\x72\x70\162\151\163\x65\137\x73\150\141\162\x65\x68\x6f\x6c\144\x65\162")->insertGetId($data); goto XT4ba; XT4ba: Upload::I()->relateAttaches($file_id, $id); goto BIr3a; pVAli: Tn3nN: goto iuGCk; iuGCk: if ($id) { goto DEy1n; } goto xnspI; mPAwt: unset($data["\151\144"]); goto WMpfc; lOOt_: return $id; goto LWhT8; WMpfc: if (!empty($data["\145\151\144"])) { goto Tn3nN; } goto vI5wq; vI5wq: exception("\347\xbc\xba\345\xb0\x91\xe5\x8f\x82\346\x95\260"); goto pVAli; SsxCf: iRlYM: goto HDOsL; LWhT8: } public function delShareholders($id) { goto aZB3f; muRUm: Db::table("\145\156\x74\145\x72\x70\x72\151\x73\x65\137\x73\x68\x61\x72\x65\x68\x6f\x6c\x64\145\162\137\144\x65\164\141\x69\x6c")->where(["\145\163\x69\x64" => $id])->delete(); goto WqVOe; WqVOe: Db::table("\145\156\164\145\x72\x70\162\x69\163\x65\x73\x5f\146\x69\x6e\141\156\x63\x69\156\147")->where(["\x65\163\151\x64" => $id])->limit(1)->setField("\145\163\x69\144", 0); goto CWJwB; CWJwB: Upload::I()->deleteAttaches($id, 31); goto gU3z_; aZB3f: Db::table("\x65\x6e\164\x65\162\160\x72\151\163\145\137\x73\150\141\x72\145\150\157\x6c\x64\145\162")->where(["\x69\x64" => $id])->delete(); goto muRUm; gU3z_: } public function updateShareholderDetail($data) { foreach ($data as $id => $row) { Db::table("\x65\x6e\164\x65\x72\x70\x72\x69\163\145\x5f\x73\x68\141\x72\145\x68\157\x6c\x64\x65\x72\137\144\x65\164\x61\151\154")->where(["\151\x64" => $id])->update($row); XWeaI: } cCWJ5: } public function setShareholdersFromExcel($esid, $file) { goto Vz3Q6; f2p74: if (!($r <= $rows)) { goto RRr73; } goto RigDa; Zyhie: VZ_fY: goto wqpEX; EqynH: if (false === strpos($tmp[3], "\45")) { goto s2HZ0; } goto lxpWg; FYBTm: RocPr: goto NGOan; YYgbF: pQfDF: goto aJuY3; wqpEX: if (!($c < 5)) { goto luudh; } goto wlRxO; OhsN6: goto Fwl6n; goto BbHrT; Bsapk: $c = 0; goto Zyhie; D3fQz: Db::table("\145\x6e\x74\145\x72\160\162\x69\163\x65\137\x73\x68\x61\x72\145\150\157\x6c\144\x65\162\x5f\144\145\164\141\151\x6c")->where(["\x65\x73\x69\144" => $esid])->delete(); goto Nr7Xy; AAZuz: $_id = Db::table("\x65\156\164\x65\x72\x70\x72\151\x73\145\x5f\163\150\141\162\145\x68\157\x6c\144\145\162\x5f\x64\x65\164\x61\x69\x6c")->insertGetId($record); goto FYBTm; wlRxO: $cell = $sheet->getCellByColumnAndRow($c, $r); goto t6ukV; ed30X: s2HZ0: goto dA5XM; j6Dyj: goto VZ_fY; goto GFewb; BbHrT: RRr73: goto xkqAA; lxpWg: $stock_ratio = round(str_replace("\45", '', $tmp[3]), 3); goto afnOo; muC5Q: rE0Nx: goto UFEhu; t6ukV: $tmp[] = trim($cell->getValue()); goto YYgbF; U_Adv: if (!empty(trim($tmp[0]))) { goto ImFM2; } goto xYjFN; xYjFN: goto RRr73; goto Arbsg; afnOo: goto rE0Nx; goto ed30X; UFEhu: $record = ["\145\x73\151\x64" => $esid, "\x6e\141\155\145" => $tmp[0], "\x72\x65\x67\x5f\x61\x73\163\145\164" => empty($tmp[1]) ? null : $tmp[1], "\x69\x6e\166\145\x73\164\155\x65\156\x74" => empty($tmp[2]) ? null : $tmp[2], "\163\x74\x6f\x63\x6b\137\162\x61\164\x69\x6f" => $stock_ratio, "\x73\164\157\143\x6b\137\164\x6f\164\x61\x6c" => empty($tmp[4]) ? null : $tmp[4]]; goto AAZuz; TrfHC: $r = 2; goto WcSEp; RigDa: $tmp = []; goto Bsapk; GFewb: luudh: goto U_Adv; aJuY3: $c++; goto j6Dyj; Nr7Xy: $rows = $sheet->getHighestRow(); goto TrfHC; Vz3Q6: $excel = \PHPExcel_IOFactory::load(UPLOAD_DIR . DS . $file["\163\141\x76\x65\137\156\141\155\145"]); goto eFyWh; Arbsg: ImFM2: goto EqynH; dA5XM: $stock_ratio = round($tmp[3] * 100, 3); goto muC5Q; NGOan: $r++; goto OhsN6; eFyWh: $sheet = $excel->getSheet(0); goto D3fQz; WcSEp: Fwl6n: goto f2p74; xkqAA: } public function loadDividends($fundId, $search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = "\x69\x64", $order = "\144\145\x73\143") { goto g9AYm; g9AYm: $limit = ($page - 1) * $rows . "\x2c" . $rows; goto fDXiQ; m74B1: $conditions = ["\146\146\x69\56\x66\x75\x6e\144\137\x69\144" => $fundId]; goto gdRqE; MVMAo: $order = "\x44\56\151\144\x20\x64\145\x73\143"; goto uMRVu; cvOdh: return ["\164\157\x74\141\154" => $totalCount, "\162\157\x77\163" => $records]; goto EVQej; rV04Z: zqc2P: goto m74B1; sB91u: $order = "\104\x2e\x69\x64\40" . $order; goto rV04Z; omVGA: jONEc: goto sB91u; gdRqE: $totalCount = Db::table("\146\165\x6e\144\x73\x5f\x66\x69\156\141\156\x63\x65\137\x69\156\143\x6f\155\x65\163")->alias("\146\146\x69")->join("\x65\156\164\145\162\160\162\151\x73\145\x73\x5f\144\x69\x76\x69\144\145\156\144\x73\40\104", "\x66\x66\151\56\x65\170\x69\164\x5f\151\144\x3d\104\56\x69\144")->join("\x65\156\x74\145\162\160\x72\151\163\x65\x73\x20\x45", "\x44\56\x65\156\x74\x65\x72\160\162\x69\163\145\x5f\151\144\x3d\x45\56\151\x64")->where($conditions)->count(); goto LOZr9; uMRVu: goto zqc2P; goto omVGA; LOZr9: $records = Db::table("\146\165\156\x64\x73\137\146\x69\x6e\x61\x6e\143\145\137\x69\x6e\143\x6f\155\x65\x73")->alias("\x66\x66\151")->join("\x65\156\x74\145\x72\160\x72\x69\163\x65\163\137\x64\151\x76\151\144\145\x6e\x64\x73\40\x44", "\146\146\151\x2e\x65\x78\151\x74\x5f\151\x64\75\x44\56\151\x64")->join("\x65\156\x74\x65\x72\x70\162\x69\163\145\x73\40\105", "\x44\x2e\x65\156\x74\x65\x72\x70\x72\151\x73\145\137\x69\x64\x3d\105\x2e\151\144")->where($conditions)->field("\104\56\151\144\x2c\104\56\164\x79\x70\x65\40\141\x73\x20\145\137\x74\x79\x70\x65\x2c\x44\56\x64\x61\164\x65\40\141\x73\x20\145\137\144\141\164\x65\54\104\x2e\141\155\x6f\165\156\x74\x20\x61\163\x20\x65\x5f\141\x6d\157\x75\x6e\x74\54\105\56\151\144\40\141\x73\x20\x65\156\164\x65\x72\x70\162\151\x73\145\137\151\x64\x2c\105\x2e\156\x61\155\145\54\146\x66\x69\x2e\x66\146\x69\137\151\144\54\x66\146\x69\x2e\141\155\157\x75\156\164\x2c\x66\146\151\56\144\141\x74\x65")->order($order)->limit($limit)->select(); goto cvOdh; fDXiQ: if ($sort == "\151\x64") { goto jONEc; } goto MVMAo; EVQej: } public function loadDividendPartners($ffiId) { goto KdWgH; BCCtF: foreach ($records as &$record) { $record["\x66\x69\156\141\x6c"] = sprintf("\45\60\x31\56\62\x66", $record["\141\155\157\165\x6e\164"] - $record["\x66\x65\x65"] - $record["\x74\141\170"]); XIi_b: } goto v7FUn; v7FUn: J3t7V: goto vzn1Q; KdWgH: $records = Db::table("\145\x6e\164\145\162\x70\x72\151\163\145\163\x5f\144\151\166\x69\x64\x65\x6e\x64\x73\137\x70\x61\162\164\156\145\x72\x73")->alias("\x45\x44\x50")->join("\x50\141\x72\164\156\145\162\x73\40\120", "\x45\104\120\56\160\x5f\151\x64\75\x50\56\160\x5f\x69\x64", "\114\105\x46\x54")->where("\105\104\x50\x2e\146\146\151\137\x69\144", $ffiId)->field("\105\x44\x50\56\x2a\54\x50\x2e\x6e\x61\x6d\x65\54\120\x2e\x74\171\160\x65")->select(); goto BCCtF; vzn1Q: return $records; goto iA1R4; iA1R4: } public function loadDividendDispatchPartners($ffiId) { goto x91n2; V1k5y: return []; goto Y8BDs; kMYYH: if (!($fundSize === null)) { goto PiHn1; } goto V1k5y; Y8BDs: PiHn1: goto ra7VS; hTT_Q: sQTWb: goto EYFhX; x91n2: $fundId = Db::table("\x66\x75\x6e\x64\163\137\146\x69\x6e\141\156\143\x65\x5f\151\x6e\x63\x6f\155\145\x73")->where("\146\146\x69\x5f\151\144", $ffiId)->value("\x66\x75\156\144\x5f\151\144"); goto KcYld; ra7VS: $partners = Db::table("\x66\165\156\144\163\x5f\160\x61\x72\164\156\145\162\x73")->alias("\x46\x50")->join("\160\141\162\x74\x6e\145\x72\163\40\120", "\106\120\56\x70\137\151\144\x3d\120\56\x70\x5f\x69\x64", "\x4c\x45\106\124")->where("\106\120\x2e\x66\165\x6e\144\137\151\x64", $fundId)->field("\106\x50\x2e\x2a\54\120\x2e\x6e\x61\155\x65\54\x50\56\164\171\160\145")->select(); goto srNCr; v9cKw: return []; goto hTT_Q; KcYld: if (!empty($fundId)) { goto sQTWb; } goto v9cKw; YR0Ii: return $partners; goto uCwwA; P93gA: zk57v: goto YR0Ii; srNCr: foreach ($partners as &$partner) { goto ggH9t; NYe8t: $partner["\x73\x68\x61\x72\145"] = round($partner["\x61\x6d\x6f\x75\x6e\164"] / $fundSize * 100, 2) . "\45"; goto CA0Bs; Ey1xd: $partner["\141\x6d\x6f\165\156\164"] = $existRecord["\x61\x6d\157\165\156\164"]; goto xdQeJ; eIUND: if ($existRecord) { goto QUvtd; } goto Cig2L; CA0Bs: lVg40: goto re_JC; iBxlK: DQNJN: goto zBxv2; re_JC: $existRecord = Db::table("\x65\156\164\x65\x72\x70\x72\x69\163\145\163\x5f\144\151\166\x69\x64\x65\156\144\163\x5f\x70\x61\x72\164\156\x65\x72\x73")->where(["\x66\146\x69\137\x69\144" => $ffiId, "\x70\137\151\x64" => $partner["\x70\x5f\x69\144"]])->field(true)->find(); goto eIUND; fz3fO: $partner["\x74\141\170"] = "\x30\x2e\x30\60"; goto Pr4l3; xxLdh: QUvtd: goto Ey1xd; ggH9t: if ($fundSize) { goto m9EBT; } goto hxWjO; hxWjO: $partner["\x73\150\x61\x72\145"] = ''; goto RAGmg; nf5q_: m9EBT: goto NYe8t; Pr4l3: goto DQNJN; goto xxLdh; FeYG7: $partner["\164\x61\x78"] = $existRecord["\x74\141\x78"]; goto iBxlK; xdQeJ: $partner["\146\x65\145"] = $existRecord["\146\145\145"]; goto FeYG7; vCTuu: $partner["\146\x65\x65"] = "\x30\x2e\x30\60"; goto fz3fO; zBxv2: bM0Mp: goto yw9_X; Cig2L: $partner["\x61\x6d\x6f\x75\156\164"] = "\x30\56\60\x30"; goto vCTuu; RAGmg: goto lVg40; goto nf5q_; yw9_X: } goto P93gA; EYFhX: $fundSize = Db::table("\x66\x75\x6e\x64\x73")->where("\x66\165\156\x64\x5f\151\144", $fundId)->value("\163\x69\172\145"); goto kMYYH; uCwwA: } public function saveDividendDispatchPartner($ffiId, $pId, $amount, $fee, $tax) { goto roy_u; bYNSC: if ($exist) { goto Siz7h; } goto V_Fkz; uqSuC: if (!($tax !== null)) { goto fTE_e; } goto ZgvZP; YBXcl: fTE_e: goto swvfD; V_Fkz: $datas["\x66\146\x69\137\151\x64"] = $ffiId; goto V31Wb; W08zl: goto h3sgf; goto SA9xX; ZS_gg: h3sgf: goto EELJS; OUTsd: JbxKW: goto uqSuC; V0zHa: if (!($fee !== null)) { goto JbxKW; } goto Qst10; Qst10: $datas["\146\145\145"] = $fee; goto OUTsd; Xh0b6: Db::table("\145\x6e\x74\x65\x72\160\x72\x69\x73\x65\163\x5f\x64\x69\166\151\144\x65\x6e\x64\163\137\160\141\x72\x74\x6e\145\x72\x73")->insert($datas); goto W08zl; gpolK: Db::table("\x65\156\164\145\x72\x70\162\151\163\145\163\137\x64\151\x76\151\144\145\x6e\144\x73\137\x70\x61\x72\164\x6e\145\162\163")->where("\151\x64", $exist["\x69\144"])->update($datas); goto ZS_gg; ZgvZP: $datas["\x74\x61\170"] = $tax; goto YBXcl; Sww9L: $datas["\x61\155\157\165\x6e\164"] = $amount; goto a04xe; EELJS: return true; goto Hc5gN; roy_u: $datas = []; goto N_sQj; a04xe: c0Vpc: goto V0zHa; SA9xX: Siz7h: goto gpolK; swvfD: $exist = Db::table("\x65\156\164\x65\162\160\x72\151\163\145\x73\x5f\x64\x69\x76\151\x64\x65\x6e\x64\x73\x5f\x70\141\x72\x74\156\x65\162\163")->where(["\146\146\151\137\151\x64" => $ffiId, "\160\137\151\x64" => $pId])->find(); goto bYNSC; V31Wb: $datas["\160\x5f\151\144"] = $pId; goto Xh0b6; N_sQj: if (!($amount !== null)) { goto c0Vpc; } goto Sww9L; Hc5gN: } public function setDividendDispatchDefault($ffiId) { goto s1g0e; IqB6V: $partners = Db::table("\x66\165\156\144\x73\x5f\x70\x61\x72\x74\x6e\x65\162\163")->where("\x66\165\156\x64\x5f\x69\144", $ffi["\x66\x75\x6e\144\x5f\151\144"])->select(); goto bGrh8; HGkIS: YqWk2: goto IqB6V; Btltr: Db::table("\145\156\x74\x65\162\x70\162\x69\163\x65\163\137\144\151\x76\151\144\x65\156\x64\x73\x5f\x70\x61\x72\x74\x6e\145\162\x73")->where("\146\x66\x69\x5f\151\x64", $ffiId)->delete(); goto O4vUF; vYXHd: if (!empty($ffi)) { goto YqWk2; } goto iHIr1; r1QL7: foreach ($partners as $v) { $inserts[] = ["\x66\x66\x69\137\151\x64" => $ffiId, "\160\137\x69\x64" => $v["\160\137\151\144"], "\141\x6d\157\165\156\164" => round($v["\141\x6d\157\x75\156\x74"] / $ffi["\x73\x69\172\145"] * $ffi["\x61\x6d\157\165\x6e\164"], 2)]; pt79X: } goto jmwEk; O4vUF: Db::table("\x65\x6e\164\145\162\x70\162\151\x73\x65\x73\x5f\x64\x69\x76\x69\144\x65\156\144\x73\x5f\x70\141\x72\164\156\x65\162\163")->insertAll($inserts); goto SQKDr; s1g0e: $ffi = Db::table("\146\x75\x6e\x64\x73\x5f\146\x69\156\141\156\143\145\137\151\156\x63\157\x6d\x65\163")->alias("\x66\x66\x69")->join("\146\x75\x6e\144\x73\40\x66", "\146\56\146\165\x6e\x64\x5f\151\x64\75\146\146\x69\56\146\x75\x6e\x64\x5f\x69\x64")->field("\146\56\146\165\x6e\x64\137\151\x64\x2c\146\x2e\163\x69\x7a\145\x2c\x66\x66\x69\x2e\141\155\x6f\x75\x6e\x74")->where("\x66\146\x69\x2e\146\146\x69\x5f\x69\x64", $ffiId)->find(); goto vYXHd; jmwEk: w3H_F: goto Btltr; iHIr1: return false; goto HGkIS; bGrh8: $inserts = []; goto r1QL7; SQKDr: } public function getEnterprisePairs($id = null) { goto G_Bgc; G_Bgc: if (!$id) { goto xGEIa; } goto stovO; XFDkC: return $this->enterprise_model->column("\156\141\155\x65", "\x69\144"); goto AOVg5; zMSUq: xGEIa: goto XFDkC; stovO: $this->enterprise_model->where("\x69\144", "\x69\156", $id); goto zMSUq; AOVg5: } public function treeIndustries() { goto L5lTo; W8gQe: aIP1a: goto xcy6V; xcy6V: foreach ($rows as $k => $v) { goto MOJ0G; Hwuoj: ZfRq3: goto Acjqn; Kfdjk: gUf1R: goto WE9Kv; hh9lU: goto ZfRq3; goto Kfdjk; Acjqn: HZ3kh: goto jZOnm; WE9Kv: $rows[$k]["\151\143\157\156\103\x6c\163"] = "\146\x61\40\146\x61\55\164\141\147"; goto Pq_OK; MOJ0G: $pid = $v["\160\x69\144"]; goto zUiDe; zUiDe: if ($pid) { goto gUf1R; } goto lDrWK; Pq_OK: $rows[$pid]["\x63\x68\151\x6c\144\x72\145\x6e"][] = $rows[$k]; goto nsENZ; lDrWK: $rows[$k]["\151\x63\x6f\x6e\103\154\x73"] = "\x66\141\x20\146\141\x2d\x74\141\147\x73"; goto hh9lU; nsENZ: unset($rows[$k]); goto Hwuoj; jZOnm: } goto JAmJg; j2iIY: return []; goto W8gQe; L5lTo: $rows = Db::table("\x74\141\147\163")->where("\143\141\164\145\147\x6f\x72\x79", Tag::TAG_INDUSTRY)->order("\160\151\x64\40\x64\x65\x73\143\54\x69\x64\x20\x61\163\143")->column("\151\x64\x2c\160\x69\x64\54\156\x61\155\145\54\156\141\x6d\x65\40\141\x73\40\164\x65\x78\x74", "\151\144"); goto jNPr2; XZU1V: return $rows; goto gd91A; jNPr2: if (!empty($rows)) { goto aIP1a; } goto j2iIY; JAmJg: GE7Qy: goto XZU1V; gd91A: } public function getFinancingInfo($id) { goto eZgDX; eZgDX: $data = Db::table("\145\156\x74\145\162\x70\162\x69\163\145\x73\137\x66\151\156\x61\156\x63\x69\156\147")->where(["\x69\x64" => $id])->find(); goto pXbsY; M32uC: return $data; goto bcjv7; pXbsY: $data["\144\x65\164\x61\151\154"] = Extra::I()->getValue("\x65\x6e\x74\145\x72\x70\162\151\163\x65\x73\x5f\x66\x69\x6e\141\156\x63\x69\x6e\147", $id, "\144\145\x74\x61\x69\154"); goto M32uC; bcjv7: } public function updateFundsStockRatio($enterprise_id) { goto A05Za; A05Za: $last["\x73\164\x6f\x63\153\x5f\x72\x61\x74\151\x6f"] = 0; goto aWCVl; V4xxP: foreach ($ratios as $pk => $fund_ratio) { goto SW8tb; WUL1V: BOLXg: goto niFDq; JIR7W: Db::table("\x66\x75\x6e\144\163\137\145\156\x74\145\162\160\162\x69\163\145\x73")->where(["\x69\x64" => $pk])->setField("\163\x74\157\143\x6b\x5f\162\141\x74\151\157\137\156\145\167", $ratio_new); goto WUL1V; H5kFu: if (!($ratio_new != $fund_ratio)) { goto BOLXg; } goto JIR7W; niFDq: zTEZ7: goto cFBVe; SW8tb: $ratio_new = round($fund_ratio / $total_ratio * $last["\x73\x74\157\x63\x6b\x5f\162\141\x74\151\x6f"], 2); goto H5kFu; cFBVe: } goto inm30; mPoea: h1LD0: goto eDp_T; qVxHC: $total_ratio = array_sum($ratios); goto V4xxP; gMI1O: return; goto mPoea; inm30: NQOBb: goto xNn0B; aWCVl: if (!empty($last)) { goto h1LD0; } goto SaeYc; eDp_T: $ratios = Db::table("\146\165\x6e\x64\163\x5f\145\156\164\x65\x72\x70\x72\x69\x73\145\163")->where(["\x65\156\164\x65\162\x70\x72\x69\x73\x65\x5f\x69\x64" => $enterprise_id])->column("\x73\164\x6f\x63\x6b\137\162\x61\x74\151\x6f\137\x6e\145\167", "\151\144"); goto qVxHC; SaeYc: Db::query("\165\x70\144\x61\x74\x65\x20\146\165\156\x64\163\x5f\145\x6e\x74\145\162\160\162\151\163\x65\x73\x20\163\x65\x74\40\x73\x74\x6f\143\x6b\137\162\141\x74\151\x6f\x5f\x6e\x65\167\75\x73\x74\x6f\x63\x6b\137\162\x61\x74\151\157\x20\x77\x68\x65\x72\145\40\145\156\x74\145\x72\x70\162\151\163\145\137\151\x64\x3d{$enterprise_id}"); goto gMI1O; xNn0B: } }
