<?php
 namespace app\index\logic; use app\index\model\Tags; use app\index\model\TagsRecords; use think\Db; class Tag extends Base { protected $model_tags; protected $model_records; const TAG_INDUSTRY = 6; const CATEGORIES = array(2 => array("\x6e\x61\155\145" => "\xe4\272\247\345\x93\201\346\234\x8d\xe5\x8a\xa1", "\x65\156\x74\x69\x74\x79\x5f\164\171\x70\x65" => Defs::ENTITY_PROJECT), 3 => array("\x6e\x61\x6d\145" => "\345\256\242\346\210\xb7\46\xe4\xb8\x9a\xe5\x8a\241", "\145\156\x74\151\164\x79\137\164\x79\160\x65" => Defs::ENTITY_PROJECT), 4 => array("\x6e\141\155\x65" => "\344\270\252\344\272\272\346\xa0\207\xe7\xad\xbe", "\x65\x6e\164\151\164\171\x5f\164\x79\160\x65" => Defs::ENTITY_TALENT), 5 => array("\x6e\x61\x6d\145" => "\346\212\200\xe6\234\xaf", "\x65\156\x74\151\x74\171\x5f\164\171\x70\x65" => Defs::ENTITY_PROJECT), self::TAG_INDUSTRY => array("\x6e\x61\155\145" => "\350\241\214\344\270\232\xe6\xa0\207\347\255\xbe", "\145\156\x74\151\164\171\137\x74\x79\160\x65" => Defs::ENTITY_PROJECT)); protected function __construct() { goto ylmIm; VT9lX: $this->model_tags = new Tags(); goto TsRDJ; TsRDJ: $this->model_records = new TagsRecords(); goto YdYWD; ylmIm: parent::__construct(); goto VT9lX; YdYWD: } public function addTag($name, $category) { goto yYAKM; AKr5M: $tag = $this->model_tags->where(["\143\x61\x74\145\x67\x6f\162\x79" => $category, "\x6e\x61\x6d\x65" => $name])->field("\151\144")->limit(1)->find(); goto FqyA1; weh0u: return $id; goto cI8DR; WRy6y: $name = htmlspecialchars($name); goto AKr5M; Cfs3m: PKFdn: goto gTVRa; uT_KZ: if (!empty($name)) { goto LJbB3; } goto vlbX4; gTVRa: $id = $this->model_tags->insert(["\x63\x61\164\x65\x67\x6f\x72\x79" => $category, "\x6e\x61\x6d\145" => $name], false, true); goto BcVQX; xmGo2: LJbB3: goto WRy6y; yYAKM: $name = trim($name); goto uT_KZ; BcVQX: FdmJs: goto weh0u; FqyA1: if (empty($tag)) { goto PKFdn; } goto HGRW1; HGRW1: $id = $tag["\151\144"]; goto HsYTB; vlbX4: exception("\350\xaf\267\350\xbe\223\xe5\x85\xa5\346\226\207\345\xad\227"); goto xmGo2; HsYTB: goto FdmJs; goto Cfs3m; cI8DR: } public function getTagsByCategory($category, $limit = 100) { goto rYrK0; Uk5Vl: $tags = []; goto o7Inj; wR3hN: if (!empty($tags)) { goto WBnuo; } goto Uk5Vl; GlcCr: return $tags; goto zIWtp; o7Inj: WBnuo: goto GlcCr; rYrK0: $tags = Db::table("\x74\x61\x67\x73")->field("\x69\x64\x20\x61\x73\x20\164\141\x67\x5f\151\x64\54\x63\141\x74\x65\147\157\162\171\x2c\156\141\x6d\145")->where(["\143\141\164\145\x67\x6f\162\171" => $category])->order("\151\x64\40\141\163\x63")->limit($limit)->select(); goto wR3hN; zIWtp: } public function setEntityTags($entity_id, $tags, $log_event = null) { goto R8Fta; Mo7St: foreach ($tags as $category => $tag_ids) { goto O1sxs; gKqD2: foreach ($tag_ids as $tag_id) { goto MlQLF; MzzWE: H_Zjp: goto C_I7X; J2wjw: $exist = Db::table("\x74\141\147\163\x5f\x72\145\143\x6f\162\x64\x73")->where($map)->value("\151\x64"); goto TS9z7; eG0e3: Db::table("\164\141\147\163\137\x72\x65\143\157\x72\x64\163")->insert($map); goto O2m8n; TS9z7: if (!empty($exist)) { goto H_Zjp; } goto eG0e3; C_I7X: rTLzS: goto jZq04; WCjUZ: $map = ["\x65\x6e\164\x69\x74\171\137\x74\171\x70\145" => $entity_type, "\145\x6e\x74\151\164\x79\x5f\151\144" => $entity_id, "\x74\141\147\137\151\x64" => $tag_id, "\x63\141\164\145\147\x6f\x72\x79" => $category]; goto J2wjw; MlQLF: $filter_ids[] = $tag_id; goto WCjUZ; O2m8n: $added[] = $tag_id; goto MzzWE; jZq04: } goto J6t5k; Xrklq: if (!empty($tag_ids)) { goto CTfk8; } goto BF2Xx; g4QUm: bkgIv: goto rqAlG; O1sxs: $entity_type = self::CATEGORIES[$category]["\145\x6e\x74\x69\x74\171\x5f\164\171\160\145"]; goto Xrklq; i6fTk: CTfk8: goto fnAJj; BF2Xx: goto bkgIv; goto i6fTk; fnAJj: if (is_array($tag_ids)) { goto fkaF_; } goto G_u1o; C5Szg: fkaF_: goto gKqD2; J6t5k: ctPut: goto g4QUm; G_u1o: $tag_ids = explode("\x2c", $tag_ids); goto C5Szg; rqAlG: } goto uZFhh; cLLeO: zLWT_: goto mHLZQ; mHLZQ: if (!($log_event && $added)) { goto zlLP5; } goto WnWGT; I60Mp: k_jNu: goto IQDTW; uZFhh: WuKry: goto S5KTV; yycI8: $added = []; goto LBheR; LBheR: $filter_ids = []; goto Mo7St; S5KTV: $map = ["\x65\156\164\151\x74\171\x5f\164\x79\x70\x65" => $entity_type, "\145\x6e\164\x69\164\x79\137\x69\x64" => $entity_id, "\143\141\164\145\x67\x6f\162\171" => ["\151\156", array_keys($tags)]]; goto nC472; IQDTW: Db::table("\164\x61\x67\163\137\x72\x65\x63\157\162\x64\163")->where($map)->delete(); goto oNi0w; TVl6I: zlLP5: goto VoGxN; WnWGT: logEvent($entity_type, $entity_id, "\346\226\xb0\xe5\242\236\xe6\240\207\xe7\xad\276", ["\x74\x61\x67\x5f\x69\x64" => $added]); goto TVl6I; nC472: if (!$filter_ids) { goto k_jNu; } goto skr1B; R8Fta: if (!empty($tags)) { goto ilPgb; } goto zeRUY; zeRUY: return; goto YAtti; oNi0w: if (!is_null($log_event)) { goto zLWT_; } goto X5ZYM; skr1B: $map["\x74\x61\147\137\151\x64"] = ["\156\157\x74\40\151\x6e", $filter_ids]; goto I60Mp; X5ZYM: $log_event = true; goto cLLeO; YAtti: ilPgb: goto yycI8; VoGxN: } public function getEntityTags($entity_type, $entity_id) { goto TAExq; igGkn: H5CAU: goto aDkTw; TAExq: $map = ["\162\x2e\145\x6e\x74\151\164\x79\137\x74\171\160\145" => $entity_type, "\x72\x2e\x65\156\164\151\x74\171\x5f\x69\x64" => $entity_id, "\162\x2e\x64\x65\154\x65\x74\x65\x64" => 0]; goto I0z4O; uuQ_T: ITpg5: goto gvXpf; gvXpf: return $tags; goto ChWNL; aDkTw: $tags = []; goto h6heD; I0z4O: $rows = Db::table("\x74\141\x67\x73\137\x72\x65\143\157\x72\x64\163")->alias("\162")->join("\164\141\x67\x73\x20\x74", "\162\56\164\x61\x67\x5f\151\144\x3d\164\56\x69\x64")->field("\x72\56\164\x61\147\137\x69\x64\54\x74\56\156\x61\x6d\x65\x2c\x74\x2e\143\x61\164\x65\147\157\x72\171")->where($map)->order("\162\56\x69\x64\x20\x61\163\143")->select(); goto yMBeT; Zywe4: return []; goto igGkn; yMBeT: if (!empty($rows)) { goto H5CAU; } goto Zywe4; h6heD: foreach ($rows as $v) { $tags[$v["\143\x61\x74\145\x67\x6f\162\171"]][$v["\x74\141\147\x5f\x69\x64"]] = $v; dDtfY: } goto uuQ_T; ChWNL: } public function getEntityTagsByCategory($entity_id, $category) { goto RrrUf; tViK4: if (empty($rows)) { goto RJNds; } goto h4WsP; rZM0_: O8HNP: goto igDoV; RIBZK: $rows = Db::table("\164\141\x67\x73\137\x72\x65\143\x6f\x72\x64\163")->alias("\162")->join("\x74\141\147\x73\40\x74", "\162\56\164\x61\147\x5f\151\144\x3d\x74\x2e\x69\x64")->field("\x72\x2e\164\x61\x67\x5f\151\x64\54\164\56\156\x61\155\x65\x2c\x74\x2e\x63\141\164\145\x67\x6f\162\x79")->where($map)->order("\162\56\x69\144\x20\x61\163\143")->column("\x72\56\x74\141\147\137\151\x64\x2c\x74\56\156\x61\x6d\x65\54\x74\x2e\x63\x61\164\145\x67\157\x72\171", "\162\56\164\141\x67\x5f\x69\x64"); goto tViK4; ROlld: return []; goto rZM0_; RrrUf: $map = ["\x72\56\x65\156\x74\x69\x74\171\x5f\x74\x79\x70\x65" => self::CATEGORIES[$category]["\x65\156\x74\x69\164\171\x5f\x74\x79\x70\x65"], "\x72\56\145\x6e\164\151\164\x79\137\x69\144" => $entity_id, "\x72\56\143\141\164\x65\147\157\x72\x79" => $category]; goto RIBZK; VTM0r: RJNds: goto ROlld; h4WsP: return $rows; goto zWwiY; zWwiY: goto O8HNP; goto VTM0r; igDoV: } public function getTagsBatch($category, $entity_id) { goto UJmP_; I_buC: if (!empty($rows)) { goto cFj7e; } goto g1g2j; nStJF: wNLnS: goto xT3If; Y0mQQ: $tags = []; goto lfjJL; yfk1p: cFj7e: goto Y0mQQ; xzPH1: $rows = $this->model_records->alias("\162")->join("\164\x61\147\163\x20\164", "\x72\56\x74\141\147\x5f\x69\x64\75\x74\x2e\x69\144")->field("\x72\x2e\x74\x61\x67\137\151\144\54\162\x2e\x65\x6e\x74\x69\164\171\137\151\144\54\164\56\156\x61\x6d\145\x2c\x74\56\x63\141\x74\145\147\157\x72\x79")->where($map)->order("\x72\56\x69\144\x20\141\x73\143")->select(); goto I_buC; UJmP_: $map = ["\x72\x2e\x65\156\164\x69\x74\x79\x5f\164\x79\160\145" => self::CATEGORIES[$category]["\x65\156\164\151\164\x79\137\164\171\x70\x65"], "\162\x2e\145\x6e\164\x69\x74\171\137\x69\x64" => ["\151\156", $entity_id], "\164\x2e\143\x61\x74\x65\x67\x6f\x72\x79" => $category]; goto xzPH1; g1g2j: return []; goto yfk1p; xT3If: return $tags; goto vmwvP; lfjJL: foreach ($rows as $v) { $tags[$v["\145\x6e\x74\151\x74\x79\137\151\144"]][] = $v; Px2F4: } goto nStJF; vmwvP: } }
