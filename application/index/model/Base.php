<?php
 namespace app\index\model; use think\Model; use think\Db; use think\Request; use app\index\service\RequestContext; use think\Log; class Base extends Model { const AUDIT_LOG_ADD_TYPE = 1; const AUDIT_LOG_UPDATE_TYPE = 2; const AUDIT_LOG_DELETE_TYPE = 3; public static $auditLogTypeDefs = array(self::AUDIT_LOG_ADD_TYPE => "\xe6\267\273\345\212\240", self::AUDIT_LOG_UPDATE_TYPE => "\344\277\256\346\224\xb9", self::AUDIT_LOG_DELETE_TYPE => "\345\210\240\351\231\244"); public static $auditLogTypeHtmlDefs = array(self::AUDIT_LOG_ADD_TYPE => "\74\x73\160\141\156\40\143\x6c\141\x73\163\x3d\x22\142\x61\x64\147\x65\40\142\141\x64\147\x65\x2d\160\x72\151\x6d\x61\162\171\42\x3e\346\xb7\273\xe5\x8a\240\x3c\x2f\x73\160\x61\x6e\76", self::AUDIT_LOG_UPDATE_TYPE => "\74\x73\x70\141\156\40\143\154\141\163\163\x3d\x22\142\141\144\147\x65\40\142\141\x64\147\145\55\x73\145\143\x6f\156\144\141\162\x79\42\76\xe4\xbf\xae\346\x94\xb9\x3c\57\163\160\x61\x6e\x3e", self::AUDIT_LOG_DELETE_TYPE => "\74\163\160\141\156\x20\x63\154\141\x73\163\75\x22\142\141\x64\x67\x65\40\142\141\144\x67\145\55\x77\141\x72\156\151\x6e\x67\x22\76\xe5\210\240\351\231\244\74\x2f\x73\160\x61\156\x3e"); const AUDIT_LOG_DESKTOP_DEVICE = 1; const AUDIT_LOG_MOBILE_DEVICE = 2; public static $auditLogDeviceHtmlDefs = array(self::AUDIT_LOG_DESKTOP_DEVICE => "\x3c\x73\160\x61\x6e\40\143\154\141\163\x73\x3d\x22\x66\141\40\146\x61\55\144\x65\x73\x6b\164\157\x70\x22\76\x3c\x2f\x73\x70\141\156\x3e", self::AUDIT_LOG_MOBILE_DEVICE => "\74\163\160\x61\x6e\40\143\x6c\x61\x73\163\x3d\x22\x66\x61\40\x66\141\x2d\155\157\142\151\x6c\x65\42\x3e\x3c\57\x73\x70\x61\156\x3e"); protected function initialize() { parent::initialize(); } protected static function init() { goto pMTAI; T3s0e: return; goto iEgCG; blfDL: if (!empty($model::$audit_fields)) { goto Mk4b0; } goto M3vRI; m_z58: Mk4b0: goto cnYKa; iEgCG: C3alL: goto blfDL; cnYKa: $model::event("\x61\146\164\145\162\137\x69\x6e\163\x65\162\x74", function ($row) use($model) { goto fIyBM; SeATE: O7ieo: goto D1cXg; uv2h4: $desc .= json_encode($addChanges, JSON_UNESCAPED_UNICODE); goto ofqZT; ofqZT: Db::table("\x61\x75\x64\151\164\x5f\x6c\157\x67\163")->insert(["\x6d\x6f\144\x65\x6c" => $row->name, "\162\x65\x63\x6f\x72\x64\137\151\x64" => isset($model::$audit_record_id_field) ? $row->data[$model::$audit_record_id_field] : $row->data[$pk], "\x66\151\145\154\144\163" => "\174" . implode("\174", $addedFields) . "\174", "\151\160" => Request::instance()->ip(), "\x64\145\x73\x63" => $desc, "\164\171\x70\145" => self::AUDIT_LOG_ADD_TYPE, "\x64\x65\166\151\143\145" => Request::instance()->isMobile() ? self::AUDIT_LOG_MOBILE_DEVICE : self::AUDIT_LOG_DESKTOP_DEVICE, "\143\150\141\x6e\x67\x65\x64\x5f\x62\x79" => $changed_by]); goto SeATE; fIyBM: $pk = $row->getPk(); goto TD3Sp; r3MIT: if (!$addedFields) { goto O7ieo; } goto RTXPb; VfupO: cB5mJ: goto r3MIT; ucqKB: $desc .= "\xe6\226\260\345\xa2\236\xef\274\232"; goto uv2h4; I4dey: $addedFields = []; goto ReB4m; RTXPb: $desc = ''; goto ucqKB; TD3Sp: $changed_by = (int) RequestContext::I()->loginUserId; goto I4dey; VukXD: foreach ($model::$audit_fields as $field => $fieldName) { goto CTSZU; CTSZU: if (!isset($row->data[$field])) { goto nrkJi; } goto FqvS6; M2Fsd: YZ702: goto qrfsO; FqvS6: $addedFields[] = $field; goto e0PvA; xcAdD: $addChanges[$fieldName] = $model::$funcName($row->data[$field]); goto M2Fsd; aXoOt: ZjKpP: goto Ectd3; lQfrU: kozll: goto BLtdK; e0PvA: if (isset($model::$audit_field_translates) && isset($model::$audit_field_translates[$field]) && $model::$audit_field_translates[$field]) { goto ZjKpP; } goto AuF9U; AuF9U: $addChanges[$fieldName] = $row->data[$field]; goto R5EFs; R5EFs: goto YZ702; goto aXoOt; Ectd3: $funcName = $model::$audit_field_translates[$field]; goto xcAdD; qrfsO: nrkJi: goto lQfrU; BLtdK: } goto VfupO; ReB4m: $addChanges = []; goto VukXD; D1cXg: }); goto RVXGD; M3vRI: return; goto m_z58; M5jJ4: $model::event("\142\x65\x66\157\x72\x65\x5f\144\145\x6c\x65\164\x65", function ($row) use($model) { goto ILVcY; OC5fD: mMMYh: goto kW31T; Zh1OW: $desc .= json_encode($deletedChanges, JSON_UNESCAPED_UNICODE); goto EruwG; L7Fek: foreach ($model::$audit_fields as $field => $fieldName) { goto qXeAG; B73EF: if (isset($model::$audit_field_translates) && isset($model::$audit_field_translates[$field]) && $model::$audit_field_translates[$field]) { goto nNqrW; } goto CT_c2; jhuZg: nNqrW: goto YcAfW; CT_c2: $deletedChanges[$fieldName] = $old->data[$field]; goto Jx4tQ; wE_Lk: IYS3d: goto mKMOW; Jx4tQ: goto a3oos; goto jhuZg; YcAfW: $funcName = $model::$audit_field_translates[$field]; goto jHARc; qXeAG: if (!isset($old->data[$field])) { goto IYS3d; } goto fnn_K; fnn_K: $deletedFields[] = $field; goto B73EF; mKMOW: ZfKHn: goto ELENQ; jHARc: $deletedChanges[$fieldName] = $model::$funcName($old->data[$field]); goto srr8c; srr8c: a3oos: goto wE_Lk; ELENQ: } goto tGmP9; IGlQi: $old = $model::where($pk, $row->data[$pk])->field($fields)->find(); goto DpyQV; KQpj9: $deletedChanges = []; goto L7Fek; tGmP9: wdRrk: goto eokWJ; eokWJ: $changed_by = (int) RequestContext::I()->loginUserId; goto ick_S; EruwG: Db::table("\141\x75\144\x69\164\137\x6c\x6f\x67\x73")->insert(["\x6d\157\x64\x65\x6c" => $row->name, "\162\145\x63\157\162\144\x5f\x69\x64" => isset($model::$audit_record_id_field) ? $row->data[$model::$audit_record_id_field] : $row->data[$pk], "\x66\151\145\154\x64\x73" => "\174" . implode("\174", $deletedFields) . "\x7c", "\151\x70" => Request::instance()->ip(), "\x64\145\163\x63" => $desc, "\x74\171\x70\145" => self::AUDIT_LOG_DELETE_TYPE, "\x64\x65\166\151\x63\x65" => Request::instance()->isMobile() ? self::AUDIT_LOG_MOBILE_DEVICE : self::AUDIT_LOG_DESKTOP_DEVICE, "\143\x68\x61\x6e\147\145\x64\137\x62\x79" => $changed_by]); goto OC5fD; KR61H: $desc .= "\xe5\210\xa0\xe9\x99\xa4\xef\274\x9a"; goto Zh1OW; qwzle: $fields[] = $pk; goto IGlQi; OGHHH: $desc = ''; goto KR61H; ick_S: if (!$deletedFields) { goto mMMYh; } goto OGHHH; ILVcY: $pk = $row->getPk(); goto a6vsq; a6vsq: $fields = array_keys($model::$audit_fields); goto qwzle; DpyQV: $deletedFields = []; goto KQpj9; kW31T: }); goto cW1B7; RVXGD: $model::event("\x62\x65\146\x6f\x72\x65\x5f\x75\160\144\141\164\x65", function ($row) use($model) { goto geJ0g; geJ0g: $pk = $row->getPk(); goto iPLqM; mku6_: $desc .= json_encode($beforeChanges, JSON_UNESCAPED_UNICODE); goto QVowK; keyh_: b3Duw: goto LeqqH; FjBJ2: WJTfS: goto M9LIK; UuRKO: $changedFields = []; goto yR4wf; iPLqM: $fields = array_keys($model::$audit_fields); goto aGqpe; fTlm5: Db::table("\x61\x75\x64\151\164\x5f\154\x6f\x67\x73")->insert(["\155\157\144\x65\x6c" => $row->name, "\x72\145\x63\x6f\x72\x64\137\x69\x64" => isset($model::$audit_record_id_field) ? $old->data[$model::$audit_record_id_field] : $old->data[$pk], "\x66\151\145\x6c\144\x73" => "\174" . implode("\x7c", $changedFields) . "\x7c", "\151\x70" => Request::instance()->ip(), "\x64\145\163\143" => $desc, "\164\171\x70\145" => self::AUDIT_LOG_UPDATE_TYPE, "\x64\x65\166\151\x63\x65" => Request::instance()->isMobile() ? self::AUDIT_LOG_MOBILE_DEVICE : self::AUDIT_LOG_DESKTOP_DEVICE, "\143\150\141\156\x67\x65\x64\x5f\x62\x79" => $changed_by]); goto FjBJ2; k_LpP: $afterChanges = []; goto cC0Dg; YMsRM: $desc = ''; goto lH89H; YhT9g: foreach ($model::$audit_fields as $field => $fieldName) { goto qGkWu; BgFiW: HPyZ5: goto myqE3; P3f6q: eSJMA: goto SyPDp; lK3Yq: if (isset($model::$audit_field_translates) && isset($model::$audit_field_translates[$field]) && $model::$audit_field_translates[$field]) { goto IxEVd; } goto enumQ; SyPDp: yqclO: goto BgFiW; SdtRp: $beforeChanges[$fieldName] = $model::$funcName($old->data[$field]); goto CvBxs; Rv6ke: IxEVd: goto Y7Fmu; enumQ: $beforeChanges[$fieldName] = $old->data[$field]; goto XRjRt; qGkWu: if (!(isset($row->data[$field]) && $row->data[$field] != $old->data[$field])) { goto yqclO; } goto vV820; CvBxs: $afterChanges[$fieldName] = $model::$funcName($row->data[$field]); goto P3f6q; iT4q2: goto eSJMA; goto Rv6ke; XRjRt: $afterChanges[$fieldName] = $row->data[$field]; goto iT4q2; vV820: $changedFields[] = $field; goto lK3Yq; Y7Fmu: $funcName = $model::$audit_field_translates[$field]; goto SdtRp; myqE3: } goto UV8fc; LsCcz: I5RiU: goto UuRKO; lH89H: $desc .= "\346\233\264\346\x94\xb9\345\x89\x8d\357\xbc\232"; goto mku6_; sYN28: $fields[] = $model::$audit_record_id_field; goto keyh_; i3vRf: $desc .= json_encode($afterChanges, JSON_UNESCAPED_UNICODE); goto fTlm5; UV8fc: YO2vV: goto cp7Iu; GvZFa: if (!empty($old)) { goto I5RiU; } goto QxYhT; QVowK: $desc .= "\x3b\x3c\x62\x72\x20\x2f\76\xe6\x9b\264\346\x94\271\xe5\220\216\xef\274\232"; goto i3vRf; yR4wf: $beforeChanges = []; goto k_LpP; cp7Iu: if (!$changedFields) { goto WJTfS; } goto YMsRM; LeqqH: $old = $model::where($row->updateWhere)->field($fields)->find(); goto GvZFa; dN6Fe: if (!(isset($model::$audit_record_id_field) && !in_array($model::$audit_record_id_field, $fields))) { goto b3Duw; } goto sYN28; cC0Dg: $changed_by = (int) RequestContext::I()->loginUserId; goto YhT9g; aGqpe: $fields[] = $pk; goto dN6Fe; QxYhT: return; goto LsCcz; M9LIK: }); goto M5jJ4; fRUrw: if (isset($model::$audit_fields)) { goto C3alL; } goto T3s0e; pMTAI: $model = static::class; goto fRUrw; cW1B7: } }
