<?php
 namespace app\index\logic; use app\index\model\Setting; use app\index\service\RequestContext; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use think\Url; class ChangeLogs extends Base { const CHANGE_LOG_POINT_TYPE = 1; const CHANGE_LOG_INTERVAL_TYPE = 2; public static $changeLogTypeDefs = array(); const CHANGE_LOG_ALL_CATEGORY = 0; const CHANGE_LOG_FUND_MANAGE_BUSINESS_CATEGORY = 1; const CHANGE_LOG_FUND_MANAGE_TAX_CATEGORY = 2; const CHANGE_LOG_FUND_MANAGE_FILING_CATEGORY = 3; const CHANGE_LOG_FUND_MANAGE_REPORT_CATEGORY = 4; const CHANGE_LOG_FUND_MANAGE_FINANCE_REPORT_CATEGORY = 5; const CHANGE_LOG_FUND_MANAGE_VALUATION_REPORT_CATEGORY = 6; public static $changeLogCategoryDefs = array(self::CHANGE_LOG_FUND_MANAGE_BUSINESS_CATEGORY => "\xe5\x9f\xba\xe9\207\221\347\xae\241\xe7\x90\206\55\xe5\267\xa5\345\225\206", self::CHANGE_LOG_FUND_MANAGE_TAX_CATEGORY => "\xe5\237\272\351\207\x91\347\xae\xa1\347\220\206\x2d\347\250\x8e\xe5\x8a\241", self::CHANGE_LOG_FUND_MANAGE_FILING_CATEGORY => "\xe5\237\272\xe9\207\x91\347\xae\xa1\347\x90\x86\x2d\xe5\xa4\x87\xe6\241\x88\xe7\xbb\xb4\xe6\212\244", self::CHANGE_LOG_FUND_MANAGE_REPORT_CATEGORY => "\xe5\x9f\xba\351\x87\221\347\xae\xa1\347\x90\x86\55\346\x8a\245\345\221\x8a", self::CHANGE_LOG_FUND_MANAGE_FINANCE_REPORT_CATEGORY => "\xe5\237\272\xe9\207\x91\347\xae\241\xe7\x90\206\55\xe8\xb4\xa2\345\x8a\xa1\xe6\x8a\245\350\xa1\xa8", self::CHANGE_LOG_FUND_MANAGE_VALUATION_REPORT_CATEGORY => "\xe5\x9f\272\xe9\x87\221\347\256\xa1\xe7\x90\206\x2d\xe4\274\260\345\200\274\346\212\xa5\350\241\250"); public static $changeLogCategoryTypeDefs = array(self::CHANGE_LOG_FUND_MANAGE_BUSINESS_CATEGORY => self::CHANGE_LOG_POINT_TYPE, self::CHANGE_LOG_FUND_MANAGE_TAX_CATEGORY => self::CHANGE_LOG_INTERVAL_TYPE, self::CHANGE_LOG_FUND_MANAGE_FILING_CATEGORY => self::CHANGE_LOG_INTERVAL_TYPE, self::CHANGE_LOG_FUND_MANAGE_REPORT_CATEGORY => self::CHANGE_LOG_INTERVAL_TYPE, self::CHANGE_LOG_FUND_MANAGE_FINANCE_REPORT_CATEGORY => self::CHANGE_LOG_INTERVAL_TYPE, self::CHANGE_LOG_FUND_MANAGE_VALUATION_REPORT_CATEGORY => self::CHANGE_LOG_INTERVAL_TYPE); protected function __construct() { parent::__construct(); } public function load($externalId, $category = \app\index\logic\ChangeLogs::CHANGE_LOG_ALL_CATEGORY, $search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = "\151\144", $order = "\x64\x65\x73\x63") { goto fqdBy; TdGZN: return ["\164\157\164\x61\154" => $totalCount, "\162\x6f\x77\x73" => $records]; goto MHdcM; YJGVK: $order = "\x69\144\x20" . $order; goto RkoXi; rsj_1: if ($sort == "\151\x64") { goto jhFy3; } goto WBnmj; gFwr4: jhFy3: goto YJGVK; StY4E: $conditions = ["\145\x78\164\145\162\x6e\141\154\137\151\x64" => $externalId]; goto wgxw6; EZBFO: $conditions["\143\141\164\145\147\157\x72\171"] = $category; goto LisjX; fqdBy: $limit = ($page - 1) * $rows . "\x2c" . $rows; goto rsj_1; QIH6I: $totalCount = Db::table("\143\150\x61\156\x67\x65\x5f\x6c\x6f\x67\x73")->where($conditions)->count(); goto lHwDQ; lHwDQ: $records = Db::table("\143\150\141\x6e\147\145\137\154\x6f\x67\x73")->where($conditions)->limit($limit)->order($order)->field(true)->select(); goto TdGZN; GtdJ1: goto YV5j3; goto gFwr4; wgxw6: if (!$category) { goto yDUFI; } goto EZBFO; LisjX: yDUFI: goto QIH6I; RkoXi: YV5j3: goto StY4E; WBnmj: $order = "\151\144\x20\x64\x65\x73\143"; goto GtdJ1; MHdcM: } public function add($externalId, $category, $infos) { goto GogEy; ygXRg: Upload::I()->relateAttaches($infos["\x61\164\x74\141\143\150\x65\x73"], $id); goto MvJC_; DZ69n: $model->save(); goto nG3Fk; Yyz8C: return true; goto H0uXg; MvJC_: SMrLn: goto Yyz8C; bebQP: $model->data(["\145\170\x74\x65\x72\x6e\x61\154\137\x69\x64" => $externalId, "\x63\141\x74\145\x67\x6f\162\x79" => $category, "\x63\150\x61\x6e\147\145\137\144\141\x74\x65" => !emptyInArray($infos, "\143\150\141\x6e\x67\145\x5f\x64\141\164\145") ? $infos["\143\150\141\x6e\x67\145\137\x64\141\164\145"] : Defs::DEFAULT_DB_DATE_VALUE, "\x66\x72\157\155\x5f\144\141\x74\x65" => !emptyInArray($infos, "\x66\x72\x6f\x6d\137\x64\x61\164\145") ? $infos["\146\162\x6f\155\137\144\141\164\x65"] : Defs::DEFAULT_DB_DATE_VALUE, "\145\x6e\x64\x5f\x64\141\164\x65" => !emptyInArray($infos, "\x65\x6e\144\137\x64\141\164\145") ? $infos["\145\x6e\144\137\144\141\x74\x65"] : Defs::DEFAULT_DB_DATE_VALUE, "\144\x65\163\x63" => !emptyInArray($infos, "\144\x65\163\143") ? $infos["\x64\145\163\x63"] : '', "\145\x6e\164\145\x72\x65\144" => Db::raw("\156\x6f\167\50\x29")]); goto DZ69n; w_BtU: if (empty($infos["\x61\x74\x74\x61\143\150\145\163"])) { goto SMrLn; } goto ygXRg; GogEy: $model = model("\103\x68\x61\156\x67\145\114\x6f\x67\163"); goto bebQP; nG3Fk: $id = $model->id; goto w_BtU; H0uXg: } public function edit($id, $infos) { goto DiUnM; gJR0r: $model->data(["\x63\x68\x61\x6e\147\145\137\144\x61\164\x65" => !emptyInArray($infos, "\143\150\141\x6e\x67\145\137\x64\141\x74\145") ? $infos["\x63\x68\x61\156\147\145\137\144\x61\x74\x65"] : Defs::DEFAULT_DB_DATE_VALUE, "\x66\x72\157\155\x5f\x64\x61\x74\x65" => !emptyInArray($infos, "\x66\162\x6f\155\x5f\144\141\164\x65") ? $infos["\146\x72\x6f\x6d\137\x64\x61\164\x65"] : Defs::DEFAULT_DB_DATE_VALUE, "\x65\x6e\x64\x5f\x64\141\x74\x65" => !emptyInArray($infos, "\x65\156\x64\137\144\141\x74\x65") ? $infos["\145\156\x64\137\x64\141\164\x65"] : Defs::DEFAULT_DB_DATE_VALUE, "\144\x65\163\x63" => !emptyInArray($infos, "\144\145\x73\x63") ? $infos["\x64\x65\163\143"] : '']); goto eEQW0; yseag: foreach ($attachmentIds as $attachmentId) { $uploadLogic->relateAttaches($attachmentId, $id); cUEPU: } goto pBXv7; eEQW0: $model->save(); goto miGa9; MC8Fg: $attaches = !emptyInArray($infos, "\141\164\164\x61\x63\x68\x65\163") ? $infos["\x61\164\x74\141\143\150\x65\x73"] : ''; goto BgqnY; MIchL: Rd0Sn: goto gJR0r; HJ19y: if ($model) { goto Rd0Sn; } goto x2Sxc; DiUnM: $model = \app\index\model\ChangeLogs::get($id); goto HJ19y; miGa9: $uploadLogic = \app\index\logic\Upload::newObj(); goto MC8Fg; BgqnY: $attachmentIds = explode("\54", $attaches); goto HfCt4; Ma8Te: EeBfW: goto yseag; x2Sxc: return false; goto MIchL; YozeF: return true; goto Ma8Te; HfCt4: if (!empty($attachmentIds)) { goto EeBfW; } goto YozeF; pBXv7: MXW3G: goto hvtnT; hvtnT: return true; goto y12qP; y12qP: } public function delete($id) { goto MeQb7; J1KSJ: $model->delete(); goto s_vsS; Cs16v: if (!$model) { goto DdoUI; } goto J1KSJ; wvb7q: $uploadLogic->deleteAttaches($id, \app\index\logic\Upload::ATTACH_FUND_CHANGE_LOGS); goto xdpuD; s_vsS: DdoUI: goto xITA8; xITA8: $uploadLogic = \app\index\logic\Upload::newObj(); goto wvb7q; MeQb7: $model = \app\index\model\ChangeLogs::get($id); goto Cs16v; xdpuD: return true; goto nmpdJ; nmpdJ: } public function getInfos($id) { goto IXMco; sxVFB: Rd5bW: goto D8w0g; D8w0g: return $infos; goto k7b88; H_IyZ: if ($infos) { goto Rd5bW; } goto Ukn7M; IXMco: $infos = Db::table("\143\x68\141\x6e\x67\145\137\x6c\x6f\147\163")->where("\151\144", $id)->field(true)->find(); goto H_IyZ; Ukn7M: return false; goto sxVFB; k7b88: } }
