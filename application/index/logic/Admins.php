<?php
 namespace app\index\logic; use app\index\model\Setting; use app\index\service\RequestContext; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use think\Url; use app\index\model\Admins as AdminsModel; use app\index\logic\Defs; class Admins extends Base { protected function __construct() { parent::__construct(); } public function load($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = "\141\144\x6d\x69\156\x5f\x69\x64", $order = "\144\145\x73\x63") { goto gzgVT; sfb1t: $records = Db::table("\141\x64\x6d\151\156\x73")->alias("\101")->join("\x61\144\155\151\x6e\x5f\x72\x6f\x6c\145\40\x52", "\101\56\162\157\x6c\x65\137\x69\x64\75\122\56\162\x6f\154\145\x5f\x69\x64", "\114\x45\x46\x54")->where($conditions)->limit($limit)->order($order)->field("\x41\x2e\52\54\x52\56\x72\x6f\154\x65\x5f\156\141\155\x65")->select(); goto WIwS4; SXFTH: wLGrp: goto yVEqk; WIwS4: return ["\164\157\164\141\154" => $totalCount, "\x72\157\167\163" => $records]; goto gAdLx; ZholB: $order = "\x41\56\141\x64\x6d\151\156\137\151\144\40\144\x65\163\x63"; goto gr943; Axntw: D0WDc: goto m9D2k; ncjmt: $totalCount = Db::table("\x61\x64\155\151\x6e\x73")->where($conditions)->count(); goto sfb1t; gzgVT: $limit = ($page - 1) * $rows . "\x2c" . $rows; goto E7iXI; m9D2k: $order = "\101\56\141\x64\x6d\x69\x6e\x5f\x69\x64\40" . $order; goto SXFTH; yVEqk: $conditions = []; goto ncjmt; E7iXI: if ($sort == "\141\x64\x6d\151\x6e\x5f\x69\144") { goto D0WDc; } goto ZholB; gr943: goto wLGrp; goto Axntw; gAdLx: } protected function password($password, $encrypt = '') { goto VyceP; KjTsK: return $encrypt ? $pwd["\x70\141\163\x73\x77\x6f\162\x64"] : $pwd; goto Bsx7x; G3_RS: $pwd["\160\x61\163\163\167\157\x72\144"] = md5(md5(trim($password)) . $pwd["\145\x6e\x63\x72\x79\160\x74"]); goto KjTsK; VyceP: $pwd = array(); goto dvbcH; dvbcH: $pwd["\x65\x6e\x63\162\171\160\x74"] = $encrypt ? $encrypt : \think\helper\Str::random(6); goto G3_RS; Bsx7x: } public function addAdmin($infos) { goto Tbmz4; x03eA: $datas["\x6c\157\147\x69\156\x5f\x70\141\x73\x73\167\x6f\162\x64"] = isset($infos["\x6c\157\147\151\x6e\137\160\x61\x73\x73\167\157\x72\x64"]) ? $infos["\154\x6f\x67\x69\x6e\137\x70\x61\x73\163\167\157\x72\x64"] : ''; goto PDugz; Tbmz4: $adminsModel = new AdminsModel(); goto mzIHj; EqZID: $adminsModel->save($datas); goto fjyvy; tpO2L: $datas["\x73\165\160\x65\x72\x5f\165\x73\145\x72"] = isset($infos["\x73\165\160\145\162\137\165\163\x65\162"]) ? (int) $infos["\x73\165\160\x65\x72\137\165\163\145\162"] : AdminsModel::eAdminCommonRole; goto ElabC; FnjBc: $datas["\x65\x6d\x61\151\x6c"] = isset($infos["\145\155\x61\x69\154"]) ? $infos["\145\155\x61\x69\x6c"] : ''; goto tpO2L; ElabC: $datas["\x64\x69\x73\141\142\154\145\x64"] = isset($infos["\x64\151\163\x61\x62\x6c\x65\x64"]) ? (int) $infos["\144\151\163\x61\x62\x6c\x65\144"] : AdminsModel::eAdminEnableStatus; goto AEDjm; fjyvy: return true; goto Bjytq; v6BfR: $datas["\x72\x6f\154\145\x5f\151\x64"] = isset($infos["\x73\165\x70\145\x72\x5f\165\163\x65\162"]) ? 0 : (int) $infos["\x72\157\154\x65\137\151\x64"]; goto EqZID; vWITg: $datas["\x70\141\163\x73\167\x6f\162\144\x5f\x63\150\141\156\147\145\144"] = date("\131\55\x6d\55\144"); goto jpae6; jpae6: $passwordInfos = $this->password($datas["\154\x6f\147\151\156\137\x70\141\x73\x73\167\157\162\144"]); goto SOokN; Xrq2d: $datas["\154\x6f\x67\x69\x6e\x5f\156\x61\x6d\x65"] = isset($infos["\x6c\157\147\151\156\137\156\141\155\x65"]) ? $infos["\154\157\147\151\156\x5f\x6e\141\x6d\145"] : ''; goto x03eA; AEDjm: $datas["\x63\162\145\x61\x74\145\144"] = date("\131\55\155\55\144\x20\x48\x3a\151\x3a\163"); goto vWITg; SrVhw: $datas["\x6c\x6f\147\151\x6e\137\145\x6e\x63\162\171\x70\x74"] = $passwordInfos["\145\156\143\162\x79\160\x74"]; goto v6BfR; SOokN: $datas["\x6c\157\147\x69\156\137\x70\x61\x73\x73\x77\x6f\162\x64"] = $passwordInfos["\x70\x61\163\x73\x77\x6f\x72\144"]; goto SrVhw; mzIHj: $datas = []; goto Xrq2d; PDugz: $datas["\162\145\141\154\156\141\155\x65"] = isset($infos["\162\145\141\x6c\x6e\x61\155\x65"]) ? $infos["\162\x65\141\x6c\x6e\141\x6d\145"] : ''; goto FnjBc; Bjytq: } public function editAdmin($adminId, $infos) { goto ggAGf; TZ64V: $datas["\145\x6d\x61\151\x6c"] = isset($infos["\x65\x6d\141\x69\x6c"]) ? $infos["\145\155\141\x69\154"] : ''; goto fVkmu; ggAGf: $adminsModel = AdminsModel::get($adminId); goto Su6_u; ymsBN: $datas = []; goto N8_Vl; lA1qV: $datas["\x72\x6f\154\145\137\x69\144"] = isset($infos["\163\x75\x70\145\162\x5f\165\163\x65\x72"]) ? 0 : (int) $infos["\162\x6f\x6c\145\137\151\x64"]; goto fx3kE; CZO4X: $datas["\144\151\x73\141\142\x6c\145\144"] = isset($infos["\144\151\x73\141\142\x6c\x65\x64"]) ? (int) $infos["\144\x69\x73\141\x62\154\x65\x64"] : AdminsModel::eAdminEnableStatus; goto lA1qV; Ilbeb: $adminsModel->save(); goto VYCt8; HPkfm: return false; goto UrCoE; UrCoE: WsQlu: goto ymsBN; bmEFB: $datas["\x73\165\160\145\162\x5f\x75\163\x65\x72"] = isset($infos["\163\165\160\145\162\137\165\x73\x65\162"]) ? (int) $infos["\163\x75\160\x65\x72\x5f\x75\163\x65\162"] : AdminsModel::eAdminCommonRole; goto CZO4X; fVkmu: $datas["\162\145\x61\x6c\156\x61\x6d\145"] = isset($infos["\162\x65\x61\154\156\141\x6d\x65"]) ? $infos["\x72\x65\x61\154\x6e\x61\x6d\145"] : ''; goto bmEFB; VYCt8: return true; goto Nwsce; fx3kE: $adminsModel->data($datas); goto Ilbeb; N8_Vl: $datas["\x6c\157\147\x69\156\137\156\x61\155\x65"] = isset($infos["\x6c\x6f\x67\x69\x6e\x5f\x6e\141\155\145"]) ? $infos["\x6c\157\x67\x69\156\x5f\156\141\x6d\145"] : ''; goto TZ64V; Su6_u: if ($adminsModel) { goto WsQlu; } goto HPkfm; Nwsce: } public function deleteAdmin($adminId) { goto JxakC; YrYum: if ($adminsModel) { goto k24OE; } goto SjAdC; JxakC: $adminsModel = AdminsModel::get($adminId); goto YrYum; zI3Wm: return true; goto yjqXx; jIxSp: $adminsModel->delete(); goto zI3Wm; SjAdC: return false; goto lVP1o; lVP1o: k24OE: goto jIxSp; yjqXx: } public function changeAdminPwd($adminId, $infos) { goto caRqX; rKArA: $datas["\154\x6f\x67\151\156\x5f\x70\141\x73\x73\167\157\x72\144"] = $passwordInfos["\x70\x61\163\163\167\157\162\144"]; goto kCPIu; j8e6D: $passwordInfos = $this->password($newPassword); goto rKArA; B1ywa: $adminsModel->save($datas); goto Um1bH; aYk7p: return false; goto dNyQO; kCPIu: $datas["\154\157\x67\x69\x6e\x5f\x65\x6e\143\162\171\x70\164"] = $passwordInfos["\145\156\x63\x72\x79\x70\x74"]; goto B1ywa; dNyQO: BUFIQ: goto Sn10Q; Sn10Q: $newPassword = isset($infos["\154\157\x67\151\156\x5f\x70\x61\x73\x73\x77\157\x72\144"]) ? $infos["\154\157\x67\151\156\x5f\160\141\x73\x73\167\x6f\x72\144"] : ''; goto bhcQC; Um1bH: return true; goto JmC3b; bhcQC: $datas = []; goto j8e6D; TZKzk: if ($adminsModel) { goto BUFIQ; } goto aYk7p; caRqX: $adminsModel = AdminsModel::get($adminId); goto TZKzk; JmC3b: } public function getAdminInfos($adminId) { $adminsModel = AdminsModel::get($adminId); return $adminsModel; } public function login($username, $password) { goto K4qxU; JDjDU: $loginLogsLogic = \app\index\logic\LoginLogs::newObj(); goto Ltlbs; cVJHE: Session::set("\154\141\x73\164\x6c\157\x67\x69\x6e\151\160", request()->ip()); goto JDjDU; Kx0xn: return false; goto lFUL3; tNcAt: return false; goto c1dvx; jYlxH: if (!($encryptPassword != $adminsModel->login_password)) { goto jBQXj; } goto tNcAt; z6sTa: Session::set("\x75\163\x65\162\x72\157\x6c\x65\151\x64", $adminsModel->role_id); goto v3lN5; K4qxU: $adminsModel = AdminsModel::get(["\x6c\157\147\x69\156\x5f\156\x61\155\145" => $username]); goto DiEAI; frIuF: $encryptPassword = $this->password($password, $adminsModel->login_encrypt); goto jYlxH; v3lN5: Session::set("\x73\x75\160\145\162\x5f\165\x73\x65\x72", $adminsModel->super_user == AdminsModel::eAdminSuperRole); goto cFoeM; gLAy2: if (!($adminsModel->disabled != AdminsModel::eAdminEnableStatus)) { goto Y8YwF; } goto Kx0xn; c1dvx: jBQXj: goto jxo2W; cFoeM: Session::set("\154\x61\x73\164\x6c\157\x67\151\156\164\151\155\x65", time()); goto cVJHE; Ltlbs: $loginLogsLogic->add($adminsModel->login_name, $adminsModel->admin_id, \app\index\logic\LoginLogs::LOGIN_USER_ADMIN_TYPE, truncateString(request()->header("\165\163\x65\x72\x2d\141\x67\x65\156\x74"), 100), request()->ip()); goto yuXJC; yuXJC: return $adminsModel; goto btdPI; lR1lP: return false; goto Rmyhb; lFUL3: Y8YwF: goto frIuF; k3AeI: Session::set("\162\x65\x61\x6c\156\x61\x6d\145", $adminsModel->realname); goto z6sTa; Rmyhb: QVHla: goto gLAy2; qvqgG: Session::set("\165\163\x65\x72\x6e\x61\155\145", $adminsModel->login_name); goto k3AeI; DiEAI: if ($adminsModel) { goto QVHla; } goto lR1lP; jxo2W: Session::set("\165\x73\x65\162\x69\x64", $adminsModel->admin_id); goto qvqgG; btdPI: } public function logout() { Session::clear(); } public function modifyAdminPwd($adminId, $oldPassword, $newPassword) { goto tlcqY; WHOgJ: if ($adminsModel) { goto C_Gkn; } goto QhsGt; SuhEU: $datas["\x6c\x6f\147\x69\x6e\137\x65\156\x63\x72\x79\160\x74"] = $passwordInfos["\x65\x6e\x63\162\x79\x70\x74"]; goto tiUZu; a13rD: $datas = []; goto Ley8V; tlcqY: $adminsModel = AdminsModel::get($adminId); goto WHOgJ; EVYfC: nzxzW: goto a13rD; SImw1: if (!($encryptPassword != $adminsModel->login_password)) { goto nzxzW; } goto HkapI; LK4lg: $datas["\x6c\x6f\147\151\156\x5f\160\141\163\163\167\157\x72\144"] = $passwordInfos["\160\x61\x73\x73\x77\157\162\x64"]; goto SuhEU; KtaaP: $encryptPassword = $this->password($oldPassword, $adminsModel->login_encrypt); goto SImw1; F8YH7: C_Gkn: goto KtaaP; Ley8V: $passwordInfos = $this->password($newPassword); goto LK4lg; HkapI: return false; goto EVYfC; tiUZu: $adminsModel->save($datas); goto UqLV_; UqLV_: return true; goto jx6Xs; QhsGt: return false; goto F8YH7; jx6Xs: } public function getAdminRolePairs() { return Db::table("\x61\x64\x6d\x69\156\x5f\162\x6f\x6c\145")->column("\x72\157\x6c\x65\137\151\144\x2c\x20\162\x6f\154\x65\x5f\156\x61\x6d\x65"); } protected function checkIfSelectedRecursively($id) { goto w_T4g; ML51z: foreach ($subIds as $key => $value) { goto W9vOP; ye9wn: if (!$result) { goto nqd2s; } goto vQGt0; DkwPF: vnJ5i: goto ZaIm8; W9vOP: $subId = $value["\x69\x64"]; goto qL0xP; kwPXj: nqd2s: goto DkwPF; vQGt0: return true; goto kwPXj; qL0xP: $result = $this->checkIfSelectedRecursively($subId); goto ye9wn; ZaIm8: } goto Bo5bB; GQdWS: return true; goto PB3gK; hsFmn: return false; goto mPIOh; OIOqX: qz7h0: goto QjWny; Bo5bB: MBDRD: goto djpKP; mPIOh: lPlLi: goto ML51z; pUOvg: if (!empty($subIds)) { goto lPlLi; } goto hsFmn; QGUcA: return true; goto OIOqX; v6bBC: if (!$roleMenu) { goto qz7h0; } goto QGUcA; w_T4g: if (!RequestContext::I()->loginSuperUser) { goto lQSiI; } goto GQdWS; QjWny: $subIds = db("\x6d\x65\x6e\x75")->where(array("\160\151\144" => $id))->field("\x69\144")->select(); goto pUOvg; djpKP: return false; goto xjIlx; E5NZM: $roleMenu = db("\x61\x64\x6d\151\156\137\162\157\154\x65\137\x6d\x65\156\165")->where(array("\x72\157\x6c\x65\137\151\144" => RequestContext::I()->loginUserRoleId, "\155\x65\156\x75\x5f\151\144" => $id))->find(); goto v6bBC; PB3gK: lQSiI: goto E5NZM; xjIlx: } public function loadLeftMenuRecursively($pid, $ptext, &$nodes) { goto Wt11J; c20C6: foreach ($rows as $key => $value) { goto Ezn2g; FRLRq: $subNodes = array(); goto e0Xxx; cBOEJ: $node["\x6f\162\144\145\162\x5f\x69\x64"] = $value["\157\x72\x64\x65\162\x5f\151\x64"]; goto Bvu2l; MRK90: $node = array(); goto kh925; zM0m4: $node["\160\141\162\x61\x6d\x73"] = $value["\x70\x61\162\141\x6d\163"]; goto cBOEJ; UCSiE: if (empty($subNodes)) { goto bixE8; } goto G2RyA; e0Xxx: $this->loadLeftMenuRecursively($id, $breadcrumb, $subNodes); goto UCSiE; SOw9w: $node["\151\x63\157\156\x43\154\x73"] = $value["\x69\143\x6f\x6e\x5f\x63\154\163"]; goto FRLRq; oSaNK: Dmls5: goto MRK90; Lzy1m: $node["\x63"] = $value["\143"]; goto cmBeq; dex9S: $nodes[] = $node; goto grcrP; cmBeq: $node["\141"] = $value["\141"]; goto zM0m4; G2RyA: $node["\143\x68\x69\154\x64\x72\x65\x6e"] = $subNodes; goto HFQZf; WXYlq: if ($this->checkIfSelectedRecursively($id)) { goto Dmls5; } goto B2qtd; LiqiK: KyDJ0: goto SOw9w; Bvu2l: $breadcrumb = empty($ptext) ? $value["\156\141\x6d\145"] : $ptext . "\x20\46\x67\164\x3b\40" . $value["\156\141\155\145"]; goto tAnbL; B2qtd: goto dVsUJ; goto oSaNK; tAnbL: $node["\x61\x74\164\x72\151\142\165\x74\x65\x73"] = ["\142\x72\145\141\144\x63\162\165\x6d\142" => $breadcrumb]; goto Q2SwB; BNa29: $node["\165\162\154"] = url($value["\155"] . "\57" . $value["\x63"] . "\x2f" . $value["\x61"], $value["\160\141\x72\141\x6d\163"]); goto LiqiK; grcrP: dVsUJ: goto i5kKy; c8uFx: $node["\155"] = $value["\155"]; goto Lzy1m; Ezn2g: $id = $value["\151\144"]; goto WXYlq; kh925: $node["\151\x64"] = $id; goto tiX_m; HFQZf: bixE8: goto dex9S; Q2SwB: if (!(!empty($value["\x6d"]) && !empty($value["\143"]) && !empty($value["\x61"]))) { goto KyDJ0; } goto BNa29; tiX_m: $node["\156\141\155\x65"] = $value["\156\141\155\x65"]; goto jNqU5; jNqU5: $node["\164\145\x78\164"] = $value["\x6e\141\x6d\x65"]; goto c8uFx; i5kKy: } goto Ap7et; Wt11J: $rows = db("\155\145\x6e\165")->where(array("\x70\x69\x64" => $pid))->field("\151\144\x2c\160\151\x64\x2c\154\145\x76\145\154\x2c\156\141\155\x65\x2c\151\143\157\156\x5f\x63\154\163\x2c\x6d\x2c\x63\x2c\x61\54\160\141\162\141\x6d\163\x2c\157\162\144\x65\x72\137\x69\144")->order("\157\162\144\145\162\137\x69\144\40\x41\123\x43")->select(); goto E6uFr; LjaXH: return; goto G5N2o; Ap7et: bFKDd: goto EJRr0; G5N2o: xHOFE: goto c20C6; EJRr0: return; goto Gmczv; E6uFr: if (!empty($rows)) { goto xHOFE; } goto LjaXH; Gmczv: } public function getAdminsByIds($ids) { $admins = AdminsModel::where("\141\144\155\x69\x6e\x5f\x69\x64", "\x69\x6e", $ids)->column("\x61\144\155\x69\156\x5f\x69\144\x2c\x6c\157\x67\x69\x6e\x5f\x6e\141\155\145\54\162\x65\141\154\x6e\141\155\x65\x2c\x65\155\x61\x69\x6c", "\x61\144\155\x69\x6e\x5f\151\144"); return $admins; } public function getAllUsers($index_field = "\x61\x64\155\151\156\137\x69\144") { goto D4B9M; b1Ksw: $users = AdminsModel::column("\141\144\155\x69\x6e\x5f\151\144\x2c\x6c\157\x67\x69\156\x5f\x6e\141\x6d\x65\54\x72\x65\141\154\156\141\x6d\145\x2c\x65\155\x61\151\154", "\x61\x64\x6d\151\156\x5f\x69\x64"); goto lcbus; D4B9M: if ($index_field == "\x61\144\155\x69\156\137\x69\144") { goto ggjdb; } goto vVb5H; qFPAs: goto L2no4; goto dJzoi; dJzoi: ggjdb: goto b1Ksw; vVb5H: $users = AdminsModel::field("\x61\144\155\151\156\x5f\x69\x64\54\x6c\157\x67\x69\156\137\156\x61\x6d\x65\54\162\145\x61\x6c\x6e\x61\155\x65\x2c\145\155\141\x69\x6c")->select(); goto qFPAs; tB4CY: return $users; goto WC8cN; lcbus: L2no4: goto tB4CY; WC8cN: } }
