<?php
 namespace app\index\logic; use app\index\model\Setting; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use app\index\service\RequestContext; use app\index\logic\Defs; use app\common\CommonDefs; use app\index\model\Milestones as MilestonesModel; class ProgressLogs extends Base { const PROGRESS_LOG_ALL_CATEGORY = 0; const PROGRESS_LOG_FUND_MANAGE_CATEGORY = 2; const PROGRESS_LOG_INVESTED_SUPPORT_CATEGORY = 5; const PROGRESS_LOG_INVESTED_ACTIVITY_CATEGORY = 6; const PROGRESS_LOG_PARTNER_CATEGORY = 7; const PROGRESS_LOG_SUB_INDUSTRY = 8; const PROGRESS_LOG_SCIENTIST_CATEGORY = 9; public static $progressLogCategoryDefs = array(self::PROGRESS_LOG_FUND_MANAGE_CATEGORY => "\xe5\x9f\xba\351\207\x91\xe8\277\233\345\261\225\xe4\xba\x8b\xe4\xbb\xb6", self::PROGRESS_LOG_INVESTED_SUPPORT_CATEGORY => "\346\x8a\x95\xe5\x90\216\xe6\224\xaf\xe6\x8c\201", self::PROGRESS_LOG_INVESTED_ACTIVITY_CATEGORY => "\xe5\205\xac\xe5\x8f\xb8\345\x8a\250\xe6\x80\201", self::PROGRESS_LOG_PARTNER_CATEGORY => "\345\220\x88\xe4\274\231\xe4\272\272\xe8\277\x9b\xe5\261\225", self::PROGRESS_LOG_SUB_INDUSTRY => "\xe5\xad\x90\350\xa1\214\344\xb8\232\347\xa0\x94\347\xa9\xb6", self::PROGRESS_LOG_SCIENTIST_CATEGORY => "\347\247\x91\345\xad\xa6\xe5\xae\xb6\xe4\xba\213\xe4\273\266"); public static $subtypes = array(1 => array("\156\141\155\145" => "\xe8\x82\241\xe4\xb8\234\xe4\274\x9a\345\206\xb3\xe8\xae\256", "\x63\x61\164\145\x67\157\x72\x79" => self::PROGRESS_LOG_INVESTED_ACTIVITY_CATEGORY), 2 => array("\156\141\155\x65" => "\350\221\xa3\344\xba\213\344\xbc\232\xe5\x86\xb3\350\256\xae", "\x63\141\164\145\147\x6f\x72\171" => self::PROGRESS_LOG_INVESTED_ACTIVITY_CATEGORY), 3 => array("\156\141\155\145" => "\102\162\x69\x64\147\x65\x4f\156\x65\40\124\x61\154\x6b", "\143\x61\164\145\147\x6f\162\x79" => self::PROGRESS_LOG_SCIENTIST_CATEGORY), 4 => array("\156\141\x6d\x65" => "\346\212\225\xe5\220\216\347\256\xa1\xe7\220\x86", "\143\x61\164\145\x67\x6f\162\171" => self::PROGRESS_LOG_SCIENTIST_CATEGORY)); protected function __construct() { parent::__construct(); } public function load($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = "\160\x72\x6f\x67\x72\x65\163\163\x5f\154\x6f\147\x5f\x69\144", $order = "\x64\145\x73\143", $category = self::PROGRESS_LOG_ALL_CATEGORY, $externalId = 0) { goto Mw4mR; e54rA: Q8ikF: goto GkbG2; xdnP9: $admins = Db::table("\x61\144\155\x69\156\x73")->where("\141\144\x6d\151\156\137\x69\144", "\151\x6e", $admin_ids)->column("\162\145\141\154\156\141\155\145", "\x61\x64\x6d\x69\156\x5f\x69\144"); goto NygFN; ZacKo: $contacts = Db::table("\143\157\156\x74\141\x63\x74\x73")->where("\151\144", "\x69\x6e", $contact_ids)->column("\x6e\141\x6d\x65", "\151\x64"); goto xdnP9; HfQgP: e3z1N: goto lf1q1; k7G6e: foreach ($records as $v) { goto MmZt6; xnWCm: JCraj: goto gmrE3; MmZt6: $admin_ids[$v["\141\x64\155\x69\x6e\137\x69\144"]] = $v["\141\144\x6d\151\156\137\151\x64"]; goto EAVYJ; EAVYJ: $contact_ids[$v["\143\157\156\164\141\143\164\x5f\x69\144"]] = $v["\x63\x6f\x6e\x74\141\x63\164\137\x69\144"]; goto xnWCm; gmrE3: } goto jYFqf; NygFN: foreach ($records as $k => $v) { goto t4nQD; t4nQD: if ($v["\x63\157\156\164\141\x63\164\x5f\151\144"]) { goto oDUPV; } goto XtFAc; XtFAc: $records[$k]["\162\145\141\x6c\x6e\x61\155\x65"] = $admins[$v["\x61\144\155\151\156\137\151\144"]]; goto Jr5Sh; bzrWX: JqBJ6: goto ukDWa; Jr5Sh: goto n55nu; goto VyZmW; Qbwjk: $records[$k]["\x72\x65\x61\154\x6e\x61\x6d\x65"] = $contacts[$v["\x63\157\x6e\164\141\x63\164\137\x69\144"]] . "\xef\274\x88\xe9\xa1\271\xe7\x9b\xae\346\x96\xb9\357\274\x89"; goto mkq5T; VyZmW: oDUPV: goto Qbwjk; mkq5T: n55nu: goto bzrWX; ukDWa: } goto cnhfI; lf1q1: $order = "\x70\162\x6f\x67\162\145\163\163\x5f\x6c\157\x67\137\151\x64\40" . $order; goto S1b41; twpcf: $conditions = ["\145\x78\x74\x65\x72\x6e\141\x6c\137\151\144" => $externalId]; goto Xxj2d; S1b41: gNfMe: goto twpcf; cq8ns: $admin_ids = []; goto NV8EQ; cnhfI: kp8iv: goto SJTvh; HTUMn: pREyh: goto PMOu4; jYFqf: hzUyY: goto ZacKo; ClIVV: if ($sort == "\160\162\x6f\x67\x72\145\163\163\x5f\x6c\x6f\147\x5f\151\144") { goto e3z1N; } goto KegYG; NV8EQ: $contact_ids = []; goto k7G6e; LgsZx: $conditions["\143\157\156\x74\141\x63\164\x5f\151\144"] = $p_user["\x69\144"]; goto zdDZc; i9lgR: $totalCount = Db::table("\160\x72\x6f\147\x72\x65\163\163\x5f\154\157\x67\x73")->where($conditions)->count(); goto cT2VA; ai2dy: $p_user = \app\p\service\User::I()->getLoginUser(); goto LgsZx; WbEyy: $conditions["\x63\x61\164\x65\x67\x6f\x72\171"] = $category; goto e54rA; Mw4mR: $limit = ($page - 1) * $rows . "\54" . $rows; goto ClIVV; KegYG: $order = "\x70\162\x6f\x67\162\145\x73\x73\x5f\154\157\x67\x5f\151\x64\40\x64\145\163\143"; goto Lnj11; GkbG2: if (empty($search["\x65\156\164\145\x72\x65\144"])) { goto pREyh; } goto Hfqzs; SJTvh: return ["\x74\157\x74\x61\154" => $totalCount, "\162\x6f\167\163" => $records]; goto uFv7a; Hfqzs: $conditions["\157\143\143\165\162\137\x64\141\164\145"] = $search["\145\x6e\164\x65\162\x65\x64"]; goto HTUMn; zdDZc: lo_5q: goto i9lgR; PMOu4: if (!($search["\x73\162\143"] == CommonDefs::MODULE_PROJECT)) { goto lo_5q; } goto ai2dy; Xxj2d: if (!$category) { goto Q8ikF; } goto WbEyy; Lnj11: goto gNfMe; goto HfQgP; cT2VA: $records = Db::table("\x70\162\x6f\x67\x72\x65\x73\163\x5f\154\x6f\147\163")->where($conditions)->limit($limit)->order($order)->select(); goto cq8ns; uFv7a: } public function get($id) { goto bVF4Z; PuNem: pjm5L: goto lkXEV; lkXEV: $row["\x65\170\164\x72\x61\163"] = empty($row["\x65\170\164\162\x61\x73"]) ? null : json_decode($row["\x65\170\164\162\x61\x73"], true); goto aVDQU; bVF4Z: $row = Db::table("\160\162\x6f\147\162\145\x73\163\137\154\x6f\x67\x73")->where("\x70\162\157\x67\x72\145\163\163\137\154\157\147\x5f\x69\144", $id)->find(); goto z8gJx; z8gJx: if (!empty($row)) { goto pjm5L; } goto sPFx8; aVDQU: return $row; goto ueTma; sPFx8: return []; goto PuNem; ueTma: } public function add($category, $externalId, $infos) { goto LPeZp; SxxnX: EuzPT: goto IlflD; Qu1ZN: Upload::I()->relateAttaches($infos["\141\164\164\x61\143\x68\x65\x73"], $newProgressLogId); goto l7pOS; EGP1l: $datas["\145\156\x74\x65\x72\x65\x64"] = date("\x59\x2d\x6d\x2d\x64\40\110\72\151\x3a\x73"); goto BWRjE; lWI3b: $datas["\163\x75\x62\x74\171\160\145"] = intval($infos["\x73\x75\142\164\x79\x70\x65"] ?? "\x30"); goto uFcTM; TsTEt: $datas["\164\x69\164\x6c\x65"] = !emptyInArray($infos, "\164\x69\x74\x6c\145") ? $infos["\x74\151\x74\x6c\x65"] : ''; goto LRBJh; uFcTM: $datas["\145\170\x74\145\162\x6e\x61\x6c\x5f\x69\x64"] = $externalId; goto lFV1J; jn4qT: $newProgressLogId = Db::table("\160\x72\157\147\x72\x65\163\x73\137\154\x6f\x67\x73")->insertGetId($datas); goto PKEwL; LPeZp: $datas = []; goto YMXOI; IlflD: $p_user = \app\p\service\User::I()->getLoginUser(); goto yfGV1; ujY7L: $datas["\141\144\x6d\x69\x6e\137\151\x64"] = intval(RequestContext::I()->loginUserId); goto zY3sV; HE0h7: Milestones::I()->save(MilestonesModel::MILESTONE_FUND_CATEGORY, $externalId, $datas["\x6f\x63\143\165\162\137\x64\x61\x74\x65"], $datas["\x74\151\x74\x6c\x65"]); goto q23lR; q23lR: Qtxuh: goto jn4qT; PKEwL: if (!$infos["\x61\164\164\141\x63\150\145\x73"]) { goto dpi8C; } goto Qu1ZN; Gcp0Q: R0N8o: goto iHKxO; cZ6qV: if (emptyInArray($infos, "\163\x68\157\167\137\164\x69\155\x65\154\151\x6e\145")) { goto ltleh; } goto pGkrg; zY3sV: goto R0N8o; goto SxxnX; iHKxO: $datas["\163\x68\157\x77\x5f\x74\x69\x6d\145\x6c\x69\156\145"] = 0; goto cZ6qV; ILWrT: if (!$datas["\x73\150\x6f\167\x5f\164\x69\x6d\145\x6c\x69\156\145"]) { goto Qtxuh; } goto HE0h7; HRLur: return true; goto ivP5F; USgCw: ltleh: goto ILWrT; YMXOI: $datas["\x63\x61\164\145\147\x6f\x72\x79"] = $category; goto lWI3b; lFV1J: $datas["\157\x63\143\165\162\137\144\141\164\x65"] = !emptyInArray($infos, "\x6f\143\143\165\x72\x5f\144\x61\164\x65") ? $infos["\x6f\x63\x63\x75\x72\137\144\141\164\x65"] : Defs::DEFAULT_DB_DATE_VALUE; goto TsTEt; BWRjE: if ($infos["\163\x72\143"] == CommonDefs::MODULE_PROJECT) { goto EuzPT; } goto ujY7L; yfGV1: $datas["\x63\157\156\164\x61\143\164\137\151\x64"] = intval($p_user["\151\x64"]); goto Gcp0Q; pGkrg: $datas["\x73\150\157\167\137\164\151\x6d\x65\x6c\x69\156\x65"] = intval($infos["\x73\x68\x6f\167\137\164\151\x6d\x65\154\x69\x6e\145"]); goto USgCw; l7pOS: dpi8C: goto HRLur; LRBJh: $datas["\x65\156\x74\x72\x79"] = !emptyInArray($infos, "\145\x6e\164\162\171") ? $infos["\145\156\x74\x72\171"] : ''; goto EGP1l; ivP5F: } public function delete($progressLogId) { goto i_ZsA; oWRyM: $result = Db::table("\x70\x72\x6f\147\162\145\x73\x73\x5f\154\157\147\163")->where("\160\x72\157\x67\162\145\x73\163\x5f\154\157\x67\137\x69\x64", $progressLogId)->delete(); goto uGVjZ; uGVjZ: return $result > 0 ? true : false; goto sjPWf; i_ZsA: Upload::I()->deleteAttaches($progressLogId, Upload::ATTACH_PROGRESS_LOGS); goto oWRyM; sjPWf: } }
