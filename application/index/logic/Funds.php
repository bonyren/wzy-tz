<?php
 namespace app\index\logic; use app\index\model\Setting; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use app\index\logic\Defs; use app\index\service\EventLogs; use app\index\model\Funds as FundsModel; class Funds extends Base { const FUND_ALL_STATUS = 0; const FUND_COLLECT_STATUS = 1; const FUND_INVEST_STATUS = 2; const FUND_MANAGE_STATUS = 3; const FUND_EXIT_STATUS = 4; public static $fundStatusDefs = array(self::FUND_COLLECT_STATUS => "\345\213\x9f\351\233\x86\xe4\xb8\255", self::FUND_INVEST_STATUS => "\xe6\x8a\225\350\265\x84\344\xb8\255", self::FUND_MANAGE_STATUS => "\347\256\xa1\347\220\206\344\270\xad", self::FUND_EXIT_STATUS => "\xe5\xb7\262\346\xb3\xa8\351\x94\200"); public static $fundStatusHtmlDefs = array(self::FUND_COLLECT_STATUS => "\74\163\160\x61\156\x20\143\154\x61\x73\163\x3d\x22\x62\141\144\147\x65\40\142\x61\144\147\145\x2d\x70\x72\x69\155\141\162\x79\42\x3e\345\213\237\351\x9b\x86\344\xb8\xad\x3c\x2f\163\160\141\x6e\76", self::FUND_INVEST_STATUS => "\x3c\163\x70\141\x6e\40\x63\154\141\x73\x73\75\42\142\x61\x64\x67\145\40\142\x61\x64\x67\x65\55\x73\145\143\157\156\144\x61\x72\x79\42\76\xe6\212\225\350\xb5\204\xe4\270\255\x3c\x2f\x73\x70\x61\x6e\76", self::FUND_MANAGE_STATUS => "\74\x73\x70\141\156\x20\143\154\141\163\x73\75\x22\142\x61\144\147\145\x20\142\x61\x64\147\x65\x2d\x73\x75\143\x63\145\163\x73\42\x3e\xe7\256\xa1\347\x90\206\344\xb8\xad\74\57\163\x70\x61\x6e\76", self::FUND_EXIT_STATUS => "\74\x73\x70\141\x6e\x20\x63\x6c\x61\x73\x73\x3d\42\x62\x61\x64\x67\145\40\x62\141\x64\x67\145\55\x64\x65\x66\141\x75\x6c\x74\x22\x3e\345\267\xb2\xe6\263\250\351\x94\x80\x3c\x2f\x73\x70\141\156\x3e"); protected function __construct() { parent::__construct(); } public function load($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = "\x66\165\x6e\x64\x5f\x69\144", $order = "\x61\163\x63", $status = \app\index\logic\Funds::FUND_ALL_STATUS) { goto wTxbK; Z6AsT: return []; goto OhdAy; hK6NY: cLYk2: goto t21Wv; Wor33: $clone = clone $model; goto Is3rN; DvoK2: mlw_Q: goto jCo5c; gUl91: $model->join("\x66\x75\156\x64\163\137\x70\x61\162\x74\x6e\145\162\x73\40\x66\160", "\x66\x2e\146\165\156\144\x5f\151\x64\x3d\146\160\56\146\165\156\x64\x5f\x69\x64"); goto jWCM1; OhdAy: d1Zx0: goto f0kiJ; KsGr9: foreach ($records as &$record) { goto Vsfbs; AwxQo: JfLfm: goto xwmYg; xeidV: $record["\x61\143\x74\x75\141\x6c\x5f\160\x61\151\144\x5f\163\151\x7a\145"] = $actualPaidAmount; goto FYn1E; bQwpL: if ($progressLog) { goto F8_lx; } goto JEy18; oxC27: $size = $record["\163\x69\172\x65"]; goto fRhA4; zKdDm: if (!($status == self::FUND_INVEST_STATUS || $status == self::FUND_MANAGE_STATUS || $status == self::FUND_ALL_STATUS)) { goto vVmEy; } goto R8mS4; R8mS4: $size = $record["\163\x69\x7a\145"]; goto vslyh; fRhA4: if ((float) $size) { goto ULN02; } goto rDQmp; Vsfbs: $fundId = $record["\146\x75\x6e\x64\137\x69\x64"]; goto moLAY; Mwqc_: $record["\x70\162\157\147\x72\145\x73\163\x5f\x6c\157\x67"] = $progressLog["\x74\151\x74\x6c\145"] . "\40\x3c\163\160\x61\x6e\x20\143\x6c\x61\x73\x73\x3d\42\154\x61\142\145\x6c\40\154\141\x62\145\x6c\x2d\x70\162\x69\x6d\141\x72\171\42\x3e" . $progressLog["\x72\x65\141\154\156\x61\155\x65"] . "\74\57\x73\160\x61\x6e\76\x20\55\40\x3c\x73\x70\141\x6e\40\x63\154\x61\163\163\x3d\42\x62\x61\144\147\x65\40\x62\141\144\x67\x65\55\163\145\143\x6f\x6e\144\x61\x72\171\x22\x3e" . $progressLog["\x65\x6e\164\145\162\x65\144"] . "\74\x2f\163\160\141\x6e\x3e"; goto UNys_; FYn1E: if (!($status == self::FUND_COLLECT_STATUS || $status == self::FUND_ALL_STATUS)) { goto NLI03; } goto Swa1x; lmJ3V: uHsFU: goto xeidV; nsuY7: F8_lx: goto Mwqc_; bl0Vo: if ($finishSize) { goto GC5tH; } goto DLGJR; dqslk: h4nru: goto MGeux; JEy18: $record["\160\162\x6f\147\x72\145\x73\x73\x5f\x6c\157\x67"] = "\55"; goto FqFpl; vslyh: $finishSize = Db::table("\146\x75\156\144\163\137\145\156\164\x65\162\160\x72\151\x73\x65\x73")->alias("\106\105")->join("\x66\165\x6e\x64\x73\x5f\146\151\x6e\x61\156\143\145\137\145\x6e\x74\145\x72\160\x72\x69\x73\x65\163\x20\106\106\x45", "\x46\x45\56\146\x66\x65\x5f\x69\x64\x3d\x46\x46\105\x2e\x66\146\x65\x5f\151\144")->where(["\x46\x45\x2e\146\165\x6e\x64\137\x69\144" => $record["\x66\x75\156\144\x5f\151\x64"]])->sum("\106\106\105\x2e\141\x6d\157\165\x6e\164"); goto bl0Vo; cnsze: if ($actualPaidAmount) { goto uHsFU; } goto b0Xyw; x1hPM: SsITC: goto k86jI; jGa4I: $record["\x63\x6f\x6c\x6c\145\x63\x74\137\160\x72\x6f\147\162\x65\x73\163\137\x76\x61\x6c\x75\x65"] = round($actualSize / $size * 100); goto AwxQo; gGkr0: $record["\x69\156\166\x65\163\164\137\163\151\172\145"] = $finishSize; goto iPByV; mU19Z: GC5tH: goto rddvh; iPByV: vVmEy: goto cR1yR; b0Xyw: $actualPaidAmount = 0.0; goto lmJ3V; ftRNy: $actualSize = 0.0; goto dqslk; FqFpl: goto eTbiE; goto nsuY7; rDQmp: $record["\143\x6f\x6c\x6c\145\143\164\x5f\160\x72\x6f\147\x72\145\x73\x73\137\166\x61\154\x75\x65"] = 0; goto rkH7c; TcjNu: if (!($actualSize === null)) { goto h4nru; } goto ftRNy; k86jI: $record["\151\156\166\x65\163\164\x5f\160\x72\157\x67\162\x65\163\x73\x5f\166\141\154\165\145"] = round($finishSize / $size * 100); goto E7J2V; Swa1x: $progressLog = Db::table("\160\x72\157\x67\162\x65\163\x73\x5f\154\x6f\147\163")->alias("\x50")->join("\141\144\x6d\151\x6e\163\x20\x41", "\x50\x2e\141\x64\x6d\151\x6e\x5f\x69\144\75\101\56\x61\144\155\x69\x6e\x5f\151\x64", "\x4c\105\x46\x54")->where(["\120\56\145\170\x74\x65\162\156\x61\x6c\x5f\x69\x64" => $fundId, "\120\x2e\x63\141\164\145\x67\x6f\162\171" => \app\index\logic\ProgressLogs::PROGRESS_LOG_FUND_MANAGE_CATEGORY])->order("\120\56\155\157\144\151\146\x69\145\x64\x20\144\145\163\x63")->field("\120\x2e\164\151\x74\154\x65\x2c\40\120\x2e\x65\156\x74\162\x79\x2c\x20\120\x2e\x65\x6e\x74\145\162\145\144\x2c\x20\101\56\x72\145\141\x6c\156\141\x6d\145")->find(); goto bQwpL; MGeux: $record["\x61\x63\164\x75\x61\154\137\x73\151\172\x65"] = $actualSize; goto KF5ND; OIPZ3: goto r229C; goto x1hPM; DLGJR: $finishSize = 0; goto mU19Z; MN7KU: $record["\151\156\166\x65\x73\164\137\x70\162\157\x67\162\145\163\x73\x5f\x76\141\x6c\x75\x65"] = 0; goto OIPZ3; V6O0i: ULN02: goto jGa4I; xwmYg: NLI03: goto zKdDm; rddvh: if ((float) $size) { goto SsITC; } goto MN7KU; E7J2V: r229C: goto gGkr0; KF5ND: $actualPaidAmount = Db::table("\146\x75\156\144\x73\x5f\146\151\156\x61\156\143\x65\137\143\x6f\156\x74\162\151\x62\x75\x74\x65\x73")->where("\146\x66\143\x5f\x69\144", "\151\156", function ($query) use($fundId) { $query->table("\146\165\x6e\x64\x73\x5f\x70\x61\x72\164\x6e\x65\x72\163\x5f\160\x61\x69\144")->alias("\x46\120\120")->join("\146\165\156\144\163\137\x70\141\162\x74\156\x65\x72\x73\40\106\x50", "\106\x50\x50\56\146\x70\137\151\x64\75\x46\120\56\146\160\x5f\x69\x64")->where("\106\x50\x2e\146\x75\156\144\137\x69\144", $fundId)->field("\x46\x50\120\x2e\146\x66\x63\x5f\x69\144"); })->sum("\x61\155\x6f\165\x6e\164"); goto cnsze; moLAY: $actualSize = Db::table("\146\165\156\144\x73\x5f\x70\x61\162\164\x6e\x65\162\x73")->where("\x66\165\x6e\x64\137\x69\144", $fundId)->sum("\x61\155\x6f\165\x6e\164"); goto TcjNu; UNys_: eTbiE: goto oxC27; rkH7c: goto JfLfm; goto V6O0i; cR1yR: Xb_QH: goto bgKtB; bgKtB: } goto FRk1d; Is3rN: $totalCount = $model->count(); goto VNSON; j28RD: $conditions = []; goto RyP2d; qv8Zt: if (!(isset($search["\x70\137\151\x64"]) && $search["\160\137\x69\144"])) { goto cLYk2; } goto gUl91; jWCM1: $conditions["\x66\x70\x2e\160\137\x69\144"] = $search["\160\x5f\x69\144"]; goto hK6NY; sGIxg: $order = "\x66\56\146\x75\x6e\144\x5f\x69\144\x20\x61\x73\x63"; goto UC1g0; wTxbK: $model = Db::table("\x66\165\x6e\x64\163")->alias("\x66"); goto yK1vr; u7kDg: return ["\164\x6f\x74\x61\x6c" => $totalCount, "\x72\x6f\x77\163" => $records]; goto cF2pi; UC1g0: goto UZ0yb; goto DvoK2; q66sq: UZ0yb: goto j28RD; yK1vr: if ($sort == "\x66\165\156\144\137\151\144") { goto mlw_Q; } goto sGIxg; ajIAK: $conditions["\x66\x2e\x73\x74\x61\x74\x75\x73"] = $status; goto v1s3h; LCJa5: $conditions["\x66\x2e\x6e\141\x6d\x65"] = ["\x6c\151\x6b\145", "\45" . $search["\156\x61\x6d\x65"] . "\x25"]; goto iMFSE; dRQ98: if (!$status) { goto S68Ib; } goto ajIAK; VNSON: if (!empty($totalCount)) { goto d1Zx0; } goto Z6AsT; RyP2d: if (emptyInArray($search, "\x6e\x61\155\x65")) { goto rlyu2; } goto LCJa5; FRk1d: fiIUQ: goto u7kDg; t21Wv: $model->where($conditions); goto Wor33; jCo5c: $order = "\146\x2e\146\165\156\144\x5f\x69\x64\40" . $order; goto q66sq; f0kiJ: $records = $clone->page($page, $rows)->order($order)->field("\x66\x2e\52")->select(); goto KsGr9; v1s3h: S68Ib: goto qv8Zt; iMFSE: rlyu2: goto dRQ98; cF2pi: } public function addFund($infos) { goto Y0mb_; WUX0z: $fundsModel->save($infos); goto pjlqQ; Y0mb_: $fundsModel = model("\x46\165\156\144\x73"); goto WUX0z; fxiLk: EventLogs::recordFund($newFundId, "\346\226\xb0\345\xa2\236"); goto jlgXw; pjlqQ: $newFundId = $fundsModel->fund_id; goto fxiLk; jlgXw: } public function editFund($fundId, $infos) { goto aM6vN; npIpk: wexception("\xe6\x97\xa0\346\263\225\346\211\276\345\x88\xb0\350\257\xa5\345\237\xba\351\x87\x91"); goto O8feY; QkqK2: if ($fundsModel) { goto MGDeD; } goto npIpk; O8feY: MGDeD: goto SnMQP; p5C11: EventLogs::recordFund($fundId, "\344\277\xae\xe6\x94\xb9"); goto z1pr2; aM6vN: $fundsModel = FundsModel::get($fundId); goto QkqK2; SnMQP: $fundsModel->save($infos); goto p5C11; z1pr2: } public function deleteFund($fundId) { goto y26L4; DATuv: if ($fundsModel) { goto ZsNzi; } goto BAX3N; eYEQt: $fundsModel->delete(); goto n_Gh0; BZBnq: goto q5aic; goto DdZ1q; BAX3N: wexception("\xe6\x97\240\xe6\xb3\225\xe6\x89\xbe\345\x88\260\350\xaf\xa5\xe5\x9f\272\351\207\221"); goto BZBnq; y26L4: $fundsModel = \app\index\model\Funds::get($fundId); goto DATuv; DdZ1q: ZsNzi: goto eYEQt; n_Gh0: q5aic: goto kbNS3; kbNS3: } public function getFundInfos($fundId) { goto psiZB; A27Iy: XqpSa: goto NhRt4; zhVrQ: $actualSize = 0.0; goto toyNn; psiZB: $infos = Db::table("\146\x75\156\x64\x73")->where("\x66\x75\x6e\x64\137\151\144", $fundId)->field(true)->find(); goto gL6Kb; NhRt4: $actualSize = Db::table("\146\165\156\x64\x73\x5f\x70\141\162\x74\156\x65\162\163")->where("\146\165\x6e\144\137\151\x64", $fundId)->sum("\141\x6d\157\165\156\164"); goto svoOG; gL6Kb: if ($infos) { goto XqpSa; } goto MSHbD; svoOG: if (!($actualSize === null)) { goto sRovn; } goto zhVrQ; MSHbD: return false; goto A27Iy; hcirl: $infos["\x61\143\164\165\141\154\137\x73\151\172\x65"] = $actualSize; goto mHa4X; mHa4X: return $infos; goto fwULg; toyNn: sRovn: goto hcirl; fwULg: } public function changeStatus($fundId, $fromStatus, $toStatus) { Db::table("\x66\x75\x6e\144\x73")->where("\146\165\x6e\144\x5f\x69\x64", $fundId)->update(["\x73\164\x61\164\165\x73" => $toStatus]); return true; } }
