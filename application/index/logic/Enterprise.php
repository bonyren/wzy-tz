<?php
 namespace app\index\logic; use app\index\model\Attachments; use app\index\model\Edividends; use app\index\model\EFounders; use app\index\model\FundsEnterprises; use app\index\model\FundsFinanceIncomes; use app\index\model\Enterprises; use app\index\model\FundsFinanceTaxes; use think\Db; use app\index\service\EventLogs; class Enterprise extends Base { const MODULE = "\105\x6e\x74\145\x72\160\x72\151\163\x65\x73"; const STEP_TOUCH = 1; const STEP_LEARN = 2; const STEP_DD = 3; const STEP_INVESTING = 4; const STEP_POST_INVESTED = 5; const STEP_EXIT = 6; const STEPS = array(self::STEP_TOUCH => "\xe6\216\245\xe8\247\246", self::STEP_LEARN => "\xe4\272\206\xe8\xa7\243\xe5\210\206\346\236\220", self::STEP_DD => "\xe5\260\xbd\350\xb0\203\xe4\xb8\255", self::STEP_INVESTING => "\xe6\x8a\x95\xe8\xb5\x84\xe4\270\xad", self::STEP_POST_INVESTED => "\346\x8a\x95\xe5\220\x8e\xe7\xae\241\xe7\x90\x86", self::STEP_EXIT => "\345\267\xb2\351\200\x80\345\x87\272"); const STEPS_HTML = array(self::STEP_TOUCH => "\x3c\x73\160\141\x6e\x20\143\x6c\141\163\x73\75\42\142\x61\x64\147\x65\x20\x62\141\144\x67\145\x2d\x6c\151\147\x68\164\42\x3e\346\x8e\245\350\xa7\246\x3c\x2f\x73\160\x61\156\x3e", self::STEP_LEARN => "\74\x73\160\x61\156\40\x63\x6c\141\x73\163\75\x22\142\x61\144\x67\x65\x20\x62\x61\144\147\145\x2d\x73\x65\x63\x6f\156\144\141\162\171\42\76\xe4\xba\206\350\xa7\243\345\x88\x86\346\236\x90\74\x2f\163\x70\x61\156\x3e", self::STEP_DD => "\74\x73\160\x61\156\40\143\154\x61\x73\x73\75\42\142\141\x64\147\145\x20\x62\x61\144\x67\x65\x2d\160\x72\151\x6d\x61\x72\171\x22\x3e\xe5\xb0\xbd\350\xb0\x83\xe4\270\xad\74\57\x73\160\x61\x6e\76", self::STEP_INVESTING => "\x3c\x73\160\141\x6e\40\x63\x6c\x61\163\163\75\x22\x62\x61\x64\147\x65\40\142\x61\x64\x67\145\x2d\151\x6e\146\x6f\42\76\346\212\x95\xe8\xb5\x84\344\270\xad\x3c\x2f\163\x70\x61\156\76", self::STEP_POST_INVESTED => "\x3c\x73\160\x61\x6e\x20\x63\x6c\x61\x73\163\75\x22\142\141\144\147\145\40\x62\x61\144\147\x65\55\163\165\143\x63\x65\163\163\42\76\346\212\225\xe5\x90\x8e\347\xae\241\xe7\x90\206\x3c\x2f\x73\160\x61\156\x3e", self::STEP_EXIT => "\x3c\x73\x70\x61\x6e\40\x63\154\x61\163\x73\75\x22\x62\x61\144\x67\x65\x20\142\x61\144\x67\x65\x2d\167\x61\x72\x6e\151\x6e\147\42\76\345\267\xb2\351\x80\200\345\207\272\x3c\57\x73\160\141\x6e\76"); private $enterprise_model; protected function __construct() { $this->enterprise_model = new Enterprises(); } public function load($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $params = array()) { goto UFv48; rezcT: $where = array_merge($params["\167\x68\x65\162\145"], $where); goto ejzd8; fIQie: if (empty($search["\163\164\145\x70\137\x73\164\x61\164\145"])) { goto XlZNk; } goto h0kPy; r12rA: $order = "\151\x73\164\157\x70\40\144\x65\163\x63\x2c\x69\x64\40\144\145\x73\143"; goto wG3nZ; OVaWV: XlZNk: goto hKsiq; NJ3px: $model->where($where); goto PKXXD; HWX4V: $where["\x65\56\x73\164\145\x70"] = $search["\x73\x74\145\x70"]; goto b66dS; fYqhr: jW2qC: goto OZHv3; PKXXD: $clone = clone $model; goto tW_tN; KHKp6: ytlsI: goto r12rA; tW_tN: $count = $model->count(); goto hjl8T; hKsiq: if (empty($search["\x6e\x61\x6d\x65"])) { goto jW2qC; } goto g4xdU; OZHv3: if (empty($search["\x6d\x69\x6e\x65"])) { goto IIvFq; } goto gQen2; UFv48: $model = Db::table("\145\156\x74\x65\x72\x70\162\x69\163\x65\x73")->alias("\x65"); goto cVflG; ejzd8: J7drE: goto GUwF5; wG3nZ: $items = $clone->page($page, $rows)->order($order)->field("\145\56\151\144\54\x65\56\x64\x61\164\145\137\x63\x72\145\x61\x74\x65\x64\x2c\x65\56\x73\x74\145\160\54\x65\x2e\x73\164\x65\x70\137\x73\x74\141\164\x65\x2c\x65\56\x66\x6f\x75\156\x64\145\x72\x2c\x65\56\x6e\x61\155\x65\54\x65\56\141\x6c\151\x61\163\x2c\x65\56\x64\145\163\143\162\151\160\164\x69\157\x6e\x2c\x65\56\x61\163\x73\151\147\156\x65\162\x2c\x65\56\x61\x64\x64\x69\164\151\157\x6e\141\154\137\141\163\x73\x69\x67\x6e\145\162\x73")->select(); goto AWe60; b66dS: cH_C9: goto fIQie; cVflG: $where = ["\x65\56\144\x65\154\145\x74\145\x64" => 0]; goto gmYto; AWe60: return ["\164\157\164\141\154" => $count, "\162\x6f\x77\163" => $items]; goto I5Obk; hjl8T: if (!empty($count)) { goto ytlsI; } goto cQFGU; gmYto: if (empty($params["\x77\x68\145\162\x65"])) { goto J7drE; } goto rezcT; GA1Ba: $where["\x65\56\163\x63\x69\145\x6e\164\x69\163\x74\x5f\x69\144"] = $search["\163\143\151\x65\156\x74\x69\163\164\x5f\x69\x64"]; goto r7u3y; dMGMq: $model->join("\165\x73\145\x72\163\x5f\162\x65\x63\157\x72\x64\163\40\x72", "\x65\56\151\144\75\162\56\162\145\x63\x6f\x72\x64\x5f\x69\x64"); goto tvqos; tvqos: IIvFq: goto Zoxg3; r7u3y: A1F50: goto NJ3px; Zoxg3: if (empty($search["\163\x63\151\145\x6e\164\151\163\164\x5f\x69\x64"])) { goto A1F50; } goto GA1Ba; cQFGU: return []; goto KHKp6; gQen2: $where["\162\x2e\155\157\144\165\154\145"] = self::MODULE; goto MJxJb; g4xdU: $where["\145\56\156\x61\x6d\145"] = ["\154\151\153\145", "\x25{$search["\x6e\141\x6d\x65"]}\45"]; goto fYqhr; GUwF5: if (empty($search["\x73\x74\145\160"])) { goto cH_C9; } goto HWX4V; MJxJb: $where["\x72\56\165\x73\145\x72\x5f\x69\x64"] = session("\165\163\145\162\x69\144"); goto dMGMq; h0kPy: $where["\x65\x2e\x73\164\x65\x70\137\163\x74\x61\164\145"] = $search["\x73\x74\x65\160\x5f\x73\164\141\x74\145"]; goto OVaWV; I5Obk: } public function getEnterprise($id) { goto foBki; h7Y1g: Lj13m: goto a_X2c; foBki: if (!empty($id)) { goto TOSYX; } goto TA3IA; ajGmT: $row["\x74\x61\147\163"] = Tag::I()->getEntityTags(Defs::ENTITY_PROJECT, $id); goto s0u5S; DbvPn: if (empty($row)) { goto Lj13m; } goto ajGmT; s0u5S: $row["\x65\170\164\x72\x61"] = Extra::I()->getValue(self::MODULE, $id); goto sr159; mT3sz: $row = Enterprises::get($id); goto DbvPn; a_X2c: return $row; goto h50xM; sr159: array_walk($row, function (&$v) { goto Vv_8g; Vv_8g: if (!($v == "\60\60\60\x30\55\x30\x30\x2d\60\60")) { goto tHGPi; } goto sb1BC; sb1BC: $v = ''; goto dATlH; dATlH: tHGPi: goto X1vum; X1vum: }); goto h7Y1g; N_3zo: TOSYX: goto mT3sz; TA3IA: return []; goto N_3zo; h50xM: } public function saveEnterprise($id, $data) { goto vjbN4; IIo5r: $data["\143\x72\x65\141\164\x65\x64\x5f\x62\x79"] = session("\x75\163\x65\x72\x69\x64"); goto KODMJ; KODMJ: $this->enterprise_model->allowField(true)->save($data); goto bEZ7P; QCj6F: m_4af: goto ZzB03; bwl3t: Extra::I()->setValue(self::MODULE, $id, $extra); goto QCj6F; hJjK5: exception("\344\274\201\xe4\270\232\xe5\220\x8d\347\247\260\344\270\x8d\350\203\275\xe4\270\272\xe7\xa9\xba"); goto q0jX9; mLaCc: $extra = $data["\145\170\x74\162\141"]; goto bRVm5; Ww9uZ: $users = $data["\x61\x73\x73\x69\x67\x6e\145\162"]; goto xB6GN; MEmZW: if (!$extra) { goto m_4af; } goto bwl3t; bRVm5: unset($data["\164\141\147\x73"], $data["\145\x78\x74\x72\141"]); goto o2iZ4; Rjitm: if (!$tags) { goto jbbaY; } goto m5vBF; tiYRS: $users .= "\x2c" . $data["\141\x64\x64\x69\164\151\x6f\156\141\154\137\x61\163\163\151\x67\156\x65\x72\x73"]; goto X7jq8; bvJq_: goto VPsNl; goto wqAdr; JUokB: if (!$data["\141\163\163\151\x67\x6e\145\162"]) { goto X6nB1; } goto Ww9uZ; X7jq8: wmCAG: goto ZggaG; UoouZ: exception("\xe5\x88\x9b\xe5\247\213\xe4\xba\272\xe4\xb8\x8d\350\203\275\xe4\270\272\347\xa9\272"); goto h10ma; qsUfD: $tags = $data["\164\x61\147\x73"]; goto mLaCc; U0yws: $log_event = false; goto IIo5r; o2iZ4: if (empty($id)) { goto IhiXS; } goto Zpqsx; ZggaG: UserRecord::I()->setRecordUsers(self::MODULE, $id, $users, $data["\141\163\163\x69\147\156\145\162"]); goto mplQT; h10ma: OeY2o: goto qsUfD; q0jX9: JrR6Q: goto KaKGA; mplQT: X6nB1: goto Rjitm; KaKGA: if (!(isset($data["\146\x6f\x75\156\144\x65\162"]) && empty($data["\146\157\165\156\144\145\162"]))) { goto OeY2o; } goto UoouZ; ZzB03: return $id; goto sTthw; VyWhl: EventLogs::recordProject($id, "\xe6\x96\260\xe5\242\236"); goto ZcFiR; wqAdr: IhiXS: goto U0yws; bEZ7P: $id = $this->enterprise_model->id; goto VyWhl; m5vBF: Tag::I()->setEntityTags($id, $tags, $log_event); goto eI3UT; eI3UT: jbbaY: goto MEmZW; vjbN4: if (!(isset($data["\x6e\x61\x6d\x65"]) && empty($data["\156\141\x6d\x65"]))) { goto JrR6Q; } goto hJjK5; xB6GN: if (!$data["\x61\x64\x64\x69\164\151\157\156\141\154\x5f\141\x73\163\x69\147\x6e\x65\x72\163"]) { goto wmCAG; } goto tiYRS; Zpqsx: $this->enterprise_model->allowField(true)->save($data, ["\151\x64" => $id]); goto bvJq_; ZcFiR: VPsNl: goto JUokB; sTthw: } public function delete($id) { $result = $this->enterprise_model->where("\151\x64", $id)->setField("\144\145\154\145\x74\145\x64", 1); return $result > 0 ? true : false; } public function goStep($id, $type) { goto sEw5Q; TvZqK: $types = ["\146\157\x72\x77\141\x72\144" => "\x2b\x31", "\x62\x61\x63\x6b\x77\141\162\x64" => "\55\x31"]; goto ZctbU; sEw5Q: $id = intval($id); goto TvZqK; ZctbU: isset($types[$type]) ?: exception("\xe6\x97\xa0\xe6\x95\x88\xe5\x8f\x82\xe6\x95\xb0"); goto eOw2H; eOw2H: $this->enterprise_model->query("\165\160\x64\x61\x74\x65\40\x65\x6e\x74\145\162\160\x72\151\163\x65\163\40\x73\x65\164\x20\x73\x74\145\160\75\163\164\145\160{$types[$type]}\x2c\163\164\x65\x70\137\x73\x74\x61\x74\x65\x3d\60\x20\167\x68\x65\162\145\x20\151\x64\x3d{$id}"); goto RfWDm; RfWDm: } public function getEnterpriseFounders($enterprise_id) { goto yq3SH; Qolfj: return $founders ? $founders : []; goto egO5W; ZdVkN: $founders = $model->alias("\x65\146")->join("\x63\157\x6e\164\141\x63\x74\x73\x20\143", "\143\56\x69\x64\x3d\x65\146\x2e\x63\157\156\x74\141\x63\164\x5f\x69\x64")->where(["\x65\x66\56\x65\x6e\x74\x65\x72\160\x72\x69\163\145\x5f\151\x64" => $enterprise_id])->order("\145\x66\56\x69\144\40\x61\163\x63")->column("\x65\x66\x2e\x2a\x2c\143\56\x6e\141\x6d\145\54\143\56\143\x6f\x6e\x74\x61\x63\164\54\x63\56\x74\x69\x74\154\x65\54\143\56\144\145\x73\143\162\151\x70\x74\x69\157\156", "\x65\x66\56\x63\157\156\164\141\x63\164\x5f\151\144"); goto Qolfj; yq3SH: $model = new EFounders(); goto ZdVkN; egO5W: } public function setEnterpriseFounders($enterprise_id, $founders_contact_id) { goto IpVWc; orwm7: $adds = []; goto EwasB; EwasB: foreach ($founders_contact_id as $contact_id) { goto csN01; csN01: if (isset($exists[$contact_id])) { goto o2vx3; } goto pV9hg; hLREM: Qi8tq: goto fMX_j; pV9hg: $adds[] = ["\x65\x6e\164\145\x72\160\x72\x69\163\145\137\151\x64" => $enterprise_id, "\143\157\x6e\x74\x61\x63\164\137\x69\144" => $contact_id]; goto BzBUd; BzBUd: o2vx3: goto hLREM; fMX_j: } goto gwb10; t9Hmg: q_LUj: goto orwm7; WwOgg: jU6XU: goto t2o5k; fmTKq: $model = new EFounders(); goto HSj1u; KLJ47: $founders_contact_id = explode("\x2c", $founders_contact_id); goto t9Hmg; gwb10: uepym: goto fmTKq; t2o5k: $exists = $this->getEnterpriseFounders($enterprise_id); goto GywJo; IpVWc: if (!(empty($enterprise_id) || empty($founders_contact_id))) { goto jU6XU; } goto bK7Cj; HSj1u: $model->saveAll($adds); goto w5fFB; GywJo: if (is_array($founders_contact_id)) { goto q_LUj; } goto KLJ47; bK7Cj: return; goto WwOgg; w5fFB: } public function addInvestFunds($enterprise_id, $investment_id, $funds) { goto HUROK; HUROK: $enterprise = $this->getEnterprise($enterprise_id); goto NLSUs; ForKo: s81C_: goto h5aUm; ry2jo: foreach ($funds as $data) { goto DE23N; DE23N: $data["\145\x6e\164\145\162\x70\x72\x69\x73\145\x5f\151\x64"] = $enterprise_id; goto JAKya; fw1Q2: Upload::I()->relateAttaches($data["\164\x72\x61\x6e\x73\x66\x65\162\137\144\x69\162\x65\143\164\151\x76\x65"], $enterprise_id, $fe->id); goto B8ESv; JAKya: $data["\151\156\x76\x65\x73\164\155\145\156\x74\137\x69\144"] = $investment_id; goto SfNtm; SfNtm: $data["\163\x74\157\x63\x6b\x5f\162\x61\x74\151\x6f\137\156\x65\x77"] = $data["\x73\164\x6f\x63\153\x5f\162\x61\x74\x69\157"]; goto EyWrQ; B8ESv: u2MpT: goto iUw81; EyWrQ: $fe = FundsEnterprises::create($data, true); goto fw1Q2; iUw81: } goto ForKo; Zc4H9: exception("\xe9\241\xb9\xe7\x9b\xae\xe9\230\xb6\346\256\265\344\270\x8d\xe7\254\246"); goto Qm7p1; NLSUs: if (!($enterprise["\x73\164\x65\160"] < 4)) { goto euUCF; } goto Zc4H9; Qm7p1: euUCF: goto ry2jo; h5aUm: } public function getInvestFunds($enterprise_id, $fund_id = 0) { goto QY5_2; QY5_2: $model = new FundsEnterprises(); goto pqosD; w6rjX: uM15g: goto CUM_3; w0ZV6: if (!$fund_id) { goto uM15g; } goto MG6zn; Q4Uy0: return $funds ? $funds : []; goto Zc0e9; CUM_3: $funds = $model->alias("\x66\145")->join("\146\x75\156\x64\x73\40\x66", "\x66\x2e\146\165\x6e\x64\137\x69\x64\75\x66\x65\56\x66\165\x6e\x64\x5f\x69\x64")->join("\146\x75\x6e\x64\x73\x5f\146\151\x6e\141\156\143\x65\x5f\145\156\x74\145\162\160\x72\x69\x73\x65\163\x20\146\x66\x65", "\146\146\145\56\x66\146\x65\x5f\x69\144\x3d\146\x65\x2e\x66\146\145\x5f\151\x64")->where($where)->order("\146\x65\56\151\x64\x20\x61\x73\143")->column("\x66\145\56\52\54\x66\x66\x65\56\141\155\x6f\165\156\x74\54\146\56\156\x61\x6d\x65\x2c\x66\x2e\x73\151\172\145", "\146\x65\56\146\165\156\144\137\151\x64"); goto Q4Uy0; MG6zn: $where["\x66\x65\56\x66\x75\156\x64\x5f\x69\x64"] = $fund_id; goto w6rjX; pqosD: $where = ["\146\145\x2e\x65\x6e\x74\145\x72\x70\x72\151\163\x65\x5f\151\x64" => $enterprise_id]; goto w0ZV6; Zc0e9: } public function getInvestEnterprise($fund_id) { goto cUvhR; fLh6t: return $enterprises; goto ntoxQ; neWkh: $enterprises = $model->alias("\x66\x65")->join("\x65\156\x74\145\162\x70\162\x69\163\145\163\x20\x65", "\x65\56\151\144\75\x66\145\x2e\x65\x6e\164\145\162\x70\162\151\x73\x65\137\151\144")->join("\x69\x6e\x76\145\x73\x74\x6d\145\156\164\x20\x69", "\151\x2e\x69\x64\x3d\x66\145\56\151\x6e\x76\145\x73\x74\155\145\156\164\x5f\151\x64")->join("\146\165\156\144\163\137\146\x69\156\x61\156\x63\145\137\x65\156\164\145\x72\x70\x72\x69\163\145\163\x20\x66\x66\x65", "\x66\x66\x65\56\146\146\x65\137\151\144\x3d\146\145\56\146\x66\145\137\151\x64\x20\x61\156\x64\x20\146\x66\x65\56\146\x75\x6e\x64\x5f\151\x64\x3d" . $fund_id)->field("\146\145\56\x2a\54\146\146\145\x2e\141\155\157\x75\x6e\x74\x2c\146\x66\145\56\x64\141\164\x65\54\145\x2e\156\x61\x6d\145\54\x65\x2e\154\x61\164\x65\163\164\137\166\141\x6c\165\141\164\x69\157\156\x2c\x69\x2e\x66\x69\156\x61\156\x63\x69\156\147\x5f\163\164\x61\x67\x65\x2c\x69\56\x69\156\x69\164\x69\141\154\x5f\x76\x61\x6c\165\141\x74\151\x6f\x6e")->where(["\x66\x65\56\x66\x75\x6e\144\137\x69\x64" => $fund_id])->order("\146\x65\56\151\x64\x20\141\163\x63")->select(); goto fLh6t; cUvhR: $model = new FundsEnterprises(); goto neWkh; ntoxQ: } public function setDividend($enterprise_id, $allocate) { goto PsN2d; OdUKr: wXLLU: goto n1bkm; PsN2d: $ffi_ids = array_column($allocate, "\x66\x66\151\x5f\151\x64"); goto HMZ3s; Cm_4C: $user_id = session("\165\163\145\162\151\x64"); goto MHRjc; MHRjc: foreach ($allocate as $fund_id => $v) { goto iPt0o; q52n9: FfnQC: goto kQDXY; xoVWv: kvE9e: goto ty604; vXHIj: $data = ["\146\x66\x69\137\151\x64" => $v["\146\146\151\x5f\x69\144"], "\144\x65\163\x63\162\x69\160\164\x69\157\156" => $v["\144\x65\x73\x63\x72\151\160\164\x69\x6f\156"]]; goto WfAbh; WfAbh: if ($v["\151\144"]) { goto FfnQC; } goto jRi5p; iPt0o: if (!empty($v["\x66\146\151\137\151\144"])) { goto vbX2q; } goto w28YH; kQDXY: $model::update($data, ["\151\x64" => $v["\x69\144"]], true); goto xoVWv; rx3jj: $model::create($data); goto V0ee9; ty604: ohZ0T: goto owJhg; SzsBj: $data["\x66\165\156\x64\137\151\144"] = $fund_id; goto c2Dv3; V0ee9: goto kvE9e; goto q52n9; KzpXv: vbX2q: goto vXHIj; c2Dv3: $data["\143\x72\x65\x61\x74\x65\144\137\x62\x79"] = $user_id; goto rx3jj; w28YH: goto ohZ0T; goto KzpXv; jRi5p: $data["\145\156\x74\145\x72\160\x72\x69\x73\x65\137\x69\x64"] = $enterprise_id; goto SzsBj; owJhg: } goto P9wOE; HMZ3s: $total_allocate = FundsFinanceIncomes::where("\146\x66\151\137\x69\x64", "\x69\x6e", $ffi_ids)->sum("\141\155\157\x75\156\164"); goto wdIOO; P9wOE: nR5UC: goto g5TPC; wdIOO: if (!(empty($total_allocate) || round($total_allocate, 2) <= 0)) { goto wXLLU; } goto cCQ3M; n1bkm: $model = new Edividends(); goto Cm_4C; cCQ3M: exception("\xe8\257\267\350\256\xbe\347\xbd\xae\345\210\206\347\272\xa2\xe9\x87\221\351\242\x9d"); goto OdUKr; g5TPC: } public function deleteDividend($exit_id) { goto At2_O; HypR7: Db::table("\x66\x75\x6e\x64\163\x5f\x66\151\156\x61\156\143\x65\x5f\x69\x6e\x63\157\x6d\145\163")->where("\145\x78\x69\164\x5f\x69\x64", $exit_id)->delete(); goto xGg4Q; QMURc: if (!$ffi_id) { goto M8vtO; } goto eEAx8; At2_O: $ffi_id = Db::table("\x66\x75\156\144\163\x5f\x66\151\x6e\x61\x6e\x63\x65\137\151\x6e\x63\x6f\155\x65\163")->where("\x65\170\x69\x74\x5f\x69\144", $exit_id)->column("\146\146\151\137\x69\x64"); goto QMURc; xGg4Q: M8vtO: goto IjfDs; eEAx8: Db::table("\x65\x6e\x74\x65\162\x70\x72\151\163\x65\163\137\144\151\166\x69\144\x65\x6e\x64\x73\137\x70\x61\x72\x74\156\x65\x72\x73")->where("\x66\146\x69\137\x69\144", "\151\156", $ffi_id)->delete(); goto o0SLA; o0SLA: Db::table("\x66\165\156\144\163\x5f\x66\x69\x6e\x61\156\143\x65\137\x74\141\x78\x65\163")->where("\146\146\151\137\151\144", "\x69\x6e", $ffi_id)->delete(); goto HypR7; IjfDs: Edividends::destroy($exit_id); goto C1gBf; C1gBf: } public function addShareholders($data, $file_id) { goto Gp4MA; vd4if: exception("\xe7\xbc\272\xe5\xb0\x91\xe5\x8f\x82\xe6\225\260"); goto uKUad; MXY_H: exception("\350\257\267\xe4\270\212\xe4\274\240\xe8\202\241\344\xb8\234\346\230\x8e\347\273\206\xe8\241\250"); goto d1986; fHJLo: if (!empty($file_id)) { goto yh_m1; } goto MXY_H; lySaJ: if (!$file_id) { goto Re7LZ; } goto SG5Lh; SG5Lh: $file = Attachments::where(["\141\x74\x74\141\143\x68\155\145\x6e\164\x5f\x69\x64" => $file_id, "\163\x74\141\x74\x75\x73" => Defs::ATTACHMENT_OK])->find(); goto Flb5C; Q5VUe: if ($id) { goto OkStJ; } goto fHJLo; M8ww8: unset($data["\151\x64"]); goto yXz4w; KA5tH: goto ift50; goto qHt8P; Gp4MA: $id = intval($data["\x69\x64"]); goto M8ww8; Flb5C: if (!$file) { goto s8Wg0; } goto pyWg0; WPF4x: return $id; goto jzpfw; WKY1v: $id = Db::table("\x65\x6e\164\145\x72\160\162\151\163\145\x5f\163\x68\x61\162\x65\x68\157\x6c\144\145\x72")->insertGetId($data); goto MFVEc; pyWg0: $this->setShareholdersFromExcel($id, $file); goto ApeOf; yXz4w: if (!empty($data["\145\151\x64"])) { goto JqUN4; } goto vd4if; qHt8P: OkStJ: goto FaILN; xZtC0: ift50: goto lySaJ; FaILN: Db::table("\x65\156\164\x65\x72\160\x72\x69\163\145\x5f\x73\x68\141\162\145\150\157\x6c\144\145\162")->where(["\x69\x64" => $id])->update($data); goto xZtC0; uKUad: JqUN4: goto Q5VUe; MFVEc: Upload::I()->relateAttaches($file_id, $id); goto KA5tH; d1986: yh_m1: goto WKY1v; ApeOf: s8Wg0: goto kAfn6; kAfn6: Re7LZ: goto WPF4x; jzpfw: } public function delShareholders($id) { goto uDwF1; aRAtX: Db::table("\x65\x6e\164\145\162\160\x72\151\163\145\x73\137\x66\151\156\x61\x6e\143\151\156\x67")->where(["\x65\163\x69\x64" => $id])->limit(1)->setField("\145\x73\x69\144", 0); goto rsIuq; uDwF1: Db::table("\x65\156\164\x65\162\x70\162\x69\x73\x65\x5f\x73\150\141\x72\145\150\x6f\x6c\144\145\162")->where(["\151\x64" => $id])->delete(); goto kLpw1; kLpw1: Db::table("\145\x6e\164\145\x72\x70\x72\151\163\145\x5f\163\x68\x61\x72\145\x68\x6f\x6c\x64\x65\162\137\144\145\164\141\x69\154")->where(["\x65\163\x69\144" => $id])->delete(); goto aRAtX; rsIuq: Upload::I()->deleteAttaches($id, 31); goto dc713; dc713: } public function updateShareholderDetail($data) { foreach ($data as $id => $row) { Db::table("\x65\x6e\164\145\x72\160\162\151\x73\145\x5f\163\x68\141\x72\145\x68\x6f\154\144\x65\x72\137\x64\145\164\x61\151\x6c")->where(["\x69\144" => $id])->update($row); jCc6R: } nJtOi: } public function setShareholdersFromExcel($esid, $file) { goto sCOS3; SIFAG: goto I_sPi; goto TqtRa; NOR6r: eR8oz: goto Hy6An; kxLXQ: $stock_ratio = round(str_replace("\45", '', $tmp[3]), 3); goto ceAUl; jkel3: $r = 2; goto BDfoJ; n3Jdb: $sheet = $excel->getSheet(0); goto UHRll; gkYPn: cS9Af: goto kJUX3; idOmX: g5UQu: goto XXVtt; BDfoJ: I_sPi: goto QWzD9; oO25H: $c = 0; goto gkYPn; bCSv6: MOJwo: goto gUstM; sCOS3: $excel = \PHPExcel_IOFactory::load(UPLOAD_DIR . DS . $file["\x73\141\x76\145\x5f\156\x61\155\x65"]); goto n3Jdb; Hy6An: $r++; goto SIFAG; jFyuk: $rows = $sheet->getHighestRow(); goto jkel3; kJUX3: if (!($c < 5)) { goto MOJwo; } goto aVv5B; aVv5B: $cell = $sheet->getCellByColumnAndRow($c, $r); goto K1XKh; eSU1p: WdvMv: goto UynPE; gUstM: if (!empty(trim($tmp[0]))) { goto ALJtd; } goto Yo2or; Yo2or: goto LRvKd; goto hF2eW; K1XKh: $tmp[] = trim($cell->getValue()); goto y60z1; kvtc0: goto cS9Af; goto bCSv6; y60z1: yC1ma: goto yumx2; QWzD9: if (!($r <= $rows)) { goto LRvKd; } goto TN5aw; UynPE: $record = ["\145\163\151\144" => $esid, "\x6e\141\155\145" => $tmp[0], "\162\145\147\137\141\x73\x73\x65\164" => empty($tmp[1]) ? null : $tmp[1], "\151\156\x76\x65\x73\x74\155\x65\156\164" => empty($tmp[2]) ? null : $tmp[2], "\x73\164\157\143\x6b\137\x72\x61\x74\x69\x6f" => $stock_ratio, "\163\164\x6f\143\x6b\x5f\x74\x6f\164\x61\154" => empty($tmp[4]) ? null : $tmp[4]]; goto wi5eO; wi5eO: $_id = Db::table("\x65\156\x74\x65\x72\160\x72\151\x73\x65\x5f\x73\x68\x61\x72\x65\150\x6f\154\x64\x65\x72\x5f\x64\x65\164\x61\x69\154")->insertGetId($record); goto NOR6r; QlGsn: if (false === strpos($tmp[3], "\45")) { goto g5UQu; } goto kxLXQ; UHRll: Db::table("\x65\x6e\x74\x65\x72\160\162\x69\x73\x65\137\163\x68\141\x72\x65\x68\157\x6c\144\x65\x72\x5f\x64\x65\164\141\x69\154")->where(["\x65\163\x69\144" => $esid])->delete(); goto jFyuk; hF2eW: ALJtd: goto QlGsn; TN5aw: $tmp = []; goto oO25H; XXVtt: $stock_ratio = round($tmp[3] * 100, 3); goto eSU1p; TqtRa: LRvKd: goto zJmwk; ceAUl: goto WdvMv; goto idOmX; yumx2: $c++; goto kvtc0; zJmwk: } public function loadDividends($fundId, $search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = "\151\x64", $order = "\x64\145\x73\143") { goto uhxTv; J9jmr: return ["\164\x6f\164\141\154" => $totalCount, "\162\157\x77\x73" => $records]; goto nVPsQ; t1CsJ: $records = Db::table("\x66\x75\156\144\163\137\x66\x69\156\141\156\x63\145\x5f\151\156\143\x6f\155\145\x73")->alias("\x66\x66\x69")->join("\145\156\164\x65\162\160\x72\151\163\145\x73\x5f\x64\x69\x76\x69\x64\145\156\x64\163\x20\104", "\146\x66\x69\56\145\x78\151\x74\x5f\x69\144\75\x44\56\151\x64")->join("\x65\x6e\x74\x65\162\x70\x72\151\163\x65\x73\x20\x45", "\104\x2e\145\156\x74\x65\x72\160\x72\151\163\145\x5f\151\x64\x3d\105\56\x69\x64")->where($conditions)->field("\104\x2e\151\x64\x2c\x44\56\164\171\160\x65\x20\x61\163\40\x65\137\164\171\160\145\54\x44\56\144\x61\x74\145\x20\x61\163\x20\x65\x5f\144\x61\x74\145\x2c\x44\x2e\x61\155\x6f\x75\x6e\164\40\x61\x73\x20\x65\137\x61\155\157\165\156\164\54\x45\56\x69\144\x20\141\163\40\145\156\x74\145\x72\x70\x72\x69\x73\x65\137\x69\144\x2c\105\x2e\x6e\x61\x6d\x65\54\x66\x66\151\56\x66\146\151\x5f\151\144\x2c\146\146\x69\x2e\141\155\x6f\x75\x6e\x74\x2c\146\146\151\x2e\144\141\164\145")->order($order)->limit($limit)->select(); goto J9jmr; IpC0B: $order = "\104\56\151\144\40\x64\145\x73\x63"; goto C4idw; m25JD: $conditions = ["\x66\146\x69\56\x66\165\x6e\144\137\x69\x64" => $fundId]; goto F5R4G; uhxTv: $limit = ($page - 1) * $rows . "\54" . $rows; goto vhcJm; vhcJm: if ($sort == "\x69\x64") { goto ti3A7; } goto IpC0B; C4idw: goto dGdat; goto O6L4l; F5R4G: $totalCount = Db::table("\x66\x75\156\x64\x73\137\x66\151\156\x61\x6e\x63\145\x5f\x69\156\x63\x6f\x6d\x65\x73")->alias("\146\x66\151")->join("\145\156\x74\x65\162\160\x72\x69\x73\x65\163\137\144\151\166\x69\144\x65\156\x64\x73\x20\104", "\146\x66\151\x2e\145\x78\x69\x74\x5f\x69\144\x3d\x44\x2e\x69\144")->join("\145\156\x74\145\x72\160\162\151\163\x65\163\40\x45", "\104\56\x65\156\x74\x65\162\x70\162\x69\x73\145\137\151\x64\75\x45\56\151\x64")->where($conditions)->count(); goto t1CsJ; W3y4O: dGdat: goto m25JD; wIf4Q: $order = "\104\x2e\151\144\40" . $order; goto W3y4O; O6L4l: ti3A7: goto wIf4Q; nVPsQ: } public function loadDividendPartners($ffiId) { goto Kp7RV; wpPNA: AD6TV: goto Raflu; Raflu: return $records; goto IA2SI; zzjXQ: foreach ($records as &$record) { $record["\x66\151\x6e\141\x6c"] = sprintf("\x25\x30\x31\56\x32\x66", $record["\141\155\157\165\156\x74"] - $record["\146\x65\145"] - $record["\164\141\x78"]); jmu6v: } goto wpPNA; Kp7RV: $records = Db::table("\x65\x6e\164\145\162\160\x72\x69\x73\x65\x73\x5f\144\151\166\x69\x64\x65\x6e\x64\163\x5f\160\x61\162\x74\156\x65\162\x73")->alias("\105\104\120")->join("\120\141\162\x74\156\x65\162\163\40\x50", "\x45\x44\x50\x2e\x70\x5f\x69\144\75\x50\56\x70\x5f\151\x64", "\x4c\x45\106\124")->where("\105\x44\x50\56\146\146\151\x5f\151\x64", $ffiId)->field("\x45\x44\120\56\x2a\54\x50\56\156\x61\155\x65\54\120\56\x74\171\x70\x65")->select(); goto zzjXQ; IA2SI: } public function loadDividendDispatchPartners($ffiId) { goto XkBqE; AU0K9: mDb_2: goto y0y7i; xAgRY: if (!empty($fundId)) { goto mDb_2; } goto unWh2; g1R9n: NCpaX: goto avaoP; u1mDf: areX9: goto daZsP; unWh2: return []; goto AU0K9; XkBqE: $fundId = Db::table("\x66\165\156\x64\x73\x5f\x66\151\156\x61\x6e\143\x65\x5f\x69\156\143\157\x6d\x65\x73")->where("\x66\x66\151\137\151\144", $ffiId)->value("\x66\165\x6e\144\x5f\x69\x64"); goto xAgRY; XZ3mR: foreach ($partners as &$partner) { goto GbYoe; XOQ94: goto eIFNt; goto PvMQv; ZE_a2: $partner["\x74\141\170"] = "\x30\56\60\x30"; goto o_51C; cZHRm: eIFNt: goto R5OPQ; cONuV: icf07: goto SygaG; SygaG: CtQvU: goto T5TPW; mzwRy: $partner["\146\x65\145"] = $existRecord["\x66\x65\x65"]; goto lRHWP; PvMQv: utyvC: goto Rscno; R5OPQ: $existRecord = Db::table("\x65\x6e\x74\145\x72\160\162\151\163\145\x73\137\x64\151\166\x69\x64\145\x6e\x64\163\137\x70\x61\x72\164\x6e\145\162\x73")->where(["\x66\146\151\x5f\151\x64" => $ffiId, "\160\x5f\x69\x64" => $partner["\x70\137\x69\x64"]])->field(true)->find(); goto F1_9f; GUPzf: $partner["\146\x65\145"] = "\x30\x2e\x30\x30"; goto ZE_a2; o_51C: goto icf07; goto qD554; F1_9f: if ($existRecord) { goto ptXVP; } goto nrJls; Rscno: $partner["\x73\150\x61\162\x65"] = round($partner["\x61\155\157\165\156\164"] / $fundSize * 100, 2) . "\x25"; goto cZHRm; nrJls: $partner["\141\155\157\165\x6e\164"] = "\60\x2e\60\60"; goto GUPzf; lRHWP: $partner["\x74\141\170"] = $existRecord["\x74\141\x78"]; goto cONuV; qD554: ptXVP: goto o8XKg; NbJQn: $partner["\163\x68\x61\x72\x65"] = ''; goto XOQ94; GbYoe: if ($fundSize) { goto utyvC; } goto NbJQn; o8XKg: $partner["\x61\x6d\157\x75\156\164"] = $existRecord["\141\155\157\165\x6e\x74"]; goto mzwRy; T5TPW: } goto u1mDf; geIGP: return []; goto g1R9n; daZsP: return $partners; goto QxJmD; y0y7i: $fundSize = Db::table("\146\x75\156\x64\163")->where("\146\165\156\x64\137\x69\144", $fundId)->value("\x73\x69\x7a\x65"); goto kNso8; avaoP: $partners = Db::table("\x66\165\x6e\x64\163\137\x70\x61\x72\164\156\x65\162\163")->alias("\x46\x50")->join("\x70\x61\162\164\x6e\x65\x72\163\x20\120", "\106\120\x2e\160\137\x69\144\75\120\56\x70\137\151\144", "\x4c\105\106\x54")->where("\106\120\x2e\146\x75\156\x64\137\x69\144", $fundId)->field("\106\120\x2e\52\54\x50\x2e\156\x61\155\145\54\x50\x2e\164\171\160\x65")->select(); goto XZ3mR; kNso8: if (!($fundSize === null)) { goto NCpaX; } goto geIGP; QxJmD: } public function saveDividendDispatchPartner($ffiId, $pId, $amount, $fee, $tax) { goto XzZUo; fjN2Z: Db::table("\145\x6e\x74\145\162\160\x72\x69\163\x65\x73\137\144\151\x76\x69\144\145\x6e\144\x73\x5f\160\x61\x72\x74\x6e\145\x72\163")->insert($datas); goto GyYlH; EKXpK: $exist = Db::table("\145\x6e\x74\145\162\160\x72\151\163\x65\163\x5f\x64\151\166\x69\x64\x65\156\x64\x73\137\x70\x61\x72\164\x6e\x65\162\163")->where(["\146\146\x69\137\151\x64" => $ffiId, "\160\x5f\151\x64" => $pId])->find(); goto yghcm; zxxdF: $datas["\146\146\151\137\x69\x64"] = $ffiId; goto XM1dp; XM1dp: $datas["\x70\137\x69\x64"] = $pId; goto fjN2Z; qiHIZ: hA7Hg: goto u6t40; fmoqs: if (!($amount !== null)) { goto D24oY; } goto X6PS3; w6hNy: jRslA: goto EKXpK; GyYlH: goto aK5RW; goto qiHIZ; u6t40: Db::table("\x65\x6e\x74\145\x72\160\162\x69\163\x65\x73\x5f\144\x69\166\x69\144\145\156\144\163\137\160\x61\162\x74\x6e\145\162\163")->where("\x69\144", $exist["\x69\x64"])->update($datas); goto uFuNg; XzZUo: $datas = []; goto fmoqs; X6PS3: $datas["\141\155\157\x75\156\x74"] = $amount; goto CifRz; JVS7z: return true; goto mr30e; X7lN1: Xw2eF: goto vxieL; bRQAU: if (!($fee !== null)) { goto Xw2eF; } goto oJTVi; CifRz: D24oY: goto bRQAU; oJTVi: $datas["\x66\145\x65"] = $fee; goto X7lN1; yghcm: if ($exist) { goto hA7Hg; } goto zxxdF; vxieL: if (!($tax !== null)) { goto jRslA; } goto k74lg; uFuNg: aK5RW: goto JVS7z; k74lg: $datas["\x74\141\170"] = $tax; goto w6hNy; mr30e: } public function setDividendDispatchDefault($ffiId) { goto fdPAu; HCSJt: Zs7dC: goto RwTwj; efBYm: return false; goto HCSJt; p5Gpn: Db::table("\x65\156\x74\x65\x72\160\162\151\163\x65\163\x5f\x64\x69\166\x69\144\x65\156\x64\163\x5f\160\x61\x72\x74\156\145\x72\x73")->insertAll($inserts); goto JV3Qg; fdPAu: $ffi = Db::table("\146\165\x6e\144\163\x5f\146\x69\156\x61\x6e\x63\145\x5f\x69\156\x63\157\x6d\x65\163")->alias("\146\146\151")->join("\x66\165\156\144\x73\40\x66", "\146\x2e\146\165\x6e\x64\x5f\151\144\x3d\x66\x66\151\x2e\146\165\156\144\137\151\144")->field("\x66\x2e\146\165\x6e\144\x5f\x69\144\x2c\146\x2e\163\151\172\145\x2c\x66\x66\151\56\x61\155\157\165\156\164")->where("\146\x66\151\56\x66\x66\x69\137\151\x64", $ffiId)->find(); goto jj1Tw; RwTwj: $partners = Db::table("\x66\165\x6e\144\x73\x5f\160\x61\x72\164\156\145\x72\163")->where("\x66\x75\156\x64\137\x69\x64", $ffi["\146\165\156\x64\x5f\151\144"])->select(); goto CeNxB; QcQsz: Db::table("\145\x6e\x74\145\162\x70\x72\151\x73\145\x73\137\144\151\166\x69\x64\x65\156\144\x73\137\x70\141\x72\164\156\145\x72\x73")->where("\146\x66\x69\x5f\151\144", $ffiId)->delete(); goto p5Gpn; JxsI5: UWNol: goto QcQsz; jj1Tw: if (!empty($ffi)) { goto Zs7dC; } goto efBYm; cFVEo: foreach ($partners as $v) { $inserts[] = ["\x66\146\151\x5f\151\144" => $ffiId, "\x70\137\x69\x64" => $v["\x70\x5f\x69\x64"], "\141\x6d\x6f\x75\x6e\164" => round($v["\141\155\x6f\x75\x6e\x74"] / $ffi["\x73\151\x7a\145"] * $ffi["\141\x6d\x6f\x75\156\164"], 2)]; uEWp3: } goto JxsI5; CeNxB: $inserts = []; goto cFVEo; JV3Qg: } public function getEnterprisePairs($id = null) { goto trlXn; trlXn: if (!$id) { goto YD60V; } goto JuB4e; u25ua: return $this->enterprise_model->column("\x6e\141\155\x65", "\x69\x64"); goto BC9qG; JuB4e: $this->enterprise_model->where("\151\144", "\151\x6e", $id); goto Jjcqp; Jjcqp: YD60V: goto u25ua; BC9qG: } public function treeIndustries() { goto HAmhN; xqsIf: foreach ($rows as $k => $v) { goto xmafX; Pr704: e3YIr: goto j11aS; m3eZ1: unset($rows[$k]); goto v8lJf; xmafX: $pid = $v["\x70\151\x64"]; goto w_H30; v8lJf: qeTJ9: goto Kpzxr; eXHs2: goto qeTJ9; goto Pr704; bQ8R0: $rows[$pid]["\x63\x68\x69\154\x64\162\x65\156"][] = $rows[$k]; goto m3eZ1; j11aS: $rows[$k]["\151\x63\x6f\156\x43\x6c\x73"] = "\146\141\x20\146\141\x2d\x74\141\x67"; goto bQ8R0; w_H30: if ($pid) { goto e3YIr; } goto kzuLy; kzuLy: $rows[$k]["\x69\143\x6f\x6e\x43\x6c\163"] = "\146\x61\40\x66\x61\x2d\x74\141\x67\x73"; goto eXHs2; Kpzxr: VUg2k: goto kzakF; kzakF: } goto ufuhF; LrwOM: if (!empty($rows)) { goto Cxtzm; } goto f_qeQ; HAmhN: $rows = Db::table("\x74\x61\147\163")->where("\x63\141\164\145\x67\157\x72\x79", Tag::TAG_INDUSTRY)->order("\x70\x69\x64\x20\x64\x65\x73\x63\54\x69\x64\x20\141\x73\x63")->column("\x69\144\54\x70\151\x64\54\156\x61\155\x65\x2c\156\141\x6d\145\40\141\x73\x20\164\145\x78\164", "\x69\x64"); goto LrwOM; teBl5: Cxtzm: goto xqsIf; A2Khd: return $rows; goto n8LNo; ufuhF: zvTvs: goto A2Khd; f_qeQ: return []; goto teBl5; n8LNo: } public function getFinancingInfo($id) { goto UkeCy; UkeCy: $data = Db::table("\x65\156\x74\x65\x72\160\162\x69\163\145\163\x5f\x66\x69\x6e\141\156\x63\151\156\147")->where(["\x69\x64" => $id])->find(); goto FGp3U; FGp3U: $data["\144\x65\x74\141\151\154"] = Extra::I()->getValue("\145\x6e\x74\145\x72\x70\x72\151\x73\145\x73\137\146\151\x6e\141\x6e\143\151\x6e\x67", $id, "\x64\x65\x74\141\x69\x6c"); goto uyrXh; uyrXh: return $data; goto sIV1j; sIV1j: } public function updateFundsStockRatio($enterprise_id) { goto GMB1z; QBCSO: if (!empty($last)) { goto yljqW; } goto RvppI; Aw3du: $ratios = Db::table("\146\x75\x6e\x64\163\x5f\x65\156\x74\x65\162\x70\162\x69\163\x65\163")->where(["\145\156\x74\145\162\160\162\151\x73\145\137\x69\144" => $enterprise_id])->column("\163\164\157\x63\153\x5f\x72\141\x74\x69\x6f\137\x6e\145\x77", "\x69\x64"); goto Js1Ez; Js1Ez: $total_ratio = array_sum($ratios); goto D560r; D560r: foreach ($ratios as $pk => $fund_ratio) { goto j0O8f; rEnyw: Db::table("\x66\x75\156\x64\x73\137\145\x6e\x74\x65\x72\160\x72\x69\x73\145\163")->where(["\x69\x64" => $pk])->setField("\163\164\157\143\x6b\x5f\162\141\164\151\x6f\137\x6e\x65\167", $ratio_new); goto bIMrn; dodfA: EZobu: goto I1Atk; j0O8f: $ratio_new = round($fund_ratio / $total_ratio * $last["\x73\x74\157\143\x6b\137\162\x61\164\151\157"], 2); goto C1s4D; C1s4D: if (!($ratio_new != $fund_ratio)) { goto kfS84; } goto rEnyw; bIMrn: kfS84: goto dodfA; I1Atk: } goto rkaKh; RvppI: Db::query("\165\160\x64\141\164\x65\x20\146\x75\156\144\163\x5f\x65\x6e\x74\x65\162\160\x72\151\x73\x65\163\x20\x73\145\164\40\x73\x74\157\143\x6b\x5f\x72\141\164\x69\x6f\137\x6e\145\x77\75\x73\164\157\143\153\x5f\162\141\164\x69\157\x20\167\150\145\x72\x65\40\145\x6e\x74\x65\x72\x70\162\151\163\145\137\x69\144\x3d{$enterprise_id}"); goto dBEWx; GMB1z: $last["\163\164\157\x63\x6b\x5f\162\141\x74\x69\x6f"] = 0; goto QBCSO; dBEWx: return; goto gn5FT; rkaKh: jNVrG: goto ntGj5; gn5FT: yljqW: goto Aw3du; ntGj5: } }
