<?php
 namespace app\index\logic; use app\index\model\Tags; use app\index\model\TagsRecords; use think\Db; class Tag extends Base { protected $model_tags; protected $model_records; const TAG_INDUSTRY = 6; const CATEGORIES = array(2 => array("\x6e\141\x6d\x65" => "\344\272\247\345\223\x81\346\x9c\x8d\345\x8a\xa1", "\145\x6e\164\151\x74\171\x5f\164\171\160\145" => Defs::ENTITY_PROJECT), 3 => array("\x6e\x61\155\145" => "\345\256\242\346\210\267\x26\xe4\270\x9a\xe5\212\241", "\x65\156\x74\151\164\171\x5f\x74\x79\x70\x65" => Defs::ENTITY_PROJECT), 4 => array("\156\x61\155\145" => "\xe4\xb8\252\xe4\xba\272\346\xa0\x87\347\xad\276", "\x65\x6e\x74\x69\x74\171\137\x74\171\160\x65" => Defs::ENTITY_TALENT), 5 => array("\x6e\141\155\145" => "\346\x8a\200\xe6\x9c\xaf", "\x65\x6e\164\151\x74\171\x5f\x74\x79\160\145" => Defs::ENTITY_PROJECT), self::TAG_INDUSTRY => array("\x6e\x61\x6d\145" => "\xe8\xa1\214\344\270\232\xe6\240\x87\xe7\255\276", "\x65\x6e\164\x69\x74\x79\137\164\171\x70\x65" => Defs::ENTITY_PROJECT)); protected function __construct() { goto HuiZ6; UmhTf: $this->model_records = new TagsRecords(); goto iLLPt; yMCy1: $this->model_tags = new Tags(); goto UmhTf; HuiZ6: parent::__construct(); goto yMCy1; iLLPt: } public function addTag($name, $category) { goto PJA7j; n4lin: $id = $tag["\151\144"]; goto JDBHs; PJA7j: $name = trim($name); goto vVipP; af5Pb: l91ZO: goto yacur; W7yT_: $tag = $this->model_tags->where(["\143\x61\x74\145\147\157\162\x79" => $category, "\x6e\141\155\145" => $name])->field("\151\x64")->limit(1)->find(); goto AS19c; Xbepo: wUNcS: goto z9cs7; Tet0F: sBymx: goto NOvVg; vVipP: if (!empty($name)) { goto l91ZO; } goto fq_8k; z9cs7: return $id; goto xw6hs; yacur: $name = htmlspecialchars($name); goto W7yT_; NOvVg: $id = $this->model_tags->insert(["\143\x61\164\x65\x67\x6f\162\171" => $category, "\156\141\x6d\x65" => $name], false, true); goto Xbepo; fq_8k: exception("\350\xaf\267\xe8\276\x93\xe5\x85\xa5\346\226\x87\xe5\xad\227"); goto af5Pb; JDBHs: goto wUNcS; goto Tet0F; AS19c: if (empty($tag)) { goto sBymx; } goto n4lin; xw6hs: } public function getTagsByCategory($category, $limit = 100) { goto sWOWU; Hkzfh: if (!empty($tags)) { goto WsOJ_; } goto kTT5v; s5CyG: return $tags; goto xR15h; kTT5v: $tags = []; goto To0Nk; sWOWU: $tags = Db::table("\x74\x61\147\163")->field("\x69\x64\40\x61\x73\40\164\x61\x67\137\151\144\54\143\x61\x74\x65\147\157\162\171\x2c\156\x61\x6d\145")->where(["\143\141\164\x65\147\157\x72\171" => $category])->order("\x69\x64\x20\141\x73\143")->limit($limit)->select(); goto Hkzfh; To0Nk: WsOJ_: goto s5CyG; xR15h: } public function setEntityTags($entity_id, $tags, $log_event = null) { goto mAFtE; GoPfx: Db::table("\x74\141\147\x73\137\162\x65\143\157\162\144\x73")->where($map)->delete(); goto kwkIZ; uWN71: ELW2d: goto jo5Jg; mAFtE: if (!empty($tags)) { goto ELW2d; } goto LEAwb; kwkIZ: if (!is_null($log_event)) { goto FehSD; } goto Cyprj; jo5Jg: $added = []; goto zOCnw; Q06YC: VYQr7: goto cBji3; ZfvO6: logEvent($entity_type, $entity_id, "\346\x96\xb0\xe5\xa2\236\xe6\240\207\xe7\xad\xbe", ["\164\141\x67\x5f\x69\144" => $added]); goto Q06YC; ZPAvb: $map["\164\141\147\x5f\x69\144"] = ["\x6e\157\164\x20\x69\x6e", $filter_ids]; goto HNRxO; M3pb3: foreach ($tags as $category => $tag_ids) { goto KIcL_; gUj_s: if (is_array($tag_ids)) { goto AnU3K; } goto XicT0; KgokP: AnU3K: goto me2ns; XicT0: $tag_ids = explode("\x2c", $tag_ids); goto KgokP; pSB_I: if (!empty($tag_ids)) { goto eRf3O; } goto jWXMv; KIcL_: $entity_type = self::CATEGORIES[$category]["\x65\x6e\x74\151\164\x79\137\164\171\x70\145"]; goto pSB_I; TbjHV: lmDg4: goto Z20cl; Z20cl: VvNqn: goto hSX4B; jWXMv: goto VvNqn; goto NQIeR; NQIeR: eRf3O: goto gUj_s; me2ns: foreach ($tag_ids as $tag_id) { goto CoaL4; pQMIQ: $added[] = $tag_id; goto cfbh9; cfbh9: Drrcb: goto EgAwW; Xys1z: if (!empty($exist)) { goto Drrcb; } goto p9hKF; EgAwW: WG0Bp: goto knCwq; CoaL4: $filter_ids[] = $tag_id; goto yQ0ji; XlE2p: $exist = Db::table("\164\141\x67\163\x5f\x72\x65\x63\x6f\x72\x64\x73")->where($map)->value("\x69\x64"); goto Xys1z; p9hKF: Db::table("\164\x61\147\x73\137\162\145\143\x6f\162\144\163")->insert($map); goto pQMIQ; yQ0ji: $map = ["\145\x6e\x74\x69\x74\x79\x5f\164\171\160\145" => $entity_type, "\x65\156\164\x69\x74\171\x5f\151\144" => $entity_id, "\164\x61\x67\137\x69\144" => $tag_id, "\143\141\164\x65\147\157\x72\171" => $category]; goto XlE2p; knCwq: } goto TbjHV; hSX4B: } goto zovwt; wmrg2: FehSD: goto wqzoq; zOCnw: $filter_ids = []; goto M3pb3; LEAwb: return; goto uWN71; zovwt: v_5Uj: goto ClBoa; wqzoq: if (!($log_event && $added)) { goto VYQr7; } goto ZfvO6; HNRxO: d6rcc: goto GoPfx; Cyprj: $log_event = true; goto wmrg2; aNn_u: if (!$filter_ids) { goto d6rcc; } goto ZPAvb; ClBoa: $map = ["\145\156\164\x69\164\x79\137\164\x79\160\145" => $entity_type, "\145\156\x74\151\x74\171\x5f\151\144" => $entity_id, "\143\x61\x74\145\x67\x6f\x72\x79" => ["\x69\156", array_keys($tags)]]; goto aNn_u; cBji3: } public function getEntityTags($entity_type, $entity_id) { goto CdLVH; nUT7q: Amu71: goto Spu0v; poJ6C: vdEqP: goto ulLTT; gdo6A: $rows = Db::table("\x74\141\x67\x73\137\162\145\x63\157\162\x64\x73")->alias("\162")->join("\x74\141\147\163\x20\x74", "\x72\56\x74\x61\147\x5f\x69\x64\x3d\x74\56\x69\144")->field("\162\x2e\164\141\x67\137\x69\144\x2c\164\x2e\156\x61\155\145\x2c\x74\56\143\141\164\x65\147\x6f\162\171")->where($map)->order("\162\56\151\x64\40\x61\163\x63")->select(); goto y1iWP; cSI0y: return []; goto poJ6C; y1iWP: if (!empty($rows)) { goto vdEqP; } goto cSI0y; CdLVH: $map = ["\x72\56\x65\156\164\151\x74\171\x5f\164\171\160\145" => $entity_type, "\x72\56\145\x6e\x74\x69\x74\x79\x5f\151\x64" => $entity_id, "\162\56\144\145\x6c\145\x74\x65\144" => 0]; goto gdo6A; qDomR: foreach ($rows as $v) { $tags[$v["\x63\x61\x74\x65\x67\157\x72\171"]][$v["\164\141\x67\x5f\151\144"]] = $v; zXq5F: } goto nUT7q; Spu0v: return $tags; goto fimEn; ulLTT: $tags = []; goto qDomR; fimEn: } public function getEntityTagsByCategory($entity_id, $category) { goto whUYH; oM9uV: return $rows; goto uJc1a; whUYH: $map = ["\x72\x2e\145\x6e\x74\x69\164\171\x5f\164\171\x70\x65" => self::CATEGORIES[$category]["\145\x6e\164\x69\x74\171\x5f\164\171\160\x65"], "\162\x2e\x65\x6e\164\151\x74\x79\137\151\x64" => $entity_id, "\x72\x2e\143\x61\x74\x65\x67\157\x72\171" => $category]; goto Rv3Q3; Rv3Q3: $rows = Db::table("\164\141\x67\x73\137\162\145\143\157\x72\144\163")->alias("\162")->join("\x74\x61\x67\x73\x20\x74", "\x72\x2e\x74\141\x67\137\151\144\x3d\x74\x2e\x69\x64")->field("\x72\x2e\x74\141\147\137\151\x64\x2c\164\x2e\x6e\141\x6d\x65\x2c\x74\x2e\x63\141\x74\145\x67\157\162\x79")->where($map)->order("\162\x2e\151\x64\x20\141\x73\143")->column("\x72\56\164\141\x67\137\x69\x64\54\x74\x2e\x6e\141\x6d\x65\54\x74\x2e\143\141\164\145\147\157\x72\x79", "\x72\x2e\x74\x61\147\x5f\x69\x64"); goto XLC2a; avd8Y: dKsu4: goto mfM38; RNsQm: JcViP: goto Rj6mE; uJc1a: goto dKsu4; goto RNsQm; Rj6mE: return []; goto avd8Y; XLC2a: if (empty($rows)) { goto JcViP; } goto oM9uV; mfM38: } public function getTagsBatch($category, $entity_id) { goto Z570w; zECQ4: Rt606: goto IrpGK; XhlQK: return []; goto zECQ4; RP0Ow: if (!empty($rows)) { goto Rt606; } goto XhlQK; kbXXw: p6wvP: goto EAb_Q; IrpGK: $tags = []; goto csLj5; ZxhO7: $rows = $this->model_records->alias("\x72")->join("\x74\141\x67\x73\x20\164", "\x72\56\164\141\x67\137\151\144\75\x74\56\151\x64")->field("\162\56\x74\141\147\137\151\x64\x2c\x72\56\145\x6e\164\151\164\x79\137\x69\x64\x2c\x74\56\156\141\x6d\145\54\x74\x2e\143\x61\164\145\147\x6f\x72\x79")->where($map)->order("\x72\x2e\x69\144\40\x61\163\143")->select(); goto RP0Ow; Z570w: $map = ["\x72\56\145\x6e\x74\x69\x74\x79\x5f\x74\171\x70\145" => self::CATEGORIES[$category]["\x65\156\x74\x69\164\x79\137\x74\x79\x70\x65"], "\x72\x2e\145\156\164\x69\x74\x79\137\151\x64" => ["\151\x6e", $entity_id], "\x74\x2e\x63\141\164\x65\x67\157\162\171" => $category]; goto ZxhO7; EAb_Q: return $tags; goto IG6Dh; csLj5: foreach ($rows as $v) { $tags[$v["\x65\156\164\x69\164\171\137\151\144"]][] = $v; XpKSX: } goto kbXXw; IG6Dh: } }
