<?php
 namespace app\index\logic; use app\index\model\Setting; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; class Messages extends Base { const MESSAGE_APPROVAL_CATEGORY = 1; public static $messageCategoryDefs = array(self::MESSAGE_APPROVAL_CATEGORY => "\345\256\xa1\346\211\271\351\200\x9a\xe7\237\xa5"); public static $messageCategoryHtmlDefs = array(self::MESSAGE_APPROVAL_CATEGORY => "\x3c\163\x70\x61\x6e\40\143\154\x61\163\163\x3d\x22\x62\x61\x64\147\145\40\x62\141\144\147\x65\x2d\160\x72\151\155\141\x72\x79\42\x3e\xe5\xae\xa1\xe6\211\xb9\351\x80\x9a\347\237\xa5\x3c\57\x73\x70\141\x6e\76"); protected function __construct() { parent::__construct(); } public function load($adminId, $search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = "\x6d\x65\163\163\x61\x67\145\x5f\151\144", $order = "\144\145\163\x63") { goto NhNNN; m6OwE: clBWw: goto Gr0OO; KoNe9: $totalCount = Db::table("\155\x65\x73\x73\x61\x67\145\163")->where($conditions)->count(); goto EObZc; RUXh1: $order = "\x6d\x65\163\x73\x61\x67\x65\137\x69\144\40\144\x65\163\143"; goto BeuhI; NhNNN: $limit = ($page - 1) * $rows . "\x2c" . $rows; goto iwns8; B0idu: foreach ($records as &$record) { $record["\143\x68\x65\x63\x6b\145\x64"] = true; yHUNg: } goto m6OwE; ooihF: $order = "\155\x65\163\163\141\x67\x65\x5f\151\x64\40" . $order; goto cPVm4; cPVm4: osOzA: goto zS5CY; BeuhI: goto osOzA; goto E0XlM; Gr0OO: return ["\164\x6f\164\x61\x6c" => $totalCount, "\162\x6f\167\163" => $records]; goto yBecQ; EObZc: $records = Db::table("\155\145\x73\x73\x61\147\x65\x73")->where($conditions)->limit($limit)->order($order)->field(["\155\145\163\x73\x61\147\x65\x5f\x69\x64", "\141\144\155\x69\156\137\x69\144", "\164\x69\164\154\x65", "\x63\x6f\156\x74\x65\x6e\164", "\x63\x61\x74\x65\147\x6f\162\171", "\x69\163\x5f\x72\145\x61\x64", "\x72\145\x61\x64\137\x74\151\155\x65", "\145\156\x74\145\162\x65\x64"])->select(); goto B0idu; E0XlM: faZUu: goto ooihF; iwns8: if ($sort == "\x6d\x65\163\163\x61\x67\x65\x5f\x69\x64") { goto faZUu; } goto RUXh1; zS5CY: $conditions = ["\x61\144\x6d\151\x6e\x5f\151\144" => $adminId]; goto KoNe9; yBecQ: } public function add($adminId, $category, $title, $content) { goto U26Yx; oQXID: return $messageId; goto ssmfc; LRzoX: $messageId = Db::table("\155\x65\x73\163\141\147\x65\163")->insertGetId($datas); goto oQXID; U26Yx: $datas = ["\141\x64\x6d\151\x6e\x5f\151\144" => $adminId, "\164\151\x74\x6c\145" => $title, "\x63\x6f\x6e\x74\145\156\164" => $content, "\x63\141\x74\x65\x67\157\x72\171" => $category]; goto LRzoX; ssmfc: } public function markRead($messageId) { Db::table("\155\x65\163\x73\x61\147\145\x73")->where(["\x6d\x65\163\x73\x61\x67\x65\x5f\151\x64" => $messageId, "\x69\x73\137\162\x65\141\144" => 0])->update(["\151\163\x5f\162\x65\141\x64" => 1, "\162\145\x61\x64\137\x74\x69\155\145" => date("\x59\x2d\155\55\144\40\x48\x3a\151\72\x73")]); return true; } public function markAllRead($adminId) { Db::table("\x6d\x65\x73\163\x61\147\x65\163")->where(["\x61\x64\x6d\x69\156\137\151\144" => $adminId, "\x69\163\137\162\145\x61\x64" => 0])->update(["\x69\163\137\x72\145\141\144" => 1, "\162\145\141\x64\x5f\x74\x69\155\145" => Db::raw("\x6e\x6f\167\50\51")]); } public function markSelectedRead($messageIds) { Db::table("\155\145\x73\x73\x61\147\145\163")->where(["\x6d\x65\x73\163\141\147\x65\137\151\x64" => ["\151\x6e", $messageIds], "\x69\163\x5f\162\145\141\x64" => 0])->update(["\x69\163\x5f\x72\x65\x61\x64" => 1, "\162\x65\x61\144\x5f\164\151\155\145" => Db::raw("\x6e\x6f\167\50\x29")]); } public function getInfos($messageId) { $infos = Db::table("\155\145\x73\163\x61\x67\x65\163")->where("\x6d\145\x73\x73\141\147\145\137\151\144", $messageId)->field(true)->find(); return $infos; } public function unreadCount($adminId) { $count = Db::table("\x6d\x65\163\x73\x61\x67\x65\163")->where(["\x61\144\155\x69\x6e\x5f\x69\x64" => $adminId, "\x69\x73\x5f\x72\x65\141\x64" => 0])->count(); return $count; } }
